<div class="header">
    <img src="assets/common/icons/stripe.svg" />
    <mat-slide-toggle
        class="header-toggle"
        [(ngModel)]="stripePaymentSettings.isEnabled"
        labelPosition="before"
    >
        {{ l('Enable Stripe Payments For Checkout') }}
    </mat-slide-toggle>
</div>

<mat-tab-group 
    *ngIf="stripePaymentSettings"
    animationDuration="10ms" 
    disableRipple="true" 
    class="main-tabs"
>
    <mat-tab>
        <ng-template mat-tab-label>
            <lucide-angular [img]="HouseIcon"></lucide-angular>
            <span>{{l('Stripe Introduction')}}</span>
        </ng-template>

        <div class="introduction-tab">
            <div class="left-side">
                <div class="payment-header">
                    <h2>Take Online Payments</h2>
                    <p>Connect with the world’s most powerful and easy to use Payment Gateway</p>
                </div>

                <div class="content-wrapper">
                    <div class="content-info">
                        <div class="info-img">
                            <img src="./assets/common/images/workingman.jpg">
                        </div>
                        <h3>Now your customers can pay by card</h3>
                        <ul>
                            <li>
                                <div>•</div>
                                <span class="title">Take instant online card payments</span>
                            </li>
                            <li>
                                <div>•</div>
                                <span class="title">Get your money quickly and securely</span>
                            </li>
                            <li>
                                <div>•</div>
                                <span class="title">Choose which invoices can be paid this way</span>
                            </li>
                        </ul>
                        <a class="base-link-button" target="_blank" href="https://stripe.com/resources/more/card-payments">
                            Learn more about how card payments work
                            <lucide-angular [img]="ExternalIcon"></lucide-angular>
                        </a>
                    </div>
                    
                    <div class="content-invoice">
                        <h3>Connect to Stripe for super-easy card payments</h3>
                        <p>Only pay a small percentage of your invoice total:</p>
                        
                        <ul>
                            <li>
                                <span class="check">✓</span>
                                <span class="title">Accept all Major Credit Cards</span>
                            </li>
                            <li>
                                <span class="check">✓</span>
                                <span class="title">Flexible subsrcriptions and billing terms</span>
                            </li>
                            <li>
                                <span class="check">✓</span>
                                <span class="title">Accept SEPA</span>
                            </li>
                            <li>
                                <span class="check">✓</span>
                                <span class="title">Accept Apple Pay</span>
                            </li>
                            <li>
                                <span class="check">✓</span>
                                <span class="title">Accept iDeal</span>
                            </li>
                            <li>
                                <span class="check">✓</span>
                                <span class="title">Fraud prevention tools</span>
                            </li>
                        </ul>

                        <button *ngIf="stripePaymentSettings.isHostAccountEnabled" class="base-button" (click)="createConnectedAccount()">
                            {{ l('Connect to Stripe') }}
                        </button>
                    </div>
                </div>
            </div>
            <div class="faq-side">
                <div class="faq-block-title">FAQ</div>
                <cdk-accordion [multi]="true">
                    <cdk-accordion-item
                        *ngFor="let item of faqs; let index = index;"
                        #accordionItem="cdkAccordionItem"
                        class="accordion-item"
                        role="button"
                        tabindex="0"
                        [attr.id]="'accordion-header-' + index"
                        [attr.aria-expanded]="accordionItem.expanded"
                        [attr.aria-controls]="'accordion-body-' + index"
                    >
                        <div class="accordion-item-header" (click)="accordionItem.toggle()">
                            <span *ngIf="item.content">{{ item.title }}</span>
                            <a *ngIf="item.link" [href]="item.link" target="_blank">{{ item.title }}</a>
                            <lucide-angular [img]="ChevronIcon" *ngIf="item.content"></lucide-angular>
                        </div>
                        <div
                            *ngIf="item.content"
                            class="accordion-item-body"
                            role="region"
                            [style.display]="accordionItem.expanded ? '' : 'none'"
                            [attr.id]="'accordion-body-' + index"
                            [attr.aria-labelledby]="'accordion-header-' + index"
                        >
                            {{ item.content }}
                        </div>
                    </cdk-accordion-item>
                </cdk-accordion>
            </div>
        </div>        
    </mat-tab>
    <mat-tab *ngIf="!isHost">
        <ng-template mat-tab-label>
            <lucide-angular [img]="PeopleIcon"></lucide-angular>
            <span>{{l('Connected Accounts')}}</span>
        </ng-template>
        <div class="connected-tab blocks-tab">
            <div *ngFor="let settings of connectedSettings" class="connected-account block" [class.active]="settings.isActive">
                <div class="section top-bar">
                    <i class="fa check-icon" [ngClass]="settings.isActive ? 'fa-check-circle' : 'fa-circle-thin'"></i>
                    <inplace-edit [id]="settings.id"
                                  [value]="settings.displayName"
                                  [maxLength]="256"
                                  [validationRules]="[ { type: 'required', message: l('ThisFieldIsRequired') } ]"
                                  lEntityName="DisplayName"
                                  [editPlaceholder]="l('DisplayName')"
                                  (valueChanged)="settings.displayName = $event">
                    </inplace-edit>
                </div>
                <div class="section account-info">
                    <div class="stripe-button-container">
                        <button [disabled]="!stripePaymentSettings.isHostAccountEnabled" class="btn btn-layout stripe-button" (click)="createConnectedAccount(settings)">
                            {{ settings.isConnectedAccountSetUpCompleted ? l('Connected with') : settings.connectedAccountId ? l('Finish onboarding with') : l('Connect with') }}
                            <img src="./assets/common/images/stripe.svg" />
                        </button>
                    </div>
                    <div class="account-details">
                        <h6>{{l("Connected account info")}}:</h6>
                        <div class="clipboard-holder"><span>Account Id: </span><b>{{settings.connectedAccountId}}</b><i class="copy save-to-clipboard" aria-hidden="true" (click)="copyToClipboard(settings.connectedAccountId)"></i></div>
                        <div class="clipboard-holder"><span>Account Type: </span><b>{{settings.connectedAccountType}}</b><i class="copy save-to-clipboard" (click)="copyToClipboard(settings.connectedAccountType)"></i></div>
                        <div class="clipboard-holder"><span>Account Name: </span><b>{{settings.connectedAccountName}}</b><i class="copy save-to-clipboard" (click)="copyToClipboard(settings.connectedAccountName)"></i></div>
                        <div class="clipboard-holder"><span>Account Email: </span><b>{{settings.connectedAccountEmail}}</b><i class="copy save-to-clipboard" (click)="copyToClipboard(settings.connectedAccountEmail)"></i></div>
                        <div class="payment-methods" *ngIf="settings.isConnectedAccountSetUpCompleted">
                            <span>Available Payment Methods: </span><b>{{settings.availablePaymentMethods}}</b>
                            <i class="fa fa-refresh" [ngClass]="{'fa-spin': settings.paymentMethodUpdateInProgress}" (click)="updatePaymentMethods(settings)" title="Refresh payment methods"></i>
                        </div>
                    </div>
                    <h6 class="tax-settings">Tax Settings</h6>
                    <button class="btn btn-layout" (click)="enableAutomaticTaxation(settings)">
                        {{(settings.isTaxationEnabled ? 'Disable ' : 'Enable ') + l('Automatic Taxation')}}
                    </button>
                    <ng-container *ngIf="settings.isTaxationEnabled"><img src="./assets/common/icons/check-green.svg" /> Enabled </ng-container>
                    <hr />
                    <dx-check-box [text]="l('Ignore external webhooks')"
                                  [(value)]="settings.ignoreExternalWebhooks">
                    </dx-check-box>
                    <p>
                        <span class="small">*Skip webhooks that are not intended for <b>{{tenantName}}</b></span>
                    </p>
                </div>
                <div class="account-actions">
                    <span *ngIf="!settings.isActive" (click)="setIsActive(settings)"><i class="fa fa-check"></i>Set as active</span>
                    <span (click)="delete(settings)"><i class="fa fa-trash-o"></i>Delete Connection</span>
                </div>
            </div>
        </div>
    </mat-tab>
    <mat-tab>
        <ng-template mat-tab-label>
            <lucide-angular [img]="BlocksIcon"></lucide-angular>
            <span>{{l('Api Keys')}}</span>
        </ng-template>
        <div class="api-keys-tab blocks-tab">
            <button *ngIf="apiKeySettings && !apiKeySettings.length" class="base-button" (click)="addApiKeySettings()">
                {{ l('Add new API settings') }}
            </button>
            <div *ngFor="let settings of apiKeySettings" class="api-key-account block" [class.active]="settings.isActive">
                <div class="section top-bar">
                    <i class="fa check-icon" [ngClass]="settings.isActive ? 'fa-check-circle' : 'fa-circle-thin'"></i>
                    <inplace-edit [id]="settings.id"
                                  [value]="settings.displayName"
                                  [maxLength]="256"
                                  [validationRules]="[ { type: 'required', message: l('ThisFieldIsRequired') } ]"
                                  showInlineEditButton="true"
                                  lEntityName="DisplayName"
                                  [editPlaceholder]="l('DisplayName')"
                                  (valueChanged)="settings.displayName = $event">
                    </inplace-edit>
                </div>
                <div class="api-key-info" [class.section]="!isHost">
                    <div class="form-group">
                        <label class="base-label">{{l("Secret key")}}</label>
                        <input class="base-input" placeholder="Enter Your Secret Key" [disabled]="settings.id" type="text" [(ngModel)]="settings.apiKey">
                    </div>

                    <div class="form-group">
                        <label class="base-label">{{l("Publishable key")}}</label>
                        <input class="base-input"  placeholder="Enter Your Secret Key" type="text" [(ngModel)]="settings.publishableKey">
                        <span class="base-hint" [innerHtml]="l('StripeSecretKeyHint')"></span>
                    </div>

                    <dx-check-box id="StripeIgnoreExternalWebhooks"
                                    [text]="l('Ignore external webhooks')"
                                    [(value)]="settings.ignoreExternalWebhooks">
                    </dx-check-box>
                    <span class="base-hint">*Skip webhooks that are not intended for <b>{{tenantName}}</b></span>
                    
                    <br /><br />
                    <div>Use button below to create <b>Account</b> webhook and recieve Account events from Stripe</div>
                    <button [disabled]="settings.webhookSingingSecret" [title]="settings.webhookSingingSecret || ''" class="base-button" (click)="createWebhook(settings, false)">
                        {{ settings.webhookSingingSecret ? 'Account Webhook is created' : 'Create Account webhook' }}
                    </button>
                    <img *ngIf="settings.webhookSingingSecret" src="./assets/common/icons/check-green.svg" />
                    
                    <div *ngIf="isHost" class="section">
                        <div class="form-group">
                            <label class="base-label">{{l("OAuth Client Id")}}</label>
                            <input class="base-input" type="text" [(ngModel)]="settings.oAuthClientId">
                        </div>

                        <span class="base-hint">{{l('Connects a tenant\'s Stripe account. The value can be found in the ')}}<a href="https://dashboard.stripe.com/settings/connect" target="_blank">settings</a>.</span><br />
                        <span class="base-hint">{{l('Please enable ')}}<b>OAuth for Standard accounts</b>{{l(' and add the following URL to OAuth redirects')}}</span>
                        <span class="base-hint">URL - <span class="copy-url"><b>{{getStripeOAuthConnectRedirectUrl()}}</b><i class="copy save-to-clipboard" (click)="copyToClipboard($event)"></i></span></span>
                    </div>

                    <br /><br />
                    <div>Use button below to create <b>Connect</b> webhook and recieve Connect events from Stripe</div>
                    <button [disabled]="settings.connectWebhookSingingSecret" [title]="settings.connectWebhookSingingSecret || ''" class="base-button" (click)="createWebhook(settings, true)">
                        {{ settings.connectWebhookSingingSecret ? 'Connect webhook is created' : 'Create Connect webhook' }}
                    </button>
                    <img *ngIf="settings.connectWebhookSingingSecret" src="./assets/common/icons/check-green.svg" />
                    
                    <h6 class="tax-settings">Tax Settings</h6>
                    <button class="base-button" (click)="enableAutomaticTaxation(settings)">
                        {{(settings.isTaxationEnabled ? 'Disable ' : 'Enable ') + l('Automatic Taxation')}}
                    </button>

                    <ng-container *ngIf="settings.isTaxationEnabled"><img src="./assets/common/icons/check-green.svg" /> Enabled </ng-container>
                    <br /><br />

                    <dx-check-box id="StripeIgnoreExternalConnectedAccounts"
                                    [text]="l('Ignore external connected accounts')"
                                    [(value)]="settings.ignoreExternalConnectedAccounts">
                    </dx-check-box>
                    <span class="base-hint">*Skip webhooks from external connected accounts</span>
                </div>
                <div *ngIf="!isHost" class="account-actions">
                    <span *ngIf="!settings.isActive" (click)="setIsActive(settings)"><i class="fa fa-check"></i>Set as active</span>
                    <span (click)="delete(settings)"><i class="fa fa-trash-o"></i>Delete Connection</span>
                </div>
            </div>
        </div>
    </mat-tab>
    <mat-tab>
        <ng-template mat-tab-label>
            <lucide-angular [img]="MaximizeIcon"></lucide-angular>
            <span>{{l('Import Your Data')}}</span>
        </ng-template>
        <div class="import-tab">
            <h5>{{l("Account")}}:</h5>
            <dx-select-box #selectBox
                           [dataSource]="stripePaymentSettings.stripeAccountSettings"
                           displayExpr="displayName">
            </dx-select-box>
            <div *ngIf="selectBox.selectedItem as settingData">
                <div class="import-block" *ngIf="settingData.showImportSection">
                    <h5>{{l("Import")}}:</h5>
                    <div class="dx-fieldset">
                        <ng-container *ngFor="let importType of importTypes">
                            <div class="dx-field" *ngIf="showImportType(settingData, importType)">
                                <div class="dx-field-label">{{l(StripeImportType[importType])}}</div>
                                <dx-check-box class="dx-field-value"
                                              [value]="getImportTypeValue(settingData, importType)"
                                              [disabled]="settingData.hasRunningImport || getImportTypeDisabled(settingData, importType)"
                                              (onValueChanged)="onImportTypeChanged($event, settingData, importType)">
                                </dx-check-box>
                            </div>
                        </ng-container>
                    </div>
                    <button class="btn btn-layout" (click)="import(settingData)" [disabled]="settingData.selectedImportType == 0 || settingData.hasRunningImport">
                        <i class="icon-la la la-download"></i>
                        {{l('Import')}}
                        <i *ngIf="settingData.hasRunningImport" class="fa fa-spinner fa-spin"></i>
                    </button>
                </div>
            </div>
        </div>
    </mat-tab>
</mat-tab-group>