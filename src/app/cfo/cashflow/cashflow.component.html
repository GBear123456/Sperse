<app-headline *ngIf="!isFullscreenMode"
              [names]="[ l('Cashflow_mainTitle') ]"
              iconSrc="assets/common/icons/chart-icon.svg"
              [reloadIsNecessary]="noRefreshedAfterSync"
              [showReloadButton]="true"
              [showToggleToolbarButton]="true"
              (onReload)="reload()"
              (onToggleToolbar)="toggleToolbar()">
    <business-entities-chooser (onChanged)="refreshDataGrid()"
                               (onFilterButtonClick)="openBankAccountsSelectDialog()">
    </business-entities-chooser>
    <synch-progress class="synch-progress" (onComplete)="showRefreshButton()"></synch-progress>
    <calendar-button [emptyEndDateIsAvailable]="true"></calendar-button>
</app-headline>
<app-toolbar [config]="toolbarConfig"></app-toolbar>

<div class="cashflow" *ngIf="cashflowService.cashflowData && cashflowService.cashflowData.length">
    <div class="sort-options" [hidden]="!contentReady">
        <app-toolbar [config]="categoryToolbarConfig" [compact]="true"></app-toolbar>
    </div>

    <dx-resizable *ngIf="statsDetailResult !== undefined" class="cashflow-wrap"
                  [maxHeight]="788"
                  (onResize)="onTransactionDetailsResize()"
                  (onResizeEnd)="onTransactionDetailsResizeEnd($event)"
                  handles="top">
        <div class="resize-buttons noselect">....</div>
        <div class="configBlock">
            <dx-tabs *ngIf="detailsContainsForecasts && detailsContainsHistorical"
                     [dataSource]="detailsTabs"
                     [width]="300"
                     [selectedItem]="selectedDetailsTab$ | async"
                     [scrollByContent]="true"
                     [showNavButtons]="true"
                     (onSelectionChanged)="changeDetailsTab($event)">
            </dx-tabs>
            <div class="detailsButtons">
                <dx-button *ngIf="!hasStaticInstance" [text]="'+ ' + l('AddForecastTransaction')" (onClick)="addNewForecast()" [disabled]="!isInstanceAdmin || disableAddForecastButton"></dx-button>
                <dx-button *ngIf="detailsContainsForecasts" [disabled]="!isInstanceAdmin || !detailsSomeForecastsItemsSelected" [text]="'x ' + l('DeleteSelectedForecasts')" (onClick)="deleteSelectedForecasts()"></dx-button>
                <dx-button *ngIf="searchValue?.length" class="search-value-btn" [text]="searchValue" [visible]="!cashflowService.showAllVisible" (onClick)="refreshTransactionDetail(false)"></dx-button>
                <dx-button class="showall-btn" [text]="l('Show all')" [visible]="cashflowService.showAllVisible" (onClick)="refreshTransactionDetail(true)" [disabled]="cashflowService.showAllDisable"></dx-button>
                <dx-button *ngIf="!hasStaticInstance" class="reclassify-btn" [text]="l('Reclassify')" [disabled]="!_cfoService.classifyTransactionsAllowed() || !detailsSomeHistoricalItemsSelected" (onClick)="reclassifyTransactions()"></dx-button>
            </div>
        </div>

        <dx-button icon="close" (onClick)="closeTransactionsDetail()" class="close-btn {{hasStaticInstance ? 'close-btn-portal' : ''}}"></dx-button>

        <dx-data-grid id="cashflowGridContainer"
                      [rowAlternationEnabled]="true"
                      [allowColumnResizing]="true"
                      [dataSource]="displayedStatsDetails"
                      (onDataErrorOccurred)="httpInterceptor.handleError($event.error)"
                      (onCellPrepared)="onDetailsCellPrepared($event)"
                      (onCellClick)="onDetailsCellClick($event)"
                      (onEditingStart)="onDetailsEditingStart($event)"
                      (onEditorPreparing)="onEditorPreparing($event)"
                      (onRowPrepared)="onDetailsRowPrepared($event)"
                      (onContentReady)="onTransactionDetailContentReady($event)"
                      (onInitNewRow)="onInitNewRow($event)"
                      (onRowInserting)="onRowInserting($event)"
                      (onRowUpdating)="onDetailsRowUpdating($event)"
                      (onSelectionChanged)="onDetailsSelectionChanged($event)">
            <dxo-editing mode="cell"
                         [allowUpdating]="isInstanceAdmin"
                         texts="{'confirmDeleteMessage': ''}">
            </dxo-editing>

            <dxo-header-filter [visible]="true"></dxo-header-filter>
            <dxo-selection selectAllMode="page"
                           [showCheckBoxesMode]="'always'"
                           mode="multiple">
            </dxo-selection>
            <dxo-state-storing [enabled]="true" type="localStorage" [storageKey]="detailsSettingsIdentifier"></dxo-state-storing>
            <dxi-column *ngIf="!hasStaticInstance" dataField="forecastDate"
                        dataType="date"
                        [cssClass]="'forecastDate ' + tabularFontName"
                        cellTemplate="dateCell"
                        headerCellTemplate="twoRowsHeaderCellTemplate"
                        alignment="left"
                        [allowEditing]="false"
                        [minWidth]="30"
                        [caption]="l('DetailsHeaders_ForecastDate')">
                <dxi-validation-rule type="custom" [message]="l('ForecastDateUpdating_validation_message')" [validationCallback]="validateForecastDate"></dxi-validation-rule>
            </dxi-column>
            <dxi-column dataField="date"
                        dataType="date"
                        [cssClass]="tabularFontName"
                        cellTemplate="dateCell"
                        headerCellTemplate="twoRowsHeaderCellTemplate"
                        alignment="left"
                        [caption]="l('DetailsHeaders_ActualDate')"
                        [minWidth]="30"
                        [allowEditing]="false">
            </dxi-column>
            <dxi-column *ngIf="hasStaticInstance"
                        dataField="businessEntityName"
                        dataType="string"
                        alignment="left"
                        [minWidth]="30"
                        [allowFiltering]="false"
                        caption="{{l('BusinessEntities')}}"
                        [cssClass]="tabularFontName + ' clipboard-holder'">
            </dxi-column>
            <dxi-column *ngIf="hasStaticInstance"
                        dataField="categoryName"
                        dataType="string"
                        alignment="left"
                        [minWidth]="30"
                        [allowFiltering]="false"
                        cellTemplate="CategoryNameTemplate"
                        caption="{{l('Transactions_CashflowCategoryName')}}"
                        cssClass="category">
            </dxi-column>
            <dxi-column *ngIf="hasStaticInstance"
                        dataField="counterpartyName"
                        dataType="string"
                        alignment="left"
                        [minWidth]="30"
                        [allowFiltering]="false"
                        cssClass="clipboard-holder"
                        caption="{{l('Transactions_Vendor')}}">
            </dxi-column>
            <dxi-column *ngIf="!hasStaticInstance"
                        dataField="status"
                        headerCellTemplate="twoRowsHeaderCellTemplate"
                        alignment="left"
                        [caption]="l('DetailsHeaders_CurrentStatus')"
                        [minWidth]="30"
                        [allowEditing]="false">
            </dxi-column>
            <dxi-column *ngIf="!hasStaticInstance"
                        dataField="descriptor"
                        cellTemplate="descriptorCell"
                        [width]="detailsDescriptorColumnWidth()"
                        [allowEditing]="false"
                        [minWidth]="30"
                        [caption]="l('DetailsHeaders_Descriptor')">
                <dxo-header-filter [visible]="true"></dxo-header-filter>
            </dxi-column>
            <dxi-column *ngIf="!hasStaticInstance"
                        dataField="debit"
                        [caption]="l('DetailsHeaders_Debit')"
                        [format]="customCurrency"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [cssClass]="tabularFontName + ' clipboard-holder'"
                        [allowEditing]="false"
                        alignment="right"
                        [minWidth]="30">
                <dxi-validation-rule type="numeric"></dxi-validation-rule>
            </dxi-column>
            <dxi-column *ngIf="!hasStaticInstance"
                        dataField="credit"
                        [caption]="l('DetailsHeaders_Credit')"
                        [format]="customCurrency"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [cssClass]="tabularFontName + ' clipboard-holder'"
                        [allowEditing]="false"
                        [minWidth]="30"
                        alignment="right">
                <dxi-validation-rule type="numeric"></dxi-validation-rule>
            </dxi-column>
            <dxi-column *ngIf="!hasStaticInstance"
                        [caption]="l('DetailsHeaders_Account')"
                        dataField="accountNumber"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [cssClass]="tabularFontName + ' clipboard-holder'"
                        [allowEditing]="false"
                        [minWidth]="30"
                        editCellTemplate="accountsEditSelect">
            </dxi-column>
            <dxi-column *ngIf="!hasStaticInstance"
                        dataField="accountId"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [cssClass]="tabularFontName + ' clipboard-holder'"
                        [allowEditing]="false"
                        [minWidth]="30"
                        [visible]="false">
            </dxi-column>
            <dxi-column *ngIf="!hasStaticInstance"
                        [caption]="l('DetailsHeaders_Type')"
                        dataField="cashflowTypeId"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [allowEditing]="false"
                        [minWidth]="30"
                        cellTemplate="typeCell">
            </dxi-column>
            <dxi-column [caption]="l('DetailsHeaders_Description')"
                        dataField="description"
                        cellTemplate="descriptionTemplate"
                        [width]="detailsDescriptionColumnWidth()"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [minWidth]="30"
                        [allowEditing]="false">
                <dxo-header-filter [visible]="true"></dxo-header-filter>
            </dxi-column>
            <dxi-column *ngIf="hasStaticInstance"
                        dataField="amount"
                        alignment="left"
                        [minWidth]="30"
                        [allowFiltering]="false"
                        cellTemplate="amountTemplate"
                        caption="{{l('Transactions_Amount')}}"
                        cssClass="tabular">
            </dxi-column>
            <dxi-column *ngIf="hasStaticInstance"
                        dataField="accountName"
                        alignment="left"
                        [minWidth]="30"
                        [allowFiltering]="false"
                        caption="{{l('Transactions_BankAccountNumber')}}"
                        cssClass="tabular clipboard-holder">
            </dxi-column>
            <dxi-column *ngIf="hasStaticInstance"
                        dataField="Comment"
                        dataType="string"
                        alignment="left"
                        [minWidth]="30"
                        [allowFiltering]="false"
                        cssClass="clipboard-holder"
                        caption="{{l('Transactions_Comments')}}">
            </dxi-column>

            <dxo-load-panel [enabled]="false"></dxo-load-panel>
            <dxo-scrolling mode="virtual"></dxo-scrolling>

            <div *dxTemplate="let cellData of 'dateCell'" class="clipboard-holder">{{cellData.value | date: 'MM/dd/yyyy'}}</div>
            <div *dxTemplate="let cellData of 'typeCell'">{{cashflowService.cashflowTypes[cellData.value]}}</div>
            <div *dxTemplate="let cellData of 'descriptionTemplate'">
                <span id="transactionDetailTarget-{{cellData.data.id}}" class="clipboard-holder">{{cellData.text}}</span>
            </div>
            <div *dxTemplate="let cellData of 'descriptorCell'" [class.calculated]="cellData.data.date && cellData.data.isDescriptorCalculated" class="clipboard-holder">{{cellData.value}}</div>
            <div *dxTemplate="let cell of 'accountsEditSelect'">
                <dx-select-box [items]="activeBankAccounts"
                               [displayExpr]="getBankAccountName"
                               valueExpr="id"
                               [value]="getBankAccountId(cell)"
                               (onValueChanged)="accountChanged($event, cell)">
                </dx-select-box>
            </div>
            <div *dxTemplate="let headerCellData of 'twoRowsHeaderCellTemplate'">
                <div class="firstLine">{{headerCellData.column.caption.slice(0, headerCellData.column.caption.indexOf(' '))}}</div>
                <div>{{headerCellData.column.caption.slice(headerCellData.column.caption.indexOf(' ') + 1)}}</div>
            </div>
            <div *dxTemplate="let cell of 'amountTemplate'">
                <ng-container>
                    <span [class]="'clipboard-holder ' + (cell.value < 0 ? 'negative-values' : 'positive-values')"> {{ cell.text | currency:_cfoPreferencesService.selectedCurrencyId:_cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }} </span>
                </ng-container>
            </div>
            <div *dxTemplate="let data of 'CategoryNameTemplate'">
                <span [ngClass]="{'uncategorized': !data.value && data.data.type != 'Adjustment'}">
                    <ng-container *ngIf="data.value">
                        <span class="clickable-item clipboard-holder"> {{data.value}} </span>
                    </ng-container>
                    <ng-container *ngIf="data.data.type == 'Adjustment'">
                        <span class="clipboard-holder"> {{data.data.description}} </span>
                    </ng-container>
                    <ng-container *ngIf="!data.value && data.data.type != 'Adjustment'">
                        <span class="clipboard-holder"> {{l('Unclassified')}} </span>
                    </ng-container>
                </span>
            </div>
        </dx-data-grid>
    </dx-resizable>
    <dx-scroll-view
        class="cashflow-scroll"
        (onScroll)="onScroll()"
        [ngClass]="{
            'withCashflowFooterToolbar' : cashflowService.cashflowGridSettings?.visualPreferences?.showFooterBar
        }">
        <div class="pivot-grid-wrapper">
            <dx-pivot-grid id="operations"
                           class="pivot-grid invisible"
                           [allowSortingBySummary]="false"
                           [allowSorting]="false"
                           [allowFiltering]="false"
                           [allowExpandAll]="false"
                           [(dataSource)]="dataSource"
                           [rowHeaderLayout]="'tree'"
                           [showColumnGrandTotals]="false"
                           [hideEmptySummaryCells]="true"
                           [showRowGrandTotals]="false"
                           [showRowTotals]="false"
                           [showBorders]="true"
                           [texts]="{'grandTotal': 'ENDING CASH POSITION', 'total': '{0}'}"
                           [fieldChooser]="false"
                           [export]="{'enabled': false}"
                           [loadPanel]="{enabled: false}"
                           (onCellPrepared)="onCellPrepared($event)"
                           (onContentReady)="onContentReady($event)"
                           (onCellClick)="onCellClick($event)"
                           [wordWrapEnabled]="false">
                <dxo-state-storing [customLoad]="stateLoad"
                                   [customSave]="stateSave"
                                   [enabled]="true"
                                   [savingTimeout]="stateSavingTimeout"
                                   type="custom">
                </dxo-state-storing>
                <dxo-scrolling mode="standard"></dxo-scrolling>
            </dx-pivot-grid>
        </div>
    </dx-scroll-view>
    <div class="sidebar-calculator-widget" [ngClass]="{'calculatorHidden': !calculatorShowed}">
        <div class="calculator-title">
            <h3>{{l( 'Cell Calculator')}}</h3>
            <span class="close" (click)="closeCalculator()"></span>
        </div>
        <calculator-widget></calculator-widget>
    </div>

    <div class="cashflowFooterToolbar" *ngIf="cashflowService.cashflowGridSettings?.visualPreferences?.showFooterBar">
        <app-toolbar [config]="footerToolbarConfig"></app-toolbar>
    </div>

</div>

<app-no-data
    *ngIf="!loading && cashflowService.cashflowData && !cashflowService.cashflowData.length"
    text=""
    [linkUrl]="instanceUri + 'start'"
    [showLink]="!filteredLoad"
    [linkText]="l('Go_to_sfo_setup')">
</app-no-data>
<div class="cashflowFooterToolbar"
     *ngIf="loading && (!cashflowService.cashflowData || !cashflowService.cashflowData.length) && cashflowService.cashflowGridSettings?.visualPreferences?.showFooterBar">
    <app-toolbar [config]="footerToolbarConfig"></app-toolbar>
</div>
