<app-headline [config]="headlineConfig" *ngIf="!isFullscreenMode">
    <synch-progress class="synch-progress" (onComplete)="showRefreshButton()"></synch-progress>
</app-headline>

<cashflow-operations
    [forecastModelsObj]="forecastModelsObj"
    (repaintCashflow)="repaintDataGrid()"
    (onGroupBy)="changeGroupBy($event)"
    (handleFullscreen)="toggleFullscreen(getFullscreenElement())"
    (onToggleRows)="togglePivotGridRows($event)"
    (download)="downloadData($event)"
    (showPreferencesDialog)="showPreferencesDialog()"
    (onSearchValueChange)="searchValueChange($event)"
    (onRefresh)="refreshDataGrid()"
></cashflow-operations>

<div class="cashflow" *ngIf="cashflowData && cashflowData.length">
    <div class="sort-options" [hidden]="!contentReady">
        <app-sorting [sortings]="sortings" (sortingChange)="resortPivotGrid($event)"></app-sorting>
    </div>
    <dx-scroll-view>
        <div class="pivot-grid-wrapper">
            <dx-pivot-grid *ngIf="cashflowData && cashflowData.length" id="operations"
                           class="pivot-grid invisible"
                           [allowSortingBySummary]="false"
                           [allowSorting]="false"
                           [allowFiltering]="false"
                           [allowExpandAll]="false"
                           [(dataSource)]="dataSource"
                           [rowHeaderLayout]="'tree'"
                           [showColumnGrandTotals]="false"
                           [hideEmptySummaryCells]="true"
                           [showRowGrandTotals]="false"
                           [showRowTotals]="false"
                           [showBorders]="true"
                           [texts] = "{'grandTotal': 'ENDING CASH POSITION', 'total': '{0}'}"
                           [fieldChooser]="false"
                           [export]="{'enabled': false}"
                           [loadPanel]="{enabled: false}"
                           (onCellPrepared)="onCellPrepared($event)"
                           (onContentReady)="onContentReady($event)"
                           (onCellClick)="onCellClick($event)"
                           [wordWrapEnabled]="false">
                <dxo-scrolling mode="standard"></dxo-scrolling>
            </dx-pivot-grid>
        </div>
    </dx-scroll-view>
    <div *ngIf="statsDetailResult !== undefined" class="cashflow-wrap">
        <div class="detailsButtons">
            <dx-button class="showall-btn" [text]="l('Show all')" [disabled]="showAllDisabled" (onClick)="showAll($event)"></dx-button>
            <dx-button class="reclassify-btn" [text]="l('Reclassify')" [disabled]="!cashFlowGrid || !cashFlowGrid.instance.getSelectedRowKeys().length" (onClick)="reclassifyTransactions($event)"></dx-button>
            <dx-button icon="close" (onClick)="closeTransactionsDetail()" class="close-btn"></dx-button>
        </div>
        <dx-data-grid id="cashflowGridContainer"
                      [rowAlternationEnabled]="true"
                      [dataSource]="statsDetailResult"
                      (onDataErrorOccurred)="httpConfig.handleError($event.error)"
                      (onCellPrepared)="onDetailsCellPrepared($event)"
                      (onCellClick)="onDetailsCellClick($event)"
                      (onEditingStart)="onDetailsEditingStart($event)"
                      (onRowPrepared)="onDetailsRowPrepared($event)"
                      (onRowUpdating)="onDetailsRowUpdating($event)">

            <dxo-editing mode="cell" [allowUpdating]="true"></dxo-editing>

            <dxo-header-filter [visible]="true"></dxo-header-filter>
            <dxo-selection selectAllMode="page"
                           showCheckBoxesMode="always"
                           mode="multiple">
            </dxo-selection>
            <dxi-column dataField="forecastDate"
                        dataType="date"
                        cellTemplate="dateCell"
                        headerCellTemplate="twoRowsHeaderCellTemplate"
                        alignment="left"
                        [caption]="this.l('DetailsHeaders_ForecastDate')">
                <dxi-validation-rule type="required"></dxi-validation-rule>
                <dxi-validation-rule type="custom" [validationCallback]="validateForecastDate"></dxi-validation-rule>
            </dxi-column>
            <dxi-column
                        dataField="date"
                        dataType="date"
                        cellTemplate="dateCell"
                        headerCellTemplate="twoRowsHeaderCellTemplate"
                        alignment="left"
                        [caption]="this.l('DetailsHeaders_ActualDate')"
                        [allowEditing]="false">
            </dxi-column>
            <dxi-column
                        dataField="status"
                        headerCellTemplate="twoRowsHeaderCellTemplate"
                        alignment="left"
                        [caption]="this.l('DetailsHeaders_CurrentStatus')"
                        [allowEditing]="false">
            </dxi-column>
            <dxi-column dataField="description" [width]="detailsDescriptionColumnWidth()" [caption]="this.l('DetailsHeaders_Description')">
                <dxo-header-filter [visible]="true"></dxo-header-filter>
            </dxi-column>
            <dxi-column dataField="debit"
                        [caption]="this.l('DetailsHeaders_Debit')"
                        [format]="customCurrency"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        alignment="'right'">
                <dxi-validation-rule type="numeric"></dxi-validation-rule>
            </dxi-column>
            <dxi-column dataField="credit"
                        [caption]="this.l('DetailsHeaders_Credit')"
                        [format]="customCurrency"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        alignment="'right'">
                <dxi-validation-rule type="numeric"></dxi-validation-rule>
            </dxi-column>
            <dxi-column [caption]="this.l('DetailsHeaders_Account')"
                        dataField="accountNumber"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [allowEditing]="false">
            </dxi-column>
            <dxi-column [caption]="this.l('DetailsHeaders_Type')"
                        dataField="cashflowTypeId"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [allowEditing]="false"
                        cellTemplate="typeCell">
            </dxi-column>
            <dxi-column [caption]="this.l('DetailsHeaders_Comments')"
                        dataField="comment"
                        [width]="detailsCommentsColumnWidth()"
                        [allowSorting]="false"
                        [allowFiltering]="false"
                        [allowEditing]="false">
            </dxi-column>

            <dxo-load-panel [enabled]="true"></dxo-load-panel>
            <dxo-scrolling mode="virtual"></dxo-scrolling>

            <div *dxTemplate="let cellData of 'dateCell'">{{cellData.value | date: 'MM/dd/yyyy'}}</div>
            <div *dxTemplate="let cellData of 'typeCell'">{{this.cashflowTypes[cellData.value]}}</div>
            <div *dxTemplate="let headerCellData of 'twoRowsHeaderCellTemplate'">
                <div class="firstLine">{{headerCellData.column.caption.slice(0, headerCellData.column.caption.indexOf(' '))}}</div>
                <div>{{headerCellData.column.caption.slice(headerCellData.column.caption.indexOf(' ') + 1)}}</div>
            </div>
        </dx-data-grid>
    </div>

    <div id="cashflowFooterToolbar">
        <app-toolbar [(config)]="footerToolbarConfig"></app-toolbar>
    </div>

</div>

<app-no-data
    *ngIf="startDataLoading && (!cashflowData || !cashflowData.length)"
    text="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incidid"
    linkUrl="/app/cfo/business/start"
    [showLink]="!filteredLoad"
    [linkText]="l('Go_to_sfo_setup')">
</app-no-data>
