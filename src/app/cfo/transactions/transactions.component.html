<div [@routerTransition]>
    <app-headline [names]="[ l('Transactions') ]"
                  [reloadIsNecessary]="noRefreshedAfterSync"
                  iconSrc="assets/common/icons/credit-card-icon.svg"
                  [buttons]="headlineButtons"
                  [showToggleCompactViewButton]="showToggleCompactViewButton"
                  [showToggleFullScreenButton]="true"
                  [showReloadButton]="true"
                  [showToggleToolbarButton]="true"
                  (onReload)="reload()"
                  (onToggleCompactView)="toggleCompactView()"
                  (onToggleFullScreen)="repaintDataGrid(100)"
                  (onToggleToolbar)="toggleToolbar()">
        <business-entities-chooser (onChanged)="applyTotalBankAccountFilter(true)"
            (onFilterButtonClick)="openBankAccountsSelectDialog()">
        </business-entities-chooser>
        <synch-progress class="synch-progress" (onComplete)="showRefreshButton()"></synch-progress>
        <calendar-button></calendar-button>
    </app-headline>
    <div class="portlet light no-padding margin-bottom-0">
        <div class="portlet-body">
            <div class="main-wrapper" [ngClass]="{'expanded': categoriesShowed}">
                <div class="categories">
                    <categorization
                        [hidden]="!toggleTabContent"
                        [width]="'340px'"
                        [height]="isFullscreenMode ? 'calc(100vh - 150px)': 'calc(100vh - 300px)'"
                        [showTitle]="true"
                        [showHeader]="true"
                        [showClearSelection]="true"
                        [showFilterIcon]="true"
                        [dragMode]="dragInProgress"
                        (close)="categoriesShowed = false"
                        [filteredRowsData]="categoriesRowsData"
                        [transactionsFilter]="transactionsFilterQuery"
                        (onTransactionDrop)="categorizeTransactions($event)"
                        (onFilterSelected)="filterByCashflowCategories($event)"
                        (onCategoriesChanged)="refreshDataGrid()">
                    </categorization>
                </div>
                <div class="transactions">
                    <dx-data-grid id="gridContainer"
                                  [noDataText]="!dataGrid?.dataSource || dataSource?.isLoading() ? '' : l('NoData')"
                                  [allowColumnReordering]="true"
                                  [columnAutoWidth]="true"
                                  [allowColumnResizing]="true"
                                  [hoverStateEnabled]="true"
                                  [columnMinWidth]="'125px'"
                                  [headerFilter]="{ allowSearch: true, visible: false }"
                                  [pager]="defaultGridPagerConfig"
                                  [loadPanel]="{
                                    enabled: true,
                                    showPane: false,
                                    showIndicator: true,
                                    minHeight: 150,
                                    minWidth: 150,
                                    indicatorSrc: './assets/common/images/spinner-32px.gif'
                                  }"
                                  [height]="gridHeight"
                                  [elementAttr]="{
                                    class: 'with-custom-loader'
                                  }"
                                  [columnResizingMode]="'widget'"
                                  (onContentReady)="onContentReady($event)"
                                  (onDataErrorOccurred)="httpInterceptor.handleError($event.error)"
                                  (onSelectionChanged)="onSelectionChanged($event)"
                                  (onCellClick)="onCellClick($event)"
                                  (onCellPrepared)="onCellPrepared($event)"
                                  (onToolbarPreparing)="onToolbarPreparing($event)"
                                  (onInitialized)="onInitialized($event)">
                        <dxo-selection selectAllMode="page"
                                       showCheckBoxesMode="always"
                                       mode="multiple">
                        </dxo-selection>
                        <dxo-group-panel [visible]="true"></dxo-group-panel>
                        <dxo-sorting mode="multiple"></dxo-sorting>
                        <dxo-paging [pageSize]="20"></dxo-paging>
                        <dxo-filter-row [visible]="false" [showOperationChooser]="true"></dxo-filter-row>

                        <dxi-column dataField="Date" dataType="date" cssClass="tabular" [caption]="l('Transactions_Date')" cellTemplate="dateCell"></dxi-column>
                        <dxi-column dataField="BusinessEntityId" [caption]="l('Transactions_BusinessEntity')" [lookup]="{allowClearing: false, dataSource: filtersInitialData?.businessEntities, displayExpr: 'name', valueExpr: 'id'}"></dxi-column>
                        <dxi-column [caption]="l('Transactions_CashflowCategoryName')"
                                    dataField="CashflowCategoryName"
                                    dataType="string"
                                    cellTemplate="CashflowCategoryNameTemplate"
                                    cssClass="category">
                        </dxi-column>
                        <dxi-column dataField="CounterpartyName" dataType="string" [caption]="l('Transactions_Vendor')" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="Description" cssClass="description-column" dataType="string" cellTemplate="descriptionTemplate" [caption]="l('Transactions_Description')"></dxi-column>
                        <dxi-column dataField="Amount" dataType="number" cssClass="tabular" name="Amount" [caption]="l('Transactions_Amount')" cellTemplate="amountTemplate"></dxi-column>
                        <dxi-column dataField="BankAccountNumber" cssClass="tabular clipboard-holder" [caption]="l('Transactions_BankAccountNumber')" [lookup]="{allowClearing: false, dataSource: bankAccountsLookup, displayExpr: 'accountName', valueExpr: 'accountNumber'}"></dxi-column>
                        <dxi-column dataField="Comments" dataType="string" [caption]="l('Transactions_Comments')" cssClass="clipboard-holder"></dxi-column>

                        <dxi-column dataField="CategoryName" dataType="string" [caption]="l('Transactions_CategoryName')" [lookup]="{dataSource: categories}" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="CashflowSubCategoryName" dataType="string" [caption]="l('Transactions_CashflowSubCategoryName')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="EndingBalance" dataType="number" cssClass="tabular" [caption]="l('Transactions_EndingBalance')" cellTemplate="endBalanceTemplate" [visible]="false"></dxi-column>
                        <dxi-column dataField="CashFlowTypeName" dataType="string" cellTemplate="CashFlowTypeNameTemplate" cssClass="cashflow-type" alignment="center"
                            [lookup]="{dataSource: ['Inflows', 'Outflows']}" [visible]="false" [caption]="l('Transactions_CashFlowType')"></dxi-column>
                        <dxi-column dataField="AccountingTypeName" dataType="string" [caption]="l('Transactions_AccountingTypeName')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="Descriptor" dataType="string" [caption]="l('Transactions_Descriptor')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="BankAccountBankName" dataType="string" [caption]="l('Transactions_BankName')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="Id" cssClass="tabular id-column clipboard-holder" [caption]="l('Transactions_Id')" sortOrder="desc" sortIndex="0" [visible]="false"></dxi-column>
                        <dxi-column dataField="BankCode" [caption]="l('Transactions_BankCode')" [visible]="false" [filterOperations]="'='" cssClass="clipboard-holder"></dxi-column>

                        <dxi-column dataField="IsPending" [caption]="l('Transactions_IsPending')" [visible]="false" cellTemplate="isPendingTemplate"></dxi-column>
                        <dxi-column dataField="MonthYear" [caption]="l('Transactions_MonthYear')" cellTemplate="dateMonthYear" groupCellTemplate="dateMonthYear" calculateSortValue="Date" [visible]="false"></dxi-column>
                        <dxi-column dataField="Debit" dataType="number" cssClass="tabular" name="Debit" [caption]="l('Transactions_Debit')" cellTemplate="amountTemplate" [visible]="false"></dxi-column>
                        <dxi-column dataField="Credit" dataType="number" cssClass="tabular" name="Credit" [caption]="l('Transactions_Credit')" cellTemplate="amountTemplate" [visible]="false"></dxi-column>
                        <dxi-column dataField="BankAccountTypeName" [caption]="l('Transactions_BankAccountType')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="Currency" [caption]="l('Transactions_Currency')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="Fees" dataType="number" cssClass="tabular clipboard-holder" [caption]="l('Transactions_Fees')" [visible]="false"></dxi-column>
                        <dxi-column dataField="TypeName" [caption]="l('Transactions_Type')" [visible]="false" [lookup]="{dataSource: types}" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="ProviderCashFlowCategoryName" [caption]="l('Transactions_ProviderCashFlowCategory')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="ProviderCashFlowSubCategoryName" [caption]="l('Transactions_ProviderCashFlowSubCategory')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                        <dxi-column dataField="Department"
                                    cssClass="clipboard-holder"
                                    [caption]="l('Transactions_Department')"
                                    [visible]="departmentFeatureEnabled"
                                    [showInColumnChooser]="departmentFeatureEnabled">
                        </dxi-column>

                        <div *dxTemplate="let cell of 'amountTemplate'">
                            <ng-container *ngIf="(cell.text) && ((cell.column.name == 'Amount') || (cell.value < 0 && cell.column.name == 'Debit') || (cell.value >= 0 && cell.column.name == 'Credit'))">
                                <span [class]="'clipboard-holder ' + (cell.value < 0 ? 'negative' : 'positive') + '-values'"> {{ cell.text | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }} </span>
                            </ng-container>
                        </div>
                        <div *dxTemplate="let cell of 'isPendingTemplate'">
                            <span class="clipboard-holder"> {{ l(cell.value ? 'Transactions_Pending' : 'Transactions_Settled') }} </span>
                        </div>
                        <div *dxTemplate="let cell of 'endBalanceTemplate'">
                            <ng-container *ngIf="cell.text">
                                <span class="clipboard-holder end-balance{{cell.data['IsBalanceConfirmed'] ? '' : '-not'}}-confirmed"> {{ cell.text | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }} </span>
                            </ng-container>
                        </div>
                        <div *dxTemplate="let cell of 'descriptionTemplate'">
                            <span class="clipboard-holder fixed-right transaction-target" id="transactionDetailTarget-{{cell.data.Id}}" title="{{cell.text}}">{{cell.text}}</span>
                        </div>

                        <div *dxTemplate="let data of 'CashflowCategoryNameTemplate'">
                            <span [ngClass]="{'uncategorized': !data.value}">
                                <span class="clipboard-holder clickable-item"> {{ data.value || l('Unclassified') }} </span>
                            </span>
                        </div>

                        <div *dxTemplate="let data of 'CashFlowTypeNameTemplate'" [class]="'clipboard-holder ' + data.value.toLowerCase()">
                            {{data.value}}
                        </div>

                        <div *dxTemplate="let cellData of 'dateCell'" class="clipboard-holder">
                            {{cellData.value | date: 'MM/dd/yyyy'}}
                        </div>

                        <div *dxTemplate="let cellData of 'dateMonthYear'" class="clipboard-holder">
                            {{cellData.value | date: 'MMM yyyy'}}
                        </div>

                        <div *dxTemplate="let data of 'startBalanceTotal'">
                            <div class="informer starting-balance">
                                <h2 class="count clipboard-holder">
                                    {{adjustmentStartingBalanceTotal  | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2'}}
                                </h2>
                                <span class="name">{{l('Starting_Balance')}}</span>
                            </div>
                        </div>

                        <div *dxTemplate="let data of 'creditTotal'">
                            <div class="informer">
                                <h2 class="count positive-values clipboard-holder">
                                    {{ creditTransactionTotal | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }}
                                </h2>
                                <span class="name" (click)="toggleCreditDefault()">
                                    {{l('Credits')}} <span class="name-count clipboard-holder">{{creditTransactionCount | number}}</span> <i id="creditDetails" class="arrow"></i>
                                </span>

                                <dx-tooltip target="#creditDetails"
                                            [(visible)]="defaultCreditTooltipVisible">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <div class="tooltip-wrap classification-status">
                                            <header>
                                                {{l('Classification_Status')}}
                                                <span class="click-to-filter">{{l('ClickToFilter')}}</span>
                                            </header>
                                            <ul class="classification-list">

                                                <li class="classification-item classified" (click)="applyTotalFilters(true, true, false)">
                                                    <span class="classified-item-title"><span class="border">{{l('Classified')}}</span></span>
                                                    <span class="classification-item-number">{{creditClassifiedTransactionCount | number}}</span>
                                                    <span class="classification-item-percent">{{creditClassifiedTransactionCount / creditTransactionCount | percent}}</span>
                                                </li>
                                                <li class="classification-item unclassified" (click)="applyTotalFilters(false, true, false)">
                                                    <span class="unclassified-item-title"><span class="border">{{l('Unclassified')}}</span></span>
                                                    <span class="classification-item-number">{{creditTransactionCount - creditClassifiedTransactionCount}}</span>
                                                    <span class="classification-item-percent">{{(creditTransactionCount - creditClassifiedTransactionCount) / creditTransactionCount | percent}}</span>
                                                </li>
                                            </ul>
                                            <div class="btns-wrap clearfix" *ngIf="isInstanceAdmin">
                                                <a (click)="openDialog('credit');" class="small-button btn-layout">
                                                    {{l('Unclassify_Btn')}}
                                                </a>
                                                <a (click)="autoClassify('credit');" class="small-button btn-layout">
                                                    {{l('Auto_Classify_Btn')}}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </dx-tooltip>
                            </div>
                        </div>

                        <div *dxTemplate="let data of 'debitTotal'">
                            <div class="informer">
                                <h2 class="count negative-values clipboard-holder">
                                    {{ debitTransactionTotal | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }}
                                </h2>
                                <span class="name" (click)="toggleDebitDefault()">
                                    {{l('Debits')}} <span class="name-count clipboard-holder">{{debitTransactionCount | number}}</span> <i id="debitDetails" class="arrow"></i>
                                </span>
                                <dx-tooltip target="#debitDetails"
                                            [(visible)]="defaultDebitTooltipVisible">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <div class="tooltip-wrap classification-status">
                                            <header>
                                                {{l('Classification_Status')}}
                                                <span class="click-to-filter">{{l('ClickToFilter')}}</span>
                                            </header>
                                            <ul class="classification-list">
                                                <li class="classification-item classified" (click)="applyTotalFilters(true, false, true)">
                                                    <span class="classified-item-title"><span class="border">{{l('Classified')}}</span></span>
                                                    <span class="classification-item-number">{{debitClassifiedTransactionCount | number}}</span>
                                                    <span class="classification-item-percent">{{debitClassifiedTransactionCount / debitTransactionCount | percent}}</span>
                                                </li>
                                                <li class="classification-item unclassified" (click)="applyTotalFilters(false, false, true)">
                                                    <span class="unclassified-item-title"><span class="border">{{l('Unclassified')}}</span></span>
                                                    <span class="classification-item-number">{{debitTransactionCount - debitClassifiedTransactionCount}}</span>
                                                    <span class="classification-item-percent">{{(debitTransactionCount - debitClassifiedTransactionCount) / debitTransactionCount | percent}}</span>
                                                </li>
                                            </ul>
                                            <div class="btns-wrap clearfix" *ngIf="isInstanceAdmin">
                                                <a (click)="openDialog('debit');" class="small-button btn-layout">
                                                    {{l('Unclassify_Btn')}}
                                                </a>
                                                <a (click)="autoClassify('debit');" class="small-button btn-layout">
                                                    {{l('Auto_Classify_Btn')}}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </dx-tooltip>
                            </div>
                        </div>

                        <div *dxTemplate="let data of 'transactionTotal'">
                            <div class="informer">
                                <h2 class="count clipboard-holder">
                                    {{ transactionTotal | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }}
                                </h2>
                                <span class="name" (click)="toggleTotalDefault()">
                                    <span id="adjustments" *ngIf="adjustmentTotal !== 0">!</span> {{l('Net_Amount')}} <span class="name-count clipboard-holder">{{transactionCount | number}}</span> <i id="totalDetails" class="arrow"></i>

                                </span>
                                <dx-tooltip target="#adjustments"
                                            position="top"
                                            showEvent="dxhoverstart"
                                            hideEvent="dxhoverend">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <span class="title">{{ls('Platform', 'Unreconciled_Balance')}}:</span> {{adjustmentTotal | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2'}}
                                    </div>
                                </dx-tooltip>
                                <dx-tooltip target="#totalDetails"
                                            [(visible)]="defaultTotalTooltipVisible">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <div class="tooltip-wrap classification-status">
                                            <header>
                                                {{l('Classification_Status')}}
                                                <span class="click-to-filter">{{l('ClickToFilter')}}</span>
                                            </header>
                                            <ul class="classification-list">
                                                <li class="classification-item classified" (click)="applyTotalFilters(true, false, false)">
                                                    <span class="classified-item-title"><span class="border">{{l('Classified')}}</span></span>
                                                    <span class="classification-item-number">{{debitClassifiedTransactionCount + creditClassifiedTransactionCount | number}}</span>
                                                    <span class="classification-item-percent">{{(debitClassifiedTransactionCount + creditClassifiedTransactionCount) / transactionCount | percent}}</span>
                                                </li>
                                                <li class="classification-item unclassified" (click)="applyTotalFilters(false, false, false)">
                                                    <span class="unclassified-item-title"><span class="border">{{l('Unclassified')}}</span></span>
                                                    <span class="classification-item-number">{{transactionCount - (debitClassifiedTransactionCount + creditClassifiedTransactionCount)}}</span>
                                                    <span class="classification-item-percent">{{(transactionCount - (debitClassifiedTransactionCount + creditClassifiedTransactionCount)) / transactionCount | percent}}</span>
                                                </li>
                                            </ul>
                                            <div class="btns-wrap clearfix" *ngIf="isInstanceAdmin">
                                                <a (click)="openDialog('total');" class="small-button btn-layout">
                                                    {{l('Unclassify_Btn')}}
                                                </a>
                                                <a (click)="autoClassify('total');" class="small-button btn-layout">
                                                    {{l('Auto_Classify_Btn')}}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </dx-tooltip>
                            </div>
                        </div>
                    </dx-data-grid>
                </div>
            </div>
        </div>
    </div>
</div>
