<div [@routerTransition]>
    <app-headline [config]="headlineConfig">
        <synch-progress class="synch-progress" (onComplete)="showRefreshButton()"></synch-progress>
    </app-headline>
    <div class="portlet light no-padding margin-bottom-0">
        <div class="portlet-body">
            <div class="main-wrapper" [ngClass]="{'expanded': categoriesShowed}">
                <div class="categories">
                    <categorization
                        [width]="'340px'"
                        [height]="'calc(100vh - 300px)'"
                        [showTitle]="true"
                        [showHeader]="true"
                        [showClearSelection]="true"
                        [showFilterIcon]="true"
                        [dragMode]="dragInProgress"
                        [pager]="defaultGridPagerConfig"
                        (close)="categoriesShowed = false"
                        [instanceType]="instanceType"
                        [instanceId]="instanceId"
                        [transactionsFilter]="transactionsFilterQuery"
                        (onTransactionDrop)="categorizeTransactions($event)"
                        (onFilterSelected)="filterByCashflowCategory($event)"
                        (onCategoriesChanged)="refreshDataGrid()">
                    </categorization>
                </div>
                <div class="transactions">
                    <dx-data-grid id="gridContainer"
                                  [dataSource]="dataSource"
                                  [allowColumnReordering]="true"
                                  [columnAutoWidth]="true"
                                  [allowColumnResizing]="true"
                                  [hoverStateEnabled]="true"
                                  [columnResizingMode]="'widget'"
                                  (onContentReady)="onContentReady($event)"
                                  (onDataErrorOccurred)="httpConfig.handleError($event.error)"
                                  (onSelectionChanged)="onSelectionChanged($event)"
                                  (onCellPrepared)="onCellPrepared($event)"
                                  (onToolbarPreparing)="onToolbarPreparing($event)">
                        <dxo-selection selectAllMode="page"
                                       showCheckBoxesMode="always"
                                       mode="multiple">
                        </dxo-selection>
                        <dxo-group-panel [visible]="true"></dxo-group-panel>
                        <dxo-sorting mode="multiple"></dxo-sorting>

                        <dxi-column dataField="Date" cssClass="tabular" caption="{{l('Transactions_Date')}}" cellTemplate="dateCell"></dxi-column>
                        <dxi-column dataField="Description" caption="{{l('Transactions_Description')}}" [width]="450"></dxi-column>
                        <dxi-column caption="{{l('Transactions_CashflowCategoryName')}}"
                                    dataField="CashflowCategoryName"
                                    cellTemplate="CashflowCategoryNameTemplate"
                                    cssClass="category"></dxi-column>
                        <dxi-column dataField="CashflowSubCategoryName" caption="{{l('Transactions_CashflowSubCategoryName')}}"></dxi-column>
                        <dxi-column dataField="Amount" cssClass="tabular" name="Amount" caption="{{l('Transactions_Amount')}}" cellTemplate="amountTemplate"></dxi-column>
                        <dxi-column dataField="EndingBalance" cssClass="tabular" caption="{{l('Transactions_EndingBalance')}}" cellTemplate="endBalanceTemplate" [visible]="false"></dxi-column>
                        <dxi-column dataField="CashFlowTypeName"
                                    cellTemplate="CashFlowTypeNameTemplate"
                                    cssClass="cashflow-type"
                                    alignment="center"
                                    caption="{{l('Transactions_CashFlowType')}}"></dxi-column>
                        <dxi-column dataField="AccountingTypeName" caption="{{l('Transactions_AccountingTypeName')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="BankAccountNumber" cssClass="tabular" caption="{{l('Transactions_BankAccountNumber')}}"></dxi-column>
                        <dxi-column dataField="Descriptor" caption="{{l('Transactions_Descriptor')}}"></dxi-column>
                        <dxi-column dataField="Comments" caption="{{l('Transactions_Comments')}}"></dxi-column>

                        <dxi-column dataField="Id" cssClass="tabular id-column" caption="{{l('Transactions_Id')}}" sortOrder="desc" sortIndex="0" [visible]="false"></dxi-column>
                        <dxi-column dataField="BankCode" caption="{{l('Transactions_BankCode')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="IsPending" caption="{{l('Transactions_IsPending')}}" [visible]="false" cellTemplate="isPendingTemplate"></dxi-column>
                        <dxi-column dataField="BankAccountTypeName" caption="{{l('Transactions_BankAccountType')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="Currency" caption="{{l('Transactions_Currency')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="BankAccountBankName" caption="{{l('Transactions_BankName')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="Fees" cssClass="tabular" caption="{{l('Transactions_Fees')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="CategoryName" caption="{{l('Transactions_CategoryName')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="TypeName" caption="{{l('Transactions_Type')}}" [visible]="false"></dxi-column>
                        <dxi-column dataField="ExpenseCategoryName" caption="{{l('Transactions_ExpenseCategory')}}" [visible]="false"></dxi-column>
                        <dxi-column [fixed]="true" [fixedPosition]="'right'" [showInColumnChooser]="false"></dxi-column>

                        <div *dxTemplate="let cell of 'amountTemplate'">
                            <ng-container *ngIf="(cell.text) && (cell.column.name == 'Amount') ">
                                <span [ngClass]="cell.value < 0 ? 'negative-values' : 'positive-values'"> {{ cell.text | currency:'USD':'symbol':'1.2-2' }} </span>
                            </ng-container>
                        </div>
                        <div *dxTemplate="let cell of 'isPendingTemplate'">
                            <ng-container *ngIf="cell.value">
                                <span> {{l('Transactions_Pending')}} </span>
                            </ng-container>
                            <ng-container *ngIf="!cell.value">
                                <span> {{l('Transactions_Settled')}} </span>
                            </ng-container>
                        </div>
                        <div *dxTemplate="let cell of 'endBalanceTemplate'">
                            <ng-container *ngIf="cell.text">
                                <span class="end-balance{{cell.data['IsBalanceConfirmed'] ? '' : '-not'}}-confirmed"> {{ cell.text | number:'1.2-2' }} </span>
                            </ng-container>
                        </div>

                        <div *dxTemplate="let data of 'CashflowCategoryNameTemplate'">
                            <span [ngClass]="{'uncategorized': !data.value}">
                                <ng-container *ngIf="data.value">
                                    <span> {{data.value}} </span>
                                </ng-container>
                                <ng-container *ngIf="!data.value">
                                    <span> {{l('Unclassified')}} </span>
                                </ng-container>
                            </span>
                        </div>

                        <div *dxTemplate="let data of 'CashFlowTypeNameTemplate'" [ngClass]="data.value.toLowerCase()">
                            {{data.value}}
                        </div>

                        <div *dxTemplate="let cellData of 'dateCell'">
                            {{cellData.value | date: 'MM/dd/yyyy'}}
                        </div>

                        <dxo-paging [pageSize]="20"></dxo-paging>

                        <div *dxTemplate="let data of 'bankAccountTotal'">
                            <div class="informer" (click)="toggleSubaccountsDetails()">
                                <h2 class="count">{{bankAccountCount| number}}</h2>
                                <span class="name">
                                    {{l('Accounts')}}
                                    <i id="subaccountsDetails" class="arrow"></i>
                                </span>

                                <dx-tooltip target="#subaccountsDetails"
                                            [(visible)]="defaultSubaccountTooltipVisible">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <div class="tooltip-wrap">
                                            <div *ngFor="let bankAccount of getBankAccounts()">
                                                <span class="name" (click)="applyTotalBankAccountFilter(bankAccount.id)">
                                                    {{ bankAccount.name }}
                                                </span>
                                                <br />
                                            </div>
                                        </div>
                                    </div>
                                </dx-tooltip>
                            </div>
                        </div>

                        <div *dxTemplate="let data of 'startBalanceTotal'">
                            <div class="informer starting-balance">
                                <h2 class="count">
                                    ${{adjustmentStartingBalanceTotal | number:'1.0-0'}}
                                    <span class="cent">.{{adjustmentStartingBalanceTotalCent | number:'2.0-0'}}</span>
                                </h2>
                                <span class="name">{{l('Starting_Balance')}}</span>
                            </div>
                        </div>

                        <div *dxTemplate="let data of 'creditTotal'">
                            <div class="informer">
                                <h2 class="count positive-values">
                                    {{creditTransactionTotal | currency:'USD':'symbol':'1.0-0'}}
                                    <span class="cent">.{{creditTransactionTotalCent | number:'2.0-0'}}</span>
                                </h2>
                                <span class="name" (click)="toggleCreditDefault()">
                                    {{l('Credits')}} <span class="name-count">{{creditTransactionCount | number}}</span> <i id="creditDetails" class="arrow"></i>
                                </span>

                                <dx-tooltip target="#creditDetails"
                                            [(visible)]="defaultCreditTooltipVisible">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <div class="tooltip-wrap">
                                            <span class="name" (click)="applyTotalFilters(false, true, false)">
                                                {{l('Unclassified')}} ({{creditTransactionCount - creditClassifiedTransactionCount | number}})
                                            </span><br />
                                            <span class="name" (click)="applyTotalFilters(true, true, false)">
                                                {{l('Classified')}} ({{creditClassifiedTransactionCount | number}})
                                            </span>
                                        </div>
                                    </div>
                                </dx-tooltip>
                            </div>
                        </div>

                        <div *dxTemplate="let data of 'debitTotal'">
                            <div class="informer">
                                <h2 class="count negative-values">
                                    {{debitTransactionTotal | currency:'USD':'symbol':'1.0-0'}}
                                    <span class="cent">.{{debitTransactionTotalCent | number:'2.0-0'}}</span>
                                </h2>
                                <span class="name" (click)="toggleDebitDefault()">
                                    {{l('Debits')}} <span class="name-count">{{debitTransactionCount | number}}</span> <i id="debitDetails" class="arrow"></i>
                                </span>
                                <dx-tooltip target="#debitDetails"
                                            [(visible)]="defaultDebitTooltipVisible">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <div class="tooltip-wrap">
                                            <span class="name" (click)="applyTotalFilters(false, false, true)">
                                                {{l('Unclassified')}} ({{debitTransactionCount - debitClassifiedTransactionCount | number}})
                                            </span><br />
                                            <span class="name" (click)="applyTotalFilters(true, false, true)">
                                                {{l('Classified')}} ({{debitClassifiedTransactionCount | number}})
                                            </span>
                                        </div>
                                    </div>
                                </dx-tooltip>
                            </div>
                        </div>

                        <div *dxTemplate="let data of 'transactionTotal'">
                            <div class="informer">
                                <h2 class="count">
                                    ${{transactionTotal | number:'1.0-0'}}
                                    <span class="cent">.{{transactionTotalCent | number:'2.0-0'}}</span>
                                </h2>
                                <span class="name" (click)="toggleTotalDefault()">
                                    {{l('Net_Amount')}} <span class="name-count">{{transactionCount | number}}</span> <i id="totalDetails" class="arrow"></i>
                                </span>
                                <dx-tooltip target="#totalDetails"
                                            [(visible)]="defaultTotalTooltipVisible">
                                    <div *dxTemplate="let data = data of 'content'">
                                        <div class="tooltip-wrap">
                                            <span class="name" (click)="applyTotalFilters(false, false, false)">
                                                {{l('Unclassified')}} ({{transactionCount - (debitClassifiedTransactionCount + creditClassifiedTransactionCount) | number}})
                                            </span><br />
                                            <span class="name" (click)="applyTotalFilters(true, false, false)">
                                                {{l('Classified')}} ({{debitClassifiedTransactionCount + creditClassifiedTransactionCount | number}})
                                            </span>
                                        </div>
                                    </div>
                                </dx-tooltip>
                            </div>
                        </div>
                    </dx-data-grid>
                </div>
            </div>
        </div>
    </div>
</div>
