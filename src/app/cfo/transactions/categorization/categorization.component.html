<div [ngClass]="{ 'show-search': showSearch }">
    <div class="tree-header" *ngIf="showHeader">
        <h3>
            <span *ngIf="showTitle">{{l('ClassifyTransactions')}}</span>
            <span *ngIf="showSelectAll" class="select-all" (click)="toggleSelection()">{{l(checkSelectedAll() ? 'DeselectAll': 'SelectAll')}}</span>
            <div class="apply-all">
                <span *ngIf="showApplySelection" class="btn-apply" (click)="applyFilterSelection()">{{l('Apply')}}</span>
                <span *ngIf="showClearSelection" class="btn-clear" (click)="clearFilterSelection()">{{l('Clear')}}</span>
            </div>
            <span *ngIf="showCloseButton" class="close" (click)="close.emit(null)"></span>
        </h3>
        <app-toolbar *ngIf="showToolbar" [config]="toolbarConfig" [compact]="true"></app-toolbar>
    </div>
    <dx-tree-list [width]="width"
                  [height]="height"
                  keyExpr="key"
                  parentIdExpr="parent"
                  [noDataText]="noDataText"
                  [hoverStateEnabled]="true"
                  [(dataSource)]="categories"
                  [selection]="{ allowSelectAll: false, mode: 'single' }"
                  [searchPanel]="{ visible: showSearch, placeholder: l('Find by ID or name') }"
                  [rootValue]="'root'"
                  (onKeyDown)="onKeyDown($event)"
                  (onCellPrepared)="onCellPrepared($event)"
                  (onRowClick)="onRowClick($event)"
                  (onOptionChanged)="onOptionChanged($event)"
                  (onContentReady)="onContentReady($event)"
                  (onSelectionChanged)="onSelectedCategoryChanged($event)"
                  (onRowUpdated)="onCategoryUpdated($event)"
                  (onRowInserted)="onCategoryInserted($event)"
                  (onRowExpanded)="onRowExpandChange()"
                  (onRowCollapsed)="onRowExpandChange()"
                  (onRowPrepared)="onRowPrepared($event)">
        <dxo-editing mode="row"
                     [texts]="{ confirmDeleteMessage: '' }"
                     [allowUpdating]="true"
                     [allowAdding]="false">
        </dxo-editing>
        <dxi-column [cssClass]="columnClassName"
                    editCellTemplate="categoryEditTemplate"
                    cellTemplate="categoryTemplate"
                    [allowSorting]="true"
                    [sortIndex]="0"
                    [width]="180"
                    [sortingMethod]="sortItem"
                    [calculateSortValue]="calculateSortValue"
                    sortOrder="asc"
                    dataField="name">
        </dxi-column>
        <dxi-column [allowSorting]="true"
                    alignment="left"
                    [sortIndex]="1"
                    sortOrder="asc"
                    dataField="coAID"
                    caption="ID"
                    [calculateSortValue]="calculateSortValue"
                    [visible]="settings.showCID">
        </dxi-column>
        <dxi-column dataField="transactionsCount"
                    [cellTemplate]="'transactionsCountTemplate'"
                    dataType="number"
                    alignment="left"
                    caption="Count"
                    [allowEditing]="false"
                    [visible]="settings.showTC">
        </dxi-column>

        <div *dxTemplate="let cell of 'categoryEditTemplate'">
            <dx-text-box [width]="180" [value]="cell.value" valueChangeEvent="keyup" (onValueChanged)="cell.setValue($event.value)"></dx-text-box>
        </div>

        <div *dxTemplate="let cell of 'categoryTemplate'" [title]="cell.text">
            <ng-container>
                <div class="category-hover"></div>
                <span>{{ cell.text }}</span>
                <div class="category-drop-area">
                    <div *ngIf="isInstanceAdmin || _cfoService.classifyTransactionsAllowed()"
                         class="category-drop-add-rule">
                        {{l('AddRule')}}
                    </div>
                </div>
            </ng-container>
        </div>
        <div *dxTemplate="let cell of 'transactionsCountTemplate'">
            <div *ngIf="cell.value" class="transactionCount">
                <span>{{ cell.text }}</span>
            </div>
        </div>
    </dx-tree-list>
</div>