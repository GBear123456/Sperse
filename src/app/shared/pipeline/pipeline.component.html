<div class="pipeline-wrapper">
    <div *ngFor="let stage of stages; let i = index;"
         class="column column{{stage.index + ' ' + (stage.sortOrder && (stage.sortOrder > 0 ? 'positive': 'negative') || 'focused')}}"
        [ngStyle]="{
            flexGrow: stage.width * 3,
            flexBasis: 'calc(100% / ' + (stages.length - stage.width) + ')',
            width: 'calc(100% / ' + stages.length + ')'
        }"
        [ngClass]="stageWidths[stage.width].toLowerCase()">
        <div class="column-title"
             [title]="stage.name"
             [hidden]="loading"
             [ngStyle]="{
                 width: columnItems.offsetWidth + 'px',
                 backgroundColor: stage.color,
                 borderLeftColor: stage.color,
                 borderRightColor: stage.color
             }">
            <span class="stageName">{{stage.name}}</span>
            <div *ngIf="stage?.total">
                <span>
                    (<ng-container *ngIf="getStageSelectedEntitiesCount(stage) as selectedEntitiesCount">{{ selectedEntitiesCount | number }} of </ng-container>{{ stage?.total | number }})
                </span>
                <span *ngIf="stage.total && allStagesEntitiesTotal">{{ getStageRatio(stage.total) }}</span>
            </div>
            <button [id]="'ident' + stage.id" class="edit-button">
                <img src="./assets/common/icons/edit-icon.svg" alt="Edit">
            </button>
            <dx-tooltip
                target="#{{'ident' + stage.id}}"
                (onShowing)="onTooltipShowing($event)"
                showEvent="click">
                <div *dxTemplate="let data = data of 'content'">
                    <ul class="stage-actions list-group">
                        <li class="list-group-item" [hidden]="stage.isFinal">
                            <a (click)="$event.preventDefault()">
                                <dx-check-box
                                    [ngClass]="{ 'toggleAll': true, 'visible': allEntitiesAreSelected(stage) }"
                                    *ngIf="stage?.entities.length"
                                    width="210px"
                                    [text]="l('Sellect_All_Records')"
                                    [value]="allEntitiesAreSelected(stage)"
                                    (onValueChanged)="toggleAllEntitiesInStage($event, stage)">
                                </dx-check-box>
                            </a>
                        </li>
                        <li class="list-group-item width-change">
                            <a [ngClass]="{ hidden: stage.width === stageWidths.Narrow }"
                               (click)="changeWidth(stage, -1)">
                                <i class="delete-stage"></i>
                            </a>
                            <span>{{ l(stageWidths[stage.width]) }}</span>
                            <a [ngClass]="{ hidden: stage.width === stageWidths.Wide }"
                               (click)="changeWidth(stage, 1)">
                                <i class="add-stage"></i>
                            </a>
                        </li>
                        <li class="list-group-item" [hidden]="stage.isFinal">
                            <a (click)="updateStage(stage, 'Add')"><i class="add-stage"></i> <span>{{l('Add_New_Stage')}}</span></a>
                        </li>
                        <li class="list-group-item">
                            <a (click)="updateStage(stage, 'Rename')"><i class="edit-stage"></i> <span>{{l('Rename_Stage')}}</span></a>
                        </li>
                        <li class="list-group-item" [hidden]="disallowDelete(stage)">
                            <a (click)="updateStage(stage, 'Merge')"><i class="delete-stage"></i> <span>{{l('Delete_Stage')}}</span></a>
                        </li>
                        <li class="list-group-item">
                            <a (click)="moveStage(stage, false)" [ngClass]="{disabled: disallowMove(stage)}"><i class="left-arrow"></i> <span>{{l('Move_Left_Stage')}}</span></a>
                            <a (click)="moveStage(stage, true)" [ngClass]="{disabled: disallowMove(stage, true)}"><span>{{l('Move_Right_Stage')}}</span> <i class="right-arrow"></i></a>
                        </li>
                    </ul>
                </div>
            </dx-tooltip>
            <loading-spinner
                *ngIf="stage.isLoading"
                type="blue"
                [ngStyle]="{ top: this.getStageSpinnerTopPosition(stage) }">
            </loading-spinner>
        </div>
        <div [ngClass]="{ 'column-items': true, 'drag-allowed': stage?.dragAllowed }"
             [dragula]="dragulaName"
             [dragulaModel]="stage?.entities"
             [accessKey]="stage?.id"
             (click)="hideStageHighlighting()" #columnItems>
            <div *ngFor="let entity of stage.entities"
                 [ngClass]="{ card: true, locked: entity?.locked, selected: entity?.selected, compact: compactView }"
                 [ngStyle]="{ borderTopColor: stage.color }"
                 [accessKey]="entity?.Id"
                 [attr.stage]="entity?.StageId"
                 (click)="onCardClickInternal(entity, $event)">
                <div class="container-fluid">
                    <div class="row">
                        <div class="full-name">
                            <ng-container *ngIf="(entity?.Name || entity?.Title || entity?.Email) as name; else noName">
                                <span [title]="name">{{ name }}</span>
                            </ng-container>
                            <ng-template #noName>
                                <span class="no-name">{{ l('ClientNoName') }}</span>
                            </ng-template>
                        </div>
                        <div class="bank-code" *ngIf="entity?.BankCode && userManagementService.checkBankCodeFeature()">
                            <bank-code-letter [id]="'bankCode' + entity.Id"
                                              [letter]="entity.BankCode[0]"
                                              (click)="hideBankCodeTooltip(entity.Id)">
                            </bank-code-letter>
                            <dx-tooltip #bankCodeTooltip
                                        [target]="'#bankCode' + entity.Id"
                                        showEvent="dxhoverstart"
                                        hideEvent="dxhoverend">
                                <div *dxTemplate="let data of 'content'">
                                    <div class="bank-code-tooltip">
                                        <bank-code-letters [bankCode]="entity.BankCode"></bank-code-letters>
                                    </div>
                                </div>
                            </dx-tooltip>
                        </div>
                    </div>
                    <div class="row" *ngIf="(entity?.CompanyName || entity?.Description) as companyName">
                        <div class="company-name">
                            <span [title]="companyName">{{ companyName }}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="check-box">
                            <dx-check-box [value]="!!entity.selected"></dx-check-box>
                        </div>
                        <div class="days-ago">
                            <img src="./assets/common/icons/clock-circle.svg" class="img-responsive">
                            <span *ngIf="dateField && entity[dateField]">{{ entity[dateField] | timeAgo }}</span>
                            <span *ngIf="entity?.StartDate">{{ getDateWithTimezone(entity?.StartDate) | date : 'M/d, H:mm' }} - {{ getDateWithTimezone(entity?.EndDate) | date : 'M/d, H:mm' }}</span>
                        </div>
                        <div class="text-right pipeline-photo-wrap">
                            <div [ngStyle]="{'background-image': entity?.PhotoPublicId ? 'url(' + profileService.getContactPhotoUrl(entity?.PhotoPublicId) + ')': 'none'}" class="img-responsive img-circle"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <span class="load-more"
              [hidden]="stage.isFull || !stage?.entities?.length && !stage?.total"
              (click)="loadMore(i)">
            <img src="./assets/common/icons/arrow-down.svg">
        </span>
    </div>
</div>