<div class="pipeline-wrapper" [ngClass]="{disabled: disabled}">
    <div *ngFor="let stage of stages; let i = index;" class="column column{{stage.index + ' ' + (stage.sortOrder && (stage.sortOrder > 0 ? 'positive': 'negative') || 'focused')}} color-{{stage.color}}">
        <div class="column-title">
            <span>{{stage.name}}</span><div>{{'(' + (stage?.total || 0) + ')'}}</div>
            <button id="{{stage.name | lowercase | replace:' ':'-'}}" class="edit-button">
                <img src="./assets/common/icons/edit-icon.svg" alt="Edit">
            </button>
            <dx-tooltip
                target="#{{stage.name | lowercase | replace:' ':'-'}}"
                (onShowing)="onTooltipShowing($event)"
                showEvent="click">
                <div *dxTemplate="let data = data of 'content'">
                    <ul class="stage-actions list-group">
                        <li class="list-group-item" *ngIf="[firstStage.id, lastStage.id].indexOf(stage.id) < 0">
                            <a (click)="updateStage(stage, 'Add')"><i class="fa fa-plus fa-fw" style="color: greenyellow"></i> {{l('Add_New_Stage')}}</a>
                        </li>
                        <li class="list-group-item">
                            <a (click)="updateStage(stage, 'Rename')"><i class="fa fa-pencil fa-fw" style="color: orange"></i> {{l('Rename_Stage')}}</a>
                        </li>
                        <li class="list-group-item">
                            <a (click)="updateStage(stage, 'Merge')"><i class="fa fa-minus fa-fw" style="color: red"></i> {{l('Delete_Stage')}}</a>
                        </li>
                    </ul>
                </div>
            </dx-tooltip>
        </div>
        <div class="column-items" [ngClass]="{'drag-allowed': stage?.dragAllowed}" [dragula]="dragulaName" [dragulaModel]="stage?.entities" accessKey="{{stage?.id}}" (click)="hideStageHighlighting()">
            <ng-container *ngFor="let entity of stage.entities">
                  <div class="card" [ngClass]="{locked: entity?.locked}" [accessKey]="entity?.Id" (click)="onCardClickInternal(entity, $event)" [attr.stage]="entity?.StageId" count="">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="full-name">
                                    <span *ngIf="entity?.Name || entity?.Title">{{ entity?.Name || entity?.Title }}</span>
                                    <span *ngIf="!entity?.Name && !entity?.Title" class="no-name">{{ l('ClientNoName') }}</span>
                                    <div class="company-name">
                                        <span>{{ entity?.CompanyName || entity?.Description }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="check-box">
                                    <dx-check-box text=""></dx-check-box>
                                </div>
                                <div class="days-ago">
                                    <img src="./assets/common/icons/clock-circle.svg" class="img-responsive"><span *ngIf="entity?.CreationTime">{{ entity?.CreationTime | timeAgo }}</span>
                                    <span *ngIf="entity?.StartDate">{{ getDateWithTimezone(entity?.StartDate) | date : 'M/d, H:mm' }} - {{ getDateWithTimezone(entity?.EndDate) | date : 'M/d, H:mm' }}</span>
                                </div>
                                <div class="text-right pipeline-photo-wrap">
                                    <div [ngStyle]="{'background-image': entity?.PhotoPublicId ? 'url(' + getContactPhotoUrl(entity?.PhotoPublicId) + ')': 'none'}" class="img-responsive img-circle"></div>
                                </div>
                            </div>
                      </div>
                  </div>
            </ng-container>
        </div>
        <span class="load-more" [hidden]="stage.full || !stage?.entities?.length && !stage?.total" (click)="loadMore(i)"><img src="./assets/common/icons/arrow-down.svg"></span>
    </div>
</div>
