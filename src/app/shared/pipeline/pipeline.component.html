<div class="pipeline-wrapper" [ngClass]="{disabled: disabled}">
    <div *ngFor="let stage of stages; let i = index;" class="column column{{stage.index + ' ' + (stage.sortOrder && (stage.sortOrder > 0 ? 'positive': 'negative') || 'focused')}} color-{{stage.color}}">
        <div class="column-title">
            <span class="stageName">{{stage.name}}</span>
            <div>
                <span>
                    (<ng-container *ngIf="getStageSelectedEntitiesCount(stage) as selectedEntitiesCount">{{selectedEntitiesCount}} of </ng-container>{{stage?.total}})
                </span>
                <span *ngIf="stage.total && allStagesEntitiesTotal">
                    {{ getStageRatio(stage.total) }}
                </span>
            </div>
            <button id="{{'ident' + stage.id}}" class="edit-button">
                <img src="./assets/common/icons/edit-icon.svg" alt="Edit">
            </button>
            <dx-tooltip
                target="#{{'ident' + stage.id}}"
                (onShowing)="onTooltipShowing($event)"
                showEvent="click">
                <div *dxTemplate="let data = data of 'content'">
                    <ul class="stage-actions list-group">
                        <li class="list-group-item" [hidden]="stage['isFinal']">
                            <a (click)="$event.preventDefault()"> 
                                <dx-check-box
                                    [ngClass]="{ 'toggleAll': true, 'visible': allEntitiesAreSelected(stage) }"
                                    *ngIf="stage?.entities.length"
                                    width="210px"
                                    [text]="l('Sellect_All_Records')"
                                    [value]="allEntitiesAreSelected(stage)"
                                    (onValueChanged)="toggleAllEntitiesInStage($event, stage)">
                                </dx-check-box>
                            </a>
                        </li>
                        <li class="list-group-item" [hidden]="stage['isFinal']">
                            <a (click)="updateStage(stage, 'Add')"><i class="add-stage"></i> <span>{{l('Add_New_Stage')}}</span></a>
                        </li>
                        <li class="list-group-item">
                            <a (click)="updateStage(stage, 'Rename')"><i class="edit-stage"></i> <span>{{l('Rename_Stage')}}</span></a>
                        </li>
                        <li class="list-group-item" [hidden]="disallowDelete(stage)">
                            <a (click)="updateStage(stage, 'Merge')"><i class="delete-stage"></i> <span>{{l('Delete_Stage')}}</span></a>
                        </li>
                        <li class="list-group-item">
                            <a (click)="moveStage(stage)" [ngClass]="{disabled: disallowMove(stage)}"><i class="left-arrow"></i> <span>{{l('Move_Left_Stage')}}</span></a>
                            <a (click)="moveStage(stage, true)" [ngClass]="{disabled: disallowMove(stage, true)}"><span>{{l('Move_Right_Stage')}}</span> <i class="right-arrow"></i></a>
                        </li>
                    </ul>
                </div>
            </dx-tooltip>
        </div>
        <div class="column-items" [ngClass]="{'drag-allowed': stage?.dragAllowed}" [dragula]="dragulaName" [dragulaModel]="stage?.entities" accessKey="{{stage?.id}}" (click)="hideStageHighlighting()">
            <ng-container *ngFor="let entity of stage.entities">
                <div class="card" [ngClass]="{ locked: entity?.locked, selected: entity?.selected, compact: compactView }" [accessKey]="entity?.Id" (click)="onCardClickInternal(entity, $event)" [attr.stage]="entity?.StageId" count="">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="full-name">
                                    <span *ngIf="entity?.Name || entity?.Title || entity?.Email">{{ entity?.Name || entity?.Title || entity?.Email }}</span>
                                    <span *ngIf="!entity?.Name && !entity?.Title && !entity?.Email" class="no-name">{{ l('ClientNoName') }}</span>
                                <div class="company-name">
                                    <span>{{ entity?.CompanyName || entity?.Description }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="check-box">
                                <dx-check-box [value]="!!entity.selected"></dx-check-box>
                            </div>
                            <div class="days-ago">
                                <img src="./assets/common/icons/clock-circle.svg" class="img-responsive"><span *ngIf="entity?.CreationTime">{{ entity?.CreationTime | timeAgo }}</span>
                                <span *ngIf="entity?.StartDate">{{ getDateWithTimezone(entity?.StartDate) | date : 'M/d, H:mm' }} - {{ getDateWithTimezone(entity?.EndDate) | date : 'M/d, H:mm' }}</span>
                            </div>
                            <div class="text-right pipeline-photo-wrap">
                                <div [ngStyle]="{'background-image': entity?.PhotoPublicId ? 'url(' + getContactPhotoUrl(entity?.PhotoPublicId) + ')': 'none'}" class="img-responsive img-circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-container>
        </div>
        <span class="load-more" [hidden]="stage.full || !stage?.entities?.length && !stage?.total" (click)="loadMore(i)"><img src="./assets/common/icons/arrow-down.svg"></span>
    </div>
</div>
