<modal-dialog [title]=""
              [titleClearButton]="false"
              [buttons]="buttons"
              [editTitle]="false"
              class="email-template-dialog"
    (onContextItemChanged)="save()">   
    <ng-container headerContent>
        <div class="header">
            <div class="header-div">
                <div class="email-container">
                    <span class="icon">
                        <img src="assets/common/icons/group.png">
                    </span>
                    <span class="email-sub-txt"> {{title}}</span>
                </div>
                <div class="header-content">
                    {{data.subject}}
                </div>

            </div>
            <div class="right">
                <div class="actions">
                    <div style="display: flex; align-items: center;">
                        <span #tagsButton [class]="'tags-button id' + uniqId" *ngIf="tagsList.length">
                            <a (click)="tagsTooltipVisible = true">Add a Tag</a>
                        </span>
                        <dx-tooltip [width]="250"
                                    position="bottom" [(visible)]="tagsTooltipVisible"
                            [target]="'.tags-button.id' + uniqId">
                            <div *dxTemplate="let data of 'content'" class="tags-container">
                                <p class="tags-note">{{ls.l('EmailTemplate_SupportedTags')}}</p>
                                <dx-list height="calc(100% - 40px)" [selectionMode]="'single'" [dataSource]="tagsList"
                                    [itemTemplate]="'tagTemplate'" (onItemClick)="onTagClick($event)">
                                    <div *dxTemplate="let data of 'tagTemplate'" class="tags-list-item"
                                        [ngClass]="{disabled: !templateEditMode && !getTagValue(data)}">
                                        {{ getTagText(data) }}
                                    </div>
                                </dx-list>
                            </div>
                        </dx-tooltip>
                    </div>
                    <span class="tab new-email" (click)="showTabs('new-email')"
                        [class.selected-tab]="selectedTab === 'new-email'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="#003366" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#003366"></rect>
                            <path d="M22 6l-10 7L2 6" fill="none" stroke="#003366"></path>
                        </svg>
                        New Email
                    </span>
                    <span class="tab html-editor" (click)="showTabs('html-editor')"
                        [class.selected-tab]="selectedTab === 'html-editor'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#5A6782" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9" />
                            <path d="M16.5 3.5l4 4L7 21H3v-4L16.5 3.5z" />
                        </svg>

                        HTML Editor
                    </span>
                    <span class="tab templates" (click)="showTabs('template')"
                        [class.selected-tab]="selectedTab === 'template'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#5A6782" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7" rx="1" />
                            <rect x="14" y="3" width="7" height="7" rx="1" />
                            <rect x="3" y="14" width="7" height="7" rx="1" />
                            <rect x="14" y="14" width="7" height="7" rx="1" />
                        </svg>
                        Templates
                    </span>
                </div>
            </div>
        </div>
        <div class="buttons" *ngIf="!data.addMode && !isManageUnallowed && data.contact && onTemplateCreate.observers.length">
            <i class="create-template" [title]="ls.l('CreateTemplate')" (click)="createTemplate()"></i>
            <i *ngIf="data.templateId" [title]="ls.l('EditTemplate')" class="edit-template fa fa-pencil"
                (click)="editTemplate(data)"></i>
        </div> 

        <dx-context-menu *ngIf="addSendEmailMenuItems && addSendEmailMenuItems.length" [selectByClick]="true"
            selectionMode="single" [dataSource]="addSendEmailMenuItems"
            [position]="{ my: 'top right', at: 'bottom right' }" target="#saveTemplateOptions">
        </dx-context-menu>
        
    </ng-container>   
    <div class="form-content">
        <div class="row" style="width: 100%;">
            <div [ngClass]="showAIPrompt?'col-xl-9 col-lg-8':'col-md-12'">

                <dx-scroll-view showScrollbar="onHover" #scrollView>
                    <dx-validation-group>
                        <div class="row row-body-space" *ngIf="showNewEmailTab">
                            <div class="field-area from row--subdiv">
                                <div class="w-48">
                                    <label class="caption"
                                        [ngClass]="{disabled: templateEditMode}">{{ls.l('From')}}:</label>
                                    <dx-select-box *ngIf="fromDataSource?.length || templateEditMode; else configure"
                                        name="from"
                                        height="40px"
                                        placeholder=""
                                        [(value)]="data.emailSettingsSource"
                                        placeholder=""
                                        [(value)]="data.emailSettingsSource"
                                        valueExpr="emailSettingsSource"
                                        displayExpr="emailAddress"
                                        displayExpr="emailAddress"
                                        [dataSource]="fromDataSource"
                                        itemTemplate="itemTemplate"
                                        itemTemplate="itemTemplate"
                                        fieldTemplate="fieldTemplate"
                                        [disabled]="templateEditMode"
                                        [disabled]="templateEditMode"
                                        (onValueChanged)="onFromChanged($event)">
                                        <div *dxTemplate="let item of 'itemTemplate'" class="from-item-select-box" [title]="item?.emailAddress">
                                            {{ item?.emailAddress }}
                                        </div>
                                        <div *dxTemplate="let item of 'fieldTemplate'" class="from-field-select-box">
                                            <dx-text-box
                                                        height="40px"
                                                        [readOnly]="true"
                                                        [value]="item?.emailAddress"
                                                [hint]="item?.emailAddress">
                                            </dx-text-box>
                                        </div>
                                        <dx-validator>
                                            <dxi-validation-rule
                                                                type="required"
                                                [message]="ls.l('MailerSettingsAreNotConfigured', ls.l('SMTP'))">
                                            </dxi-validation-rule>
                                        </dx-validator>
                                    </dx-select-box>
                                    <ng-template #configure>
                                        <a class="config-link" (click)="close()" [routerLink]="'app/admin/settings'"
                                            [queryParams]="{tab: 'smtp'}" [ngClass]="{disabled: !isSettingsAllowed}">
                                            {{ls.l('MailerSettingsAreNotConfigured',ls.l('SMTP'))}}&nbsp;
                                        </a>
                                    </ng-template>
                                </div>
                                <div class="w-48">
                                    <label class="caption disabled">{{ls.l('ReplyTo')}}:</label>
                                    <dx-tag-box #ReplyToElement
                                                name="replyTo"
                                                noDataText=""
                                                placeholder=""
                                        [multiline]="false"
                                                [acceptCustomValue]="true"
                                                [(value)]="data.replyTo"
                                        [disabled]="true"
                                                (onKeyUp)="onKeyUp($event)"
                                        (onInitialized)="onTagBoxInitialized($event)"
                                        (onFocusOut)="emailInputFocusOut($event)"
                                        (onCustomItemCreating)="onCustomItemCreating($event)">
                                        <dx-validator>
                                            <dxi-validation-rule type="custom"
                                                [message]="ls.l('InvalidField', ls.l('ReplyTo'))"
                                                [validationCallback]="validateEmailList(ReplyToElement)">
                                            </dxi-validation-rule>
                                        </dx-validator>
                                    </dx-tag-box>
                                </div>
                            </div>

                            <div class="field-area">
                                <label class="caption" [ngClass]="{disabled: templateEditMode}">{{ls.l('To')}}:</label>
                                <dx-tag-box #ToElement
                                            name="to"
                                            width="calc(100% - 31px)"
                                            noDataText=""
                                            placeholder=""
                                    [dataSource]="data.suggestionEmails"
                                            [multiline]="false"
                                            [acceptCustomValue]="true"
                                    [(value)]="data.to"
                                            [disabled]="templateEditMode"
                                            (onKeyUp)="onKeyUp($event)"
                                    (onInitialized)="onTagBoxInitialized($event)"
                                            (onFocusOut)="emailInputFocusOut($event)"
                                    (onCustomItemCreating)="onCustomItemCreating($event)">
                                    <dx-validator>
                                        <dxi-validation-rule type="custom"
                                                            [message]="ls.l('InvalidField', ls.l('To'))"
                                            [validationCallback]="validateEmailList(ToElement)">
                                        </dxi-validation-rule>
                                        <dxi-validation-rule type="required"
                                            [message]="ls.l('RequiredField', ls.l('To'))"></dxi-validation-rule>
                                    </dx-validator>
                                </dx-tag-box>
                                <div class="bcc-links">
                                    <span (click)="showInputField(CCElement, 'showCC')" [ngClass]="{disabled: showCC}">{{ls.l('CC')}}</span>
                                    <span (click)="showInputField(BCCElement, 'showBCC')" [ngClass]="{disabled: showBCC}">{{ls.l('BCC')}}</span>
                                </div>
                            </div>

                            <div class="field-area from row--subdiv">
                                <div class="w-48" [hidden]="!showCC">
                                    <label class="caption">{{ls.l('CC')}}:</label>
                                    <dx-tag-box #CCElement
                                                name="cc"
                                                width="calc(100% - 35px)"
                                                placeholder=""
                                                noDataText=""
                                        [multiline]="false"
                                                [acceptCustomValue]="true"
                                                [(value)]="data.cc"
                                        (onKeyUp)="onKeyUp($event)"
                                                (onInitialized)="onTagBoxInitialized($event)"
                                        (onFocusOut)="emailInputFocusOut($event, true)"
                                        (onCustomItemCreating)="onCustomItemCreating($event)">
                                        <dx-validator>
                                            <dxi-validation-rule type="custom"
                                                                [message]="ls.l('InvalidField', ls.l('CC'))"
                                                [validationCallback]="validateEmailList(CCElement)">
                                            </dxi-validation-rule>
                                        </dx-validator>
                                    </dx-tag-box>
                                </div>

                                <div class="w-48" [hidden]="!showBCC">
                                    <label class="caption">{{ls.l('BCC')}}:</label>
                                    <dx-tag-box #BCCElement
                                                name="bcc"
                                                width="calc(100% - 46px)"
                                                noDataText=""
                                        placeholder=""
                                                [multiline]="false"
                                                [acceptCustomValue]="true"
                                                [(value)]="data.bcc"
                                        (onKeyUp)="onKeyUp($event)"
                                                (onInitialized)="onTagBoxInitialized($event)"
                                        (onFocusOut)="emailInputFocusOut($event, true)"
                                        (onCustomItemCreating)="onCustomItemCreating($event)">
                                        <dx-validator>
                                            <dxi-validation-rule type="custom"
                                                                [message]="ls.l('InvalidField', ls.l('BCC'))"
                                                [validationCallback]="validateEmailList(BCCElement)">
                                            </dxi-validation-rule>
                                        </dx-validator>
                                    </dx-tag-box>
                                </div>
                            </div>

                            <div class="field-area subject">
                                <label class="caption">{{ls.l('Subject')}}:</label>
                                <dx-text-box
                                    name="subject"
                                    width="calc(100% - 31px)"
                                    placeholder=""
                                    (onFocusOut)="previewInputFocusOut($event)"
                                    [(value)]="data.subject">
                                    <dx-validator>
                                        <dxi-validation-rule type="required"
                                            [message]="ls.l('RequiredField', ls.l('Subject'))"></dxi-validation-rule>
                                    </dx-validator>
                                </dx-text-box>
                                <div class="bcc-links">
                                    <span (click)="showInputField(PreviewTextElement, 'showPreview')"
                                        [ngClass]="{disabled: showPreview}">Preview</span>
                                </div>
                            </div>

                            <div class="field-area preview-text" [hidden]="!showPreview">
                                <label class="caption">{{ls.l('PreviewText')}}:</label>
                                <dx-text-box #PreviewTextElement
                                            name="previewText"
                                            width="calc(100% - 102px)"
                                            height="40px"
                                    placeholder=""
                                            [(value)]="data.previewText">
                                </dx-text-box>
                            </div>

                            <div class="field-area ckeditor bt-none">
                                <ckeditor *ngIf="ckConfig.height && templateLoaded" [config]="ckConfig" [(data)]="data.body"
                                    (ready)="onCKReady($event)" (change)="updateDataLength()"></ckeditor>

                            </div>

                            <div class="attachment-div">
                                <div class="attachment-field-area">
                                    <ngx-file-drop accept="*.*" (onFileDrop)="addAttachments($event)">
                                        <ng-template ngx-file-drop-content-tmp let-openFileSelector="openFileSelector">
                                            <a href="javascript:void(0);" class="attach-link" (click)="openDocuments()">
                                                <img src="assets/common/icons/attach.svg">{{ ls.l('Add attachment') }}
                                            </a>
                                            <dx-check-box *ngIf="!templateEditMode && attachments && attachments.length"
                                                class="saveToDocs" [(value)]="data.saveAttachmentsToDocuments"
                                                [rtlEnabled]="true" [text]="ls.l('Save to Documents')">
                                            </dx-check-box>
                                        </ng-template>
                                    </ngx-file-drop>
                                </div>
                                <div class="attachment-field-area bottom-text-ste">Insert Widget</div>
                                <div class="attachment-field-area bottom-text-ste">
                                    {{ charCount ? charCount :0  }} chars
                                </div>
                            </div>

                            <div class="field-area attachments">
                                <div *ngFor="let attachment of attachments; let i = index" class="attachment"
                                    [ngClass]="{'progress': !!attachment.loader}"
                                    [ngStyle]="{'background-size': (attachment.progress || 0) + '%'}">
                                    <a target="_blank" [download]="attachment.name" [href]="attachment.url"
                                        (click)="attachmentClick($event, attachment)"
                                        class="name">{{attachment.name}}</a>&nbsp;<span class="size">
                                        ({{attachment.size |filesize}})
                                    </span><i (click)="removeAttachment(attachment, i)" aria-hidden="true"
                                        class="delete fa fa-times"></i>
                                </div>
                            </div>

                            <ng-content *ngIf="data.templateType" select="[templateSettings]"></ng-content>
                        </div>

                        <div class="row row-body-space editor-color" *ngIf="showHtmlEditor" >   
                            <form [formGroup]="templateForm" class="editor-form">
                                <ngx-monaco-editor
                                #editor
                                [options]="editorOptions"
                                formControlName="emailContentBodyTemplate" class="editor-container">
                                </ngx-monaco-editor>
                            </form>                       
                        </div>   

                        <div class="row row-body-space template-container " *ngIf="showTemplate">
                            <div class="d-flex flex-column template-header">
                                <h5>My Email Templates Library</h5>
                                <span>
                                    Choose a template or start with a blank email to your own HTML
                                </span>

                            </div>
                            <div class="row">
                                <div class="col-md-3 left-template-div"  >
                                    <dx-button
                                        stylingMode="outlined"
                                        text="+ Create New Template"
                                        type="normal"
                                        (click)="createTemplate()"
                                        class="create-mail-template-btn"
                                    >
                                    </dx-button>
                                    <dx-text-box 
                                        mode="search"
                                        height="40px"
                                        [placeholder]="placeholderText"
                                        [elementAttr]="{ class: 'template-search-box' }"
                                        (onFocusIn)="onFocusIn()"
                                        (onFocusOut)="onFocusOut()"
                                    >
                                    
                                    </dx-text-box>
                                    <div *ngFor="let template of templates$ | async; let templateIndex = index" class="template-item" [class.active]="template.id === curTemplateId">
                                        <h5 (click)="viewDetailTemplate($event, template)">
                                            {{template.name}}
                                        </h5>
                                        <!-- <span>
                                            {{template.previewText}}
                                        </span> -->
                                        <div class="template-item-action-btns">
                                            <dx-button
                                                stylingMode="outlined"
                                                icon="edit"
                                                type="default"
                                                [width]="24"
                                                (onClick)="editTemplate($event, template.id)"
                                            >
                                            </dx-button>
                                            <dx-button
                                                stylingMode="outlined"
                                                icon="trash"
                                                type="danger"
                                                [width]="24"
                                                (onClick)="deleteTemplate($event, template)"
                                            >
                                            </dx-button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-9 template-detail-preview">
                                    <div class="template-preview-item" style="display:flex; justify-content: space-between;">
                                        <div class="d-flex">
                                            <label class="label">Title: </label>  
                                            <h5> {{ curTemplateTitle }}</h5>
                                        </div>
                                        <dx-button
                                        stylingMode="outlined"
                                        text="Compose mail with this template"
                                        type="normal"
                                        [disabled]="templateData.subject == ''"
                                        (click)="setTemplate()"
                                        class="set-template-btn"
                                        >
                                        </dx-button>
                                    </div>
                                    <div class="template-preview-item"> 
                                        <label class="label">
                                            Subject:
                                        </label> 
                                        <h6> {{templateData.subject}}</h6></div>
                                    <div class="template-preview-item">
                                        <label class="label">
                                            Preview Text:
                                        </label>
                                        <h6>{{templateData.previewText}}</h6> 
                                    </div>
                                    <div class="template-preview-content">
                                        <ckeditor *ngIf="ckConfig.height && templateLoaded" [config]="ckConfig" [(data)]="templateData.body"
                                        ></ckeditor>
                                    </div>
                                    
                                </div>

                            </div>
                        </div>
                    </dx-validation-group>
                </dx-scroll-view>
            </div>
            <div [ngClass]="showAIPrompt?'col-xl-3 col-lg-4 container':'hidden'" *ngIf="showAIPrompt">
                    <div class="prompt-header d-flex justify-content-between align-items-center"
                        style="margin-bottom: 20px;">
                        <h5 class="your-prompt-title">
                            <img src="./assets/common/icons/AI.png" class="img" />
                            <img src="./assets/common/icons/AI.png" class="img" />
                            Your AI Prompt
                        </h5>
                       
    
                        <div style="display: flex; align-items: center;">
                            <h5 class="your-prompt-title prompt-library-title" id="promptLibraryToggle"
                                (click)="propmtTooltipVisible = true" [class]="'prompt-liabrary-button id' + uniqId">
                                Your Prompt Library
                                <img class="img" src="./assets/common/icons/down-arrow.png" />
                            </h5>
    
                            <dx-tooltip [width]="300" [position]="'bottom'" [(visible)]="propmtTooltipVisible"
                                            [target]="'.prompt-liabrary-button.id' + uniqId">
                                <div *dxTemplate="let data of 'content'" class="tags-container text-left p-2">
                                    <div *ngFor="let group of groupedPromptLibrary; let groupIndex = index">
                                        <!-- Group Title with toggle -->
                                        <div class="group-header" (click)="toggleGroup(group)">
                                            <strong>{{ group.category }}</strong>
                                            <span>{{ group.expanded ? '▲' : '▼' }}</span>
                                        </div>
    
                                        <!-- Prompt list inside group -->
                                        <div class="group-items" *ngIf="group.expanded">
                                            <div *ngFor="let item of group.prompts; let itemIndex = index"
                                                class="tags-list-item"
                                                (click)="selectedPromptItem(item, groupIndex, itemIndex)">
                                                <div class="prompt-title">{{ item.title }}</div>
                                                <div class="prompt-subtext">{{ item.subtext }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </dx-tooltip>
    
                        </div>
    
                    </div>
    
                    <dx-scroll-view showScrollbar="onHover" #scrollAIView>
                        <div class="content-container" *ngIf="!showAIOption">
                            <div class="html-container-div" contenteditable="true" dir="ltr" lang="en" autocomplete="off" autocorrect="off"
                                autocapitalize="off" spellcheck="false" (input)="onContentChange($event)"
                                (paste)="onPaste($event)" #contentEditableDiv>
                                <p>
                                    Consectetur adipiscing elit, <strong>sed do eiusmod</strong> tempor incididunt
                                    ut
                                    labore
                                    et dolore.
                                </p>
                                <ul class="styled-list">
                                    <li>
                                        <strong>Customer Name and Business:</strong>
                                        <div class="list-content">Adam Smith, <br> Samsung International LLC</div>
                                    </li>
                                    <li>
                                        <strong>Purpose of the email:</strong>
                                        <div class="list-content">
                                            voluptatem accusantium doloremque laudantium, totam
                                            rem
                                            aperiam
                                        </div>
                                    </li>
                                    <li>
                                        <strong>Prior communications:</strong>
                                        <div class="list-content">
                                            Ab illo inventore veritatis et quasi architecto beatae
                                            vitae dicta sunt explicabo.
                                        </div>
                                    </li>
                                    <li>
                                        <strong>Tone of the email:</strong>
                                        <div class="list-content">
                                            Nemo enim ipsam voluptatem quia voluptas sit
                                            aspernatur
                                            aut odit aut fugit
                                        </div>
                                    </li>
                                    <li>
                                        <strong>Styling Preferences:</strong>
                                        <div class="list-content">
                                            Sed quia consequuntur magni dolores eos qui ratione
                                            voluptatem sequi nesciunt.
                                        </div>
                                    </li>
                                    <li>
                                        <strong>Specific details to include:</strong>
                                        <div class="list-content">
                                            Neque porro quisquam est, qui dolorem ipsum quia dolor
                                            sit
                                            amet, consectetur.
                                        </div>
                                    </li>
                                </ul>
                                <div>
                                    <strong>The email must include:</strong>
                                    <div>1. Numquam eius modi tempora incidunt</div>
                                    <div>2. Labore et dolore magnam aliquam</div>
                                    <div>3. Ut enim ad minima veniam, quis nostrum.</div>
                                </div>
                            </div>
                        </div>
                    </dx-scroll-view>
    
                    <div class="prompt-footer">
                        <div style="display: flex; align-items: center;">
                            <h5 class="gpt-model-toggle" id="aiModelToggle"
                                (click)="aiTooltipVisible = true" [class]="'ai-model-button id' + uniqId">
                                <img class="img" src="./assets/common/icons/openai-white.png" />
                            </h5>
                            <dx-tooltip [width]="250" [position]="'bottom'" [(visible)]="aiTooltipVisible"
                                [target]="'.ai-model-button.id' + uniqId">
                                <div *dxTemplate="let data of 'content'" class="tags-container">
                                    <dx-list height="calc(100% - 40px)" [selectionMode]="'single'" [dataSource]="aiModels"
                                        [itemTemplate]="'aiTemplate'" (onItemClick)="selectedAIItem($event)">
                                        <div *dxTemplate="let data of 'aiTemplate'" class="tags-list-item">
                                            <img [src]="'./assets/common/icons/' + data.icon" alt="icon"
                                                class="ai-model-icon" />
                                            {{ data.name }}
                                        </div>
                                    </dx-list>
                                </div>
                            </dx-tooltip>
                        </div>
                        <button class="button-generate-ai-message" (click)="generateAIMessage()">
                            {{processing ? 'Generating..': 'Generate AI Message' }}
                        </button>
                        <button class="cancel-button" (click)="cancelAIMessage()">Cancel</button>
                    </div>
    
                    <!-- <div class="left-buttons">
                        <div class="ai-genrate-btn" (click)="getChatGptResponse(contentEditableDiv)">
                            <span>
                                {{processing ? 'Generating..' :'Write with AI'}}
                            </span>
                        </div>
                    </div>  -->
            </div>
        </div>
        <div class="bank-decode-wrapper" *ngIf="!templateEditMode && bankCodeEnabled">
            <bank-code-decode [content]="data.body" [source]="'CRMEmail'" (onDecodeStart)="startLoading()"
                (onDecodeFinish)="finishLoading()"></bank-code-decode>
        </div>
    </div>  
</modal-dialog>
