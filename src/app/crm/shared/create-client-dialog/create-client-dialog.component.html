<dx-context-menu
    [selectByClick]="true"
    [selectionMode]="'single'"
    [dataSource]="saveContextMenuItems"
    [position]="{ my: 'top right', at: 'bottom right' }"
    (onSelectionChanged)="onSaveOptionSelectionChanged($event)"
    target="#{{saveButtonId}}">
</dx-context-menu>
<crm-static-list #stagesList
                 [width]="'210px'"
                 [selectedKeys]="[this.stageId]"
                 [showConfirmation]="false"
                 [selectedItems]=""
                 [hideButtons]="true"
                 [highlightSelected]="true"
                 [targetSelector]="'[accessKey=CreateLeadStage]'"
                 (onItemSelected)="onStagesChanged($event)"
                 [showTitle]="false"
                 [list]="stages"
                 [funnelStyling]="true"
                 [disableHindmost]="true">
</crm-static-list>
<crm-rating [targetSelector]="'[accesskey=\'ClientRating\']'" [hideButtons]="true" (onValueChanged)="onRatingchanged($event)"></crm-rating>
<crm-types-list [targetSelector]="'[accesskey=\'PartnerTypesList\']'" [hideButtons]="true"
                (onSelectedChanged)="onPartnerTypeChanged($event)"></crm-types-list>
<crm-tags-list [targetSelector]="'[accesskey=\'ClientTags\']'" [hideButtons]="true" (onSelectedChanged)="onTagsSelected($event)"></crm-tags-list>
<crm-lists-list [targetSelector]="'[accesskey=\'ClientLists\']'" [hideButtons]="true" (onSelectionChanged)="onListsSelected($event)"></crm-lists-list>
<crm-user-assignment-list
    [targetSelector]="'[accesskey=\'ClientAssign\']'"
    [permissionKey]="getAssignmentsPermissinKey()"
    [selectedItemKey]="currentUserId"
    [hideButtons]="true"
    (onSelectionChanged)="onUserAssignmentChanged($event)">
</crm-user-assignment-list>

<modal-dialog (onTitleKeyUp)="onFullNameKeyUp($event)">
    <div class="photo-area" (click)="showUploadPhoto($event)"
        [ngStyle]="{'background-image': photoOriginalData ? 'url(' + photoOriginalData + ')': ''}"></div>

    <div class="toolbar-wraper">
        <app-toolbar [config]="toolbarConfig" width="700px"></app-toolbar>
    </div>   
    <div *ngIf="similarCustomers?.length" class="similar-clients-message" (click)="showSimilarCustomers($event)">{{l('SimilarRecordsFound')}}</div>
    <div class="form-content">
        <dx-scroll-view showScrollbar="onHover">
            <div class="field">
                <label class="company-label">{{l('Company')}}</label>
                <dx-text-box #companyComponent
                             name="company"
                             [placeholder]="l('CompanyName')"
                             [width]="'270px'"
                             [valueChangeEvent]="'keyup'"
                             (onKeyUp)="onCompanyKeyUp($event)"
                             [(value)]="company">
                </dx-text-box>
                <dx-text-box #titleComponent
                             name="title"
                             [placeholder]="l('Job title')"
                             [valueChangeEvent]="'keyup'"
                             [width]="'270px'"
                             [(value)]="title">
                </dx-text-box>
                <span [class]="(company || title) && 'clear-contact' || 'hidden'" (click)="company = title = ''"><i class="minus-icon"></i></span>
            </div>
            <dx-validation-group (onInitialized)="initValidationGroup($event, 'emailValidators')">                
                <div class="field email">
                    <label class="email-label">{{l('Email')}}</label>
                    <div *ngFor="let email of contacts.emails; index as i" class="editable-item" [ngClass]="{'first-item': !i}">
                        <div class="drop-down-box-wrapper">
                            <dx-select-box
                                width="340px"
                                name="emailType"
                                placeholder="{{l('Type')}}"
                                [dataSource]="emailTypes"
                                displayExpr="name"
                                valueExpr="id"
                                [(value)]="email.type"
                                [itemTemplate]="'emailTypeItemTemplate'">
                                <div *dxTemplate="let data of 'emailTypeItemTemplate'">
                                    <div class="usage-type-item" title="{{l('ContactInformation_EmailTypeTooltip_' + data.id)}}"><span>{{data.name}}</span><span>{{l('ContactInformation_EmailTypeTooltip_' + data.id)}}</span></div>
                                </div>
                            </dx-select-box>
                        </div>
                        <dx-text-box #emailComponent
                                     name="email"
                                     [width]="'410px'"
                                     [(value)]="email.email"
                                     (onValueChanged)="onFieldChanged($event, 'emails', i)"
                                     (onInitialized)="onComponentInitialized($event, 'emails')">
                            <dx-validator>
                                <dxi-validation-rule type="pattern" [pattern]="emailRegEx" message="{{l('EmailIsNotValid')}}."></dxi-validation-rule>
                            </dx-validator>
                        </dx-text-box>
                        <span [class]="(i || email.email) && 'clear-contact' || 'hidden'" (click)="emptyOrRemoveInput('emails', i)"><i class="minus-icon"></i></span>
                    </div>
                    <div class="add-new-button" [ngClass]="{disabled: !addButtonVisible['emails']}"><span (click)="addNewContact('emails')">{{l('+ Add email')}}</span></div>
                </div>
            </dx-validation-group>
            <dx-validation-group (onInitialized)="initValidationGroup($event, 'phoneValidators')">
                <div class="field phone H">
                    <label class="phone-label">{{l('Phone')}}</label>
                    <div *ngFor="let phone of contacts.phones; index as i" class="editable-item" [ngClass]="{'first-item': !i}">
                        <div class="drop-down-box-wrapper">
                            <dx-select-box
                                width="370px"
                                name="phoneType"
                                placeholder="{{l('Type')}}"
                                [dataSource]="phoneTypes"
                                displayExpr="name"
                                valueExpr="id"
                                [value]="phone.type"
                                [itemTemplate]="'phoneTypeItemTemplate'">
                                <div *dxTemplate="let data of 'phoneTypeItemTemplate'">
                                    <div class="usage-type-item" title="{{l('ContactInformation_PhoneTypeTooltip_' + data.id)}}"><span style="width: 100px;">{{data.name}}</span><span>{{l('ContactInformation_PhoneTypeTooltip_' + data.id)}}</span></div>
                                </div>
                            </dx-select-box>
                        </div>
                        <country-phone-number #countryPhoneNumber
                            [(phoneNumber)]="phone.number"
                            [required]="false"
                            (phoneNumberChange)="onPhoneChanged(countryPhoneNumber)"
                            (onInitialized)="onPhoneComponentInitialized($event)">
                        </country-phone-number>
                        <dx-number-box
                            class="tabular"
                            name="phoneExtension"
                            width="50px"
                            [inputAttr]="{maxlength: 5}"
                            [placeholder]="l('Ext')"
                            [(value)]="phone.ext">
                            <dx-validator>
                                <dxi-validation-rule type="stringLength" [max]="5" message="{{l('PhoneExtensionExceedsMaxSize')}}."></dxi-validation-rule>
                            </dx-validator>
                        </dx-number-box>
                        <span [class]="(i || phone.number || phone.ext) && 'clear-contact' || 'hidden'" (click)="emptyOrRemoveInput('phones', i)"><i class="minus-icon"></i></span>
                    </div>
                    <div class="add-new-button" [ngClass]="{disabled: !addButtonVisible['phones']}"><span (click)="addNewContact('phones')">{{l('+ Add phone')}}</span></div>
                </div>
            </dx-validation-group>
            <dx-validation-group (onInitialized)="initValidationGroup($event, 'linkValidators')">
                <div class="field">
                    <label class="link-label">{{l('Links')}}</label>
                    <div *ngFor="let link of contacts.links; index as i" class="editable-item" [ngClass]="{'first-item': !i}">
                        <div class="drop-down-box-wrapper">
                            <dx-drop-down-box
                                width="330px"
                                name="linkType"
                                placeholder="{{l('Type')}}"
                                displayExpr="name"
                                valueExpr="id"
                                accessKey="link-type-dialog"
                                [value]="link.type"
                                [dataSource]="linkTypes">
                                <div *dxTemplate="let contentData of 'content'" style="display:flex;">
                                    <div>
                                        <mat-sidenav mode="side" opened="true" position="start" style="height:50px;width:100%;">
                                            <mat-tab-group (selectedTabChange)="link.isCompany = !!$event.index">
                                                <mat-tab label="{{l('Person')}}"></mat-tab>
                                                <mat-tab label="{{l('Company')}}"></mat-tab>
                                            </mat-tab-group>
                                        </mat-sidenav>
                                        <dx-list
                                            displayExpr="name"
                                            keyExpr="id"
                                            [dataSource]="linkTypes"
                                            selectionMode="single"
                                            [pageLoadMode]="'scrollBottom'"
                                            (onSelectionChanged)="link.type = $event.addedItems[0].id"
                                            [itemTemplate]="'linkItemTemplate'">
                                            <div *dxTemplate="let data of 'linkItemTemplate'">
                                                <span><img src="./assets/common/icons/social/{{data.uri}}.svg"
                                                           onError="this.src='./assets/common/icons/social/OtherLink.svg';"
                                                           width="25px" height="25px">&nbsp;&nbsp;&nbsp;{{data.name}}</span>
                                            </div>
                                        </dx-list>
                                    </div>
                                </div>
                            </dx-drop-down-box>
                        </div>
                        <dx-text-box #linksComponent
                                     name="link"
                                     [width]="'410px'"
                                     [(value)]="link.url"                      
                                     (onValueChanged)="onFieldChanged($event, 'links', i)"
                                     (onInitialized)="onComponentInitialized($event, 'links')">
                            <dx-validator>
                                <dxi-validation-rule type="pattern" [pattern]="urlRegEx" message="{{l('LinkIsNotValid')}}."></dxi-validation-rule>
                            </dx-validator>
                        </dx-text-box>
                        <span [class]="(i || link.url) && 'clear-contact' || 'hidden'" (click)="emptyOrRemoveInput('links', i)"><i class="minus-icon"></i></span>
                    </div>
                    <div class="add-new-button" [ngClass]="{disabled: !addButtonVisible['links']}"><span (click)="addNewContact('links')">{{l('+ Add link')}}</span></div>
                </div>
            </dx-validation-group>
            <dx-validation-group>
                <div *ngFor="let address of contacts.addresses; index as i" class="editable-item">
                    <div class="field addr {{i ? 'padding-right': ''}}">
                        <label [hidden]="i" class="address-label">{{l('Address')}}</label>
                        <div class="drop-down-box-wrapper">
                            <dx-select-box
                                width="380px"
                                name="addressType"
                                placeholder="{{l('Type')}}"
                                [dataSource]="addressTypes"
                                displayExpr="name"
                                valueExpr="id"
                                [(value)]="address['type']"
                                [itemTemplate]="'addressTypeItemTemplate'">
                                <div *dxTemplate="let data of 'addressTypeItemTemplate'">
                                    <div class="usage-type-item" title="{{l('ContactInformation_AddressTypeTooltip_' + data.id)}}"><span>{{data.name}}</span><span>{{l('ContactInformation_AddressTypeTooltip_' + data.id)}}</span></div>
                                </div>
                            </dx-select-box>
                        </div>
                        <input *ngIf="!googleAutoComplete" type="text"
                               name="Address"
                               placeholder="{{l('Street')}}"
                               [(ngModel)]="address['address']"
                               class="dx-texteditor-input"/>
                        <input *ngIf="googleAutoComplete" type="text"
                               name="Address"
                               placeholder="{{l('Street')}}"
                               [(ngModel)]="address['address']"
                               class="dx-texteditor-input"
                               (country)="updateCountryInfo($event, i)"
                               (street_number)="address['streetNumber']=$event"
                               (street)="address['streetAddress']=$event"
                               (city)="address['city']=$event"
                               (state)="address['state']=$event"
                               (postal_code)="address['zip']=$event"
                               (setAddress)="onAddressChanged($event, i)"
                               angularGooglePlace/>
                        <span [class]="(i || address.address || address.city || address.state || address.zip || address.country) && 'clear-contact' || 'hidden'" (click)="emptyOrRemoveInput('addresses', i)"><i class="minus-icon"></i></span>
                    </div>
                    <div class="field addr padding-right">
                        <dx-text-box
                            name="city"
                            maxLength="50"
                            placeholder="{{l('City')}}"
                            [width]="'270px'"
                            [(value)]="address['city']"
                            [valueChangeEvent]="'keyup'"
                            (onValueChanged)="checkAddressControls()">
                        </dx-text-box>
                        <dx-select-box
                            [dataSource]="states[i]"
                            displayExpr="name"
                            valueExpr="name"
                            name="state"
                            placeholder="{{l('State')}}"
                            [width]="'270px'"
                            [searchEnabled]="true"
                            [(value)]="address['state']"
                            (onValueChanged)="checkAddressControls()">
                        </dx-select-box>
                    </div>
                    <div class="field addr padding-right" style="padding-bottom: 10px;">
                        <dx-text-box
                            maxLength="10"
                            placeholder="{{l('Zip')}}"
                            [width]="'270px'"
                            [(value)]="address['zip']"
                            [valueChangeEvent]="'keyup'"
                            (onValueChanged)="checkAddressControls()">
                        </dx-text-box>
                        <dx-select-box
                            [dataSource]="countries"
                            displayExpr="name"
                            valueExpr="name"
                            name="country"
                            placeholder="{{l('Country')}}"
                            [width]="'270px'"
                            [searchEnabled]="true"
                            [(value)]="address['country']"
                            (onValueChanged)="onCountryChange($event, i)">
                        </dx-select-box>
                    </div>
                </div>
                <div class="add-new-button" [ngClass]="{disabled: !addButtonVisible['addresses']}"><span (click)="addNewContact('addresses')">{{l('+ Add address')}}</span></div>
            </dx-validation-group>

            <div class="field notes">
                <label class="notes-label">{{l('Notes')}}</label>
                <dx-text-area
                    name="comment"
                    [width]="'570px'"
                    [height]="'100px'"
                    (onKeyUp)="onCommentKeyUp($event)"
                    [(value)]="notes">
                </dx-text-area>
                <span class="{{notes && 'clear-contact' || 'hidden'}}" (click)="notes = ''"><i class="minus-icon"></i></span>
            </div>            
        </dx-scroll-view>
    </div>
</modal-dialog>