<div>
    <app-headline [names]="[ l('Tasks') ]"
                  icon="docs"
                  [showCompactView]="pipelineService.compactView$ | async"
                  [buttons]="headlineButtons"
                  [showToggleToolbarButton]="true"
                  [showReloadButton]="ui.showReload"
                  [showToggleCompactViewButton]="dataLayoutType === layoutTypes.Pipeline"
                  [showToggleFullScreenButton]="true"
                  [showTotalCount]="true"
                  [totalCount]="totalCount"
                  (onToggleToolbar)="toggleToolbar()"
                  (onToggleCompactView)="toggleCompactView()"
                  (onToggleFullScreen)="toggleFullScreen()"
                  (onReload)="refresh()">
        <import-progress-bar></import-progress-bar>
    </app-headline>
    <app-toolbar [config]="toolbarConfig" [hidden]="appService.toolbarIsHidden$ | async"></app-toolbar>
    <div [hidden]="showPipeline" class="main-wrapper portlet light no-padding margin-bottom-0">
        <div class="portlet-body">
            <dx-scheduler
                class="main-component-view"
                [height]="schedulerHeight$ | async"
                [dataSource]="dataSource"
                [views]="['day', 'week', 'month', 'agenda']"
                [resources]="resources"
                [timeZone]="timezone"
                [(currentView)]="scheduleView"
                [(currentDate)]="scheduleDate"
                [showAllDayPanel]="true"
                [cellDuration]="cellDuration"
                [textExpr]="activityFields.Title"
                [allDayExpr]="activityFields.AllDay"
                [startDateExpr]="activityFields.StartDate"
                [endDateExpr]="activityFields.EndDate"
                [remoteFiltering]="false"
                [descriptionExpr]="activityFields.Description"
                startDateTimeZoneExpr="fieldTimeZone"
                endDateTimeZoneExpr="fieldTimeZone"
                appointmentTemplate="appointmentTemplate"
                appointmentTooltipTemplate="appointmentTooltipTemplate"
                (onAppointmentUpdating)="onAppointmentUpdating($event)"
                (onAppointmentFormOpening)="onAppointmentFormCreated($event)">
                <div *dxTemplate="let appointment of 'appointmentTemplate'">
                  <div class="showtime-preview">
                    <div>{{ appointment.targetedAppointmentData.Title }}</div>
                    <div class="dropdown-appointment-dates" *ngIf="currentView == 'agenda'">
                        {{(getDateWithTimezone(appointment?.appointmentData?.StartDate) | date:'shortTime') + ' - ' + (getDateWithTimezone(appointment?.appointmentData?.EndDate) | date:'shortTime')}}
                    </div>
                  </div>
                </div>
                <div *dxTemplate="let appointment of 'appointmentTooltipTemplate'">
                    <div class="appointment-content">
                        <div class="appointment-badge" [ngStyle]="{ backgroundColor: appointment?.appointmentData?.Type == activityTypes.Event ? '#727bd2': '#32c9ed' }">{{appointment?.appointmentData?.Type[0]}}</div>
                        <div class="appointment-text">{{appointment?.appointmentData?.Title}}</div>
                        <div class="appointment-dates">
                            {{(getDateWithTimezone(appointment?.appointmentData?.StartDate) | date : 'MMM d') + ' , ' + (getDateWithTimezone(appointment?.appointmentData?.StartDate) | date:'shortTime') + ' - ' + (getDateWithTimezone(appointment?.appointmentData?.EndDate) | date:'shortTime')}}
                        </div>
                        <dx-button class="delete-appointment" icon="trash" (onClick)="deleteAppointment($event.event, appointment.appointmentData)"></dx-button>
                    </div>
                </div>
            </dx-scheduler>
        </div>
    </div>

    <div [hidden]="!showPipeline" class="portlet light no-padding margin-bottom-0">
        <div class="portlet-body">
            <div class="funnel-wrapper main-component-view">
                <app-pipeline
                    totalsURI="ActivityCount"
                    [source]="pipelineDataSource"
                    dragulaName="activityStages"
                    [selectFields]="['Id', 'Title', 'Description', 'StartDate', 'EndDate']"
                    [pipelinePurposeId]="pipelinePurposeId"
                    [(selectedEntities)]="selectedActivities"
                    (onCardClick)="showActivityDialog($event)"
                    (onTotalChange)="updateTotalCount($event)">
                    Loading...
                </app-pipeline>
            </div>
        </div>
    </div>

    <dx-popover target="#calendar-navigator-body"
                position="bottom"
                [(visible)]="popoverCalendarVisible">
        <div *dxTemplate="let data of 'content'">
            <dx-calendar
                [(value)]="currentDate"
                (onValueChanged) = "currentDateChange()"
                (onInitialized) = "calendarInitialized = true">
            </dx-calendar>
        </div>
    </dx-popover>
</div>
