<modal-dialog [title]="title"
              [buttons]="buttons"
              [editTitle]="!data.readOnly"
              [titleClearButton]="true"
              [placeholder]="ls.l('Title')"
              (onTitleKeyUp)="titleChanged($event)"
              (onContextItemChanged)="onSaveOptionSelectionChanged()">
    <dx-scroll-view showScrollbar="onHover">
        <app-toolbar [isDisabled]="!!data.readOnly" [config]="toolbarConfig"></app-toolbar>
        <app-static-list #stagesList
                         [width]="'210px'"
                         [selectedKeys]="[appointment.StageId]"
                         [showConfirmation]="false"
                         [selectedItems]=""
                         [hideButtons]="true"
                         [highlightSelected]="true"
                         [targetSelector]="'[accessKey=ActivityStage]'"
                         (onItemSelected)="onStagesChanged($event)"
                         [showTitle]="false"
                         [funnelStyling]="true"
                         [list]="data.stages">
        </app-static-list>
        <user-assignment-list [multiSelection]="true"
                              [targetSelector]="'[accesskey=UserAssign]'"
                              [proxyService]="activityProxy"
                              [(selectedItemKey)]="appointment.AssignedUserIds"
                              [hideButtons]="true"
                              [selectedKeys]="[appointment.Id]"
                              [permissionKey]="permissions.CRMManageEventsAssignments"
                              (onSelectionChanged)="onUserAssignmentChanged($event)"
                              [assignedUsersSelector]="assignedUsersSelector">
        </user-assignment-list>

        <app-static-list #contactsList
                         [width]="'330px'"
                         [height]="440"
                         [targetSelector]="'[accesskey=\'ContactsList\']'"
                         [title]="ls.l('Contacts')"
                         [showConfirmation]="false"
                         [highlightSelected]="true"
                         [selectedKeys]="[appointment.ContactId]"
                         [searchEnabled]="true"
                         [customSearchEnabled]="true"
                         (onItemSelected)="onContactSelected($event)"
                         (onListFiltered)="onListFiltered($event)"
                         [list]="contacts">
        </app-static-list>

        <app-static-list [hideButtons]="true"
                         [bulkUpdatePermissionKey]="permissions.CRMBulkUpdates">
        </app-static-list>

        <div class="tab-content">
            <dx-validation-group (onInitialized)="initDateValidationGroup($event)">
                <div class="field date-selector">
                    <div class="row">
                        <label class="col-12">{{ls.l('Date')}}</label>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-4 align-self-center">
                            <ng-container *ngFor="let type of ['date', 'datetime']">
                                <dx-date-box #startDateRef
                                             maxLength="10"
                                             [disabled]="data.readOnly"
                                             *ngIf="type == (isAllDay ? 'date' : 'datetime')"
                                             [type]="type"
                                             [max]="getEndDayTime(endDate)"
                                             (onFocusIn)="openCalendar($event)"
                                             (onClosed)="removeFocusFromElement($event)"
                                             [(value)]="startDate">
                                    <dx-validator>
                                        <dxi-validation-rule type="required"
                                            message="{{ls.l('StartDateIsRequired')}}."></dxi-validation-rule>
                                    </dx-validator>
                                </dx-date-box>
                            </ng-container>
                        </div>

                        <div class="col-1 align-self-center">
                            <i class="fa fa-arrow-right"></i>
                        </div>

                        <div class="col-4 align-self-center">
                            <ng-container *ngFor="let type of ['date', 'datetime']">
                                <dx-date-box #endDateRef
                                             *ngIf="type == (isAllDay ? 'date' : 'datetime')"
                                             maxLength="10"
                                             [type]="type"
                                             [disabled]="data.readOnly"
                                             [min]="getStartDayTime(startDate)"
                                             (onFocusIn)="openCalendar($event)"
                                             (onClosed)="removeFocusFromElement($event)"
                                             [(value)]="endDate">
                                    <dx-validator>
                                        <dxi-validation-rule type="required"
                                            message="{{ls.l('EndDateIsRequired')}}."></dxi-validation-rule>
                                    </dx-validator>
                                </dx-date-box>
                            </ng-container>
                        </div>

                        <div class="col-3 align-self-center text-right">
                            <div class="dx-field all-day-checkbox">
                                <div class="dx-field-label">{{ls.l('All day')}}</div>
                                <div class="dx-field-value">
                                    <dx-check-box [readOnly]="data.readOnly" [(value)]="isAllDay"></dx-check-box>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </dx-validation-group>
            <div class="field description">
                <div class="row">
                    <label class="col-12">{{ls.l('Description')}}</label>
                </div>

                <div class="row">
                    <div class="col-12">
                        <dx-text-area name="description"
                                      [readOnly]="data.readOnly"
                                      [width]="'100%'"
                                      [height]="'100px'"
                                      [(value)]="appointment.Description">
                        </dx-text-area>
                    </div>
                </div>
            </div>
        </div>
    </dx-scroll-view>
</modal-dialog>
