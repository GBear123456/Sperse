<app-headline
  [names]="[ls.ls(localization, 'Dashboard')]"
  [text]="ls.ls(localization, 'statistics and reports')"
  icon="globe"
  [showReloadButton]="ui.showReload && hasAccessibleCG"
  [showToggleLeftMenuButton]="true"
  [showToggleFilterMenuButton]="hasAccessibleCG"
  (onToggleLeftMenu)="repaint()"
  (onReload)="refresh()"
>
  <import-progress-bar *ngIf="hasAccessibleCG"></import-progress-bar>
  <calendar-button *ngIf="hasAccessibleCG"></calendar-button>
</app-headline>

<div *ngIf="hasAccessibleCG; else noData">
  <!-- Left Menu - Same for both versions -->
  <crm-left-menu [ngStyle]="{ float: menuSide }" [showIntroductionTour]="!appService.isHostTenant"
    [currentContactGroup]="filterModelContactGroup.items.element.value" (openIntro)="openDialog()">
  </crm-left-menu>
  
  <!-- Right Content Area with Version Tabs -->
  <div class="widgets-wrapper"
    [ngClass]="{ expanded: leftMenuCollapsed$ | async, 'left-nav-menu': layoutService.showLeftBar }"
    [ngStyle]="menuSide === 'left' ? { 'margin-left': '251px' } : { 'margin-right': '251px' }">
    <div class="wrapper">
      <dx-scroll-view *ngIf="showDefaultSection$ | async" showScrollbar="onHover">
        <div class="dashboard-widgets">
          <!-- Dashboard Version Tabs -->
          <div class="dashboard-version-tabs">
            <mat-tab-group (selectedTabChange)="switchVersion($event.index === 0 ? 'v1' : 'v2')" [selectedIndex]="selectedVersion === 'v1' ? 0 : 1">
              <mat-tab label="Dashboard V1">
                <!-- V1 Content -->
                <div class="kpi-cards-container">
                  <app-kpi-card *ngFor="let card of kpiCards" [cardData]="card" (currencyChange)="onCurrencyChange($event)">
                  </app-kpi-card>
                </div>

                <div class="d-flex flex-column chart-container">
                  <app-customers-chart #grossEarningsChart [currentPeriodTotal]="grossEarnings" [percentageChange]="80.15" [startDate]="chartStartDate"
                    [endDate]="chartEndDate" [comparisonStartDate]="chartComparisonStartDate"
                    [comparisonEndDate]="chartComparisonEndDate" [title]="'Gross Earnings'" [icon]="'attach_money'"
                    [grossEarningsStatsData]="grossEarningsStatsData" [isLoading]="isLoadingGrossEarningsStats">
                  </app-customers-chart>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <app-customers-chart #customersChart [currentPeriodTotal]="totalCustomers" [percentageChange]="0" [startDate]="chartStartDate"
                      [endDate]="chartEndDate" [comparisonStartDate]="chartComparisonStartDate"
                      [comparisonEndDate]="chartComparisonEndDate" [title]="'Customers'" [icon]="'people'"
                      [customerStatsData]="customerStatsData">
                    </app-customers-chart>
                    <app-customers-chart #upgradesChart [currentPeriodTotal]="0" [percentageChange]="80.15" [startDate]="chartStartDate"
                      [endDate]="chartEndDate" [comparisonStartDate]="chartComparisonStartDate"
                      [comparisonEndDate]="chartComparisonEndDate" [title]="'Upgrades'" [icon]="'show_chart'">
                    </app-customers-chart>
                    <app-customers-chart #shopOrdersChart [currentPeriodTotal]="0" [percentageChange]="80.15" [startDate]="chartStartDate"
                      [endDate]="chartEndDate" [comparisonStartDate]="chartComparisonStartDate"
                      [comparisonEndDate]="chartComparisonEndDate" [title]="'SHOP ORDERS'" [icon]="'shopping_cart'">
                    </app-customers-chart>
                    <app-customers-chart #cancelledChart [currentPeriodTotal]="0" [percentageChange]="80.15" [startDate]="chartStartDate"
                      [endDate]="chartEndDate" [comparisonStartDate]="chartComparisonStartDate"
                      [comparisonEndDate]="chartComparisonEndDate" [title]="'CANCELLED'" [icon]="'trending_down'">
                    </app-customers-chart>
                </div>
                <clients-by-region *ngIf="hasAnyCGPermission" [waitFor$]="clientsByRegionLoad.asObservable()"
                  (loadComplete)="totalsByPeriodLoad.next()">
                </clients-by-region>
              </mat-tab>
              
              <mat-tab label="Dashboard V2">
                <!-- V2 Content -->
                <counts-and-totals
                  *ngIf="hasAnyCGPermission || isGrantedOrders"
                  (loadComplete)="clientsByRegionLoad.next()"
                >
                </counts-and-totals>
                <div class="analytics-wrap">
                  <div class="left-side col-xl-4">
                    <new-items-totals *ngIf="hasAnyCGPermission || isGrantedOrders"></new-items-totals>
                    <totals-by-source
                      *ngIf="hasAnyCGPermission"
                      [waitFor$]="totalsBySourceLoad.asObservable()"
                      (loadComplete)="recentClientsLoad.next()"
                    >
                    </totals-by-source>
                  </div>
                  <div class="right-side col-xl-8">
                    <ng-container *ngIf="hasAnyCGPermission">
                      <totals-by-period
                        [waitFor$]="totalsByPeriodLoad.asObservable()"
                        (loadComplete)="totalsBySourceLoad.next()"
                      >
                      </totals-by-period>
                      <recent-clients [waitFor$]="recentClientsLoad.asObservable()"> </recent-clients>
                    </ng-container>
                  </div>
                </div>
                <clients-by-region
                  *ngIf="hasAnyCGPermission"
                  [waitFor$]="clientsByRegionLoad.asObservable()"
                  (loadComplete)="totalsByPeriodLoad.next()"
                >
                </clients-by-region>
              </mat-tab>
            </mat-tab-group>
          </div>
        </div>
      </dx-scroll-view>
      <loading-spinner *ngIf="showLoadingSpinner"></loading-spinner>
    </div>
  </div>
</div>

<ng-template #noData>
  <app-no-data></app-no-data>
</ng-template>