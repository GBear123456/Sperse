<span class="close" (click)="close()"></span>
<mat-dialog-content>
    <mat-tab-group [(selectedIndex)]="selectedTabIndex">
        <mat-tab [label]="ls.l('PersonalSettings.General')">
            <dx-scroll-view showScrollbar="onHover" [height]="getTabContentHeight()">
                <div class="general-tab">
                    <mat-accordion displayMode="flat" [multi]="true">
                        <mat-expansion-panel class="affiliate-info" [expanded]="true">
                            <mat-expansion-panel-header>
                                <mat-panel-title>{{ ls.l('AffiliateInfo') }}</mat-panel-title>
                                <span class="dx-icon-clock history-icon" (click)="showAffiliateHistory($event)" [title]="ls.l('AffiliateHistory')"></span>
                            </mat-expansion-panel-header>
                            <div class="field affiliate-code" [ngClass]="{'zero': affiliateRate == 0, 'undefined': affiliateRate === null}">
                                <inplace-edit [id]="contactInfo?.id"
                                              lEntityName="Name"
                                              [editPlaceholder]="ls.l('AffiliateEditPlaceholder')"
                                              [value]="affiliateCode$ | async"
                                              [showInlineEditButton]="true"
                                              [isDeleteEnabled]="true"
                                              [lDeleteConfirmTitle]="ls.l('DeleteContactHeader', ls.l('AffiliateCode'))"
                                              [lDeleteConfirmMessage]="ls.l('DeleteContactMessage', ls.l('AffiliateCode').toLowerCase())"
                                              [validationRules]="affiliateValidationRules"
                                              [isReadOnlyField]="!manageAllowed"
                                              (valueChanged)="updateAffiliateCode($event)"
                                              (itemDeleted)="deleteItem(ls.l('Affiliate'))">
                                </inplace-edit>
                            </div>
                            <div class="field" *ngIf="hasCommissionsFeature">
                                <label>{{ ls.l('AffiliateRate') }}, %:</label>
                                <inplace-edit [id]="contactInfo?.id"
                                              lEntityName="Name"
                                              [editPlaceholder]="defaultAffiliateRate !== undefined ? ls.l('DefaultRate') + ' ' + defaultAffiliateRate : ''"
                                              [value]="affiliateRate === null ? '' : affiliateRate + ''"
                                              [showInlineEditButton]="hasCommissionsManagePermission"
                                              [isDeleteEnabled]="hasCommissionsManagePermission"
                                              [lDeleteConfirmTitle]="ls.l('DeleteContactHeader', ls.l('AffiliateRate'))"
                                              [lDeleteConfirmMessage]="ls.l('DeleteContactMessage', ls.l('AffiliateRate').toLowerCase())"
                                              [validationRules]="affiliateRateValidationRules"
                                              [isReadOnlyField]="!hasCommissionsManagePermission || !manageAllowed"
                                              (valueChanged)="updateAffiliateRate($event)"
                                              (itemDeleted)="deleteItem(ls.l('AffiliateRate'))">
                                </inplace-edit>
                            </div>
                        </mat-expansion-panel>
                        <mat-expansion-panel class="source-info" [expanded]="true">
                            <mat-expansion-panel-header>
                                <mat-panel-title>{{ ls.l('SourceInfo') }}</mat-panel-title>
                            </mat-expansion-panel-header>
                            <ng-container *ngIf="sourceContactInfo$ | async as sourceContactInfo">
                                <div class="field">
                                    <source-contact-list
                                        [leadId]="leadInfo?.id"
                                        [selectedKey]="sourceContactInfo.sourceContactLevel1?.id"
                                        [targetSelector]="'#affiliateContactLink'"
                                        (onItemSelected)="onSourceContactChanged($event)">
                                    </source-contact-list>
                                    <label>{{ ls.l('PersonalSettings.Contact1') }}:</label>
                                    <div>
                                        <div class="thumbnail">
                                            <img [src]="getThumbnailSrc(sourceContactInfo?.sourceContactLevel1?.photoPublicId)"/>
                                        </div>
                                        <div class="field-info">
                                            <a [ngClass]="{empty: !sourceContactInfo?.sourceContactLevel1}" (click)="openContactDetails(sourceContactInfo?.sourceContactLevel1?.id)">
                                                {{ sourceContactInfo?.sourceContactLevel1?.name || (ls.l('Set') + ' ' + ls.l('PersonalSettings.Contact1')) }}
                                                <i id="affiliateContactLink" class="edit fa fa-pencil"
                                                    (click)="openSourceContactList($event)">
                                                </i>
                                                <ng-container *ngIf="sourceContactInfo?.sourceContactLevel1">
                                                    <i class="remove fa fa-times"
                                                        (click)="removeSourceContact($event)">
                                                    </i>
                                                    <i class="save-to-clipboard"
                                                        (click)="saveToClipboard($event, sourceContactInfo?.sourceContactLevel1?.name)">
                                                    </i>
                                                </ng-container>
                                            </a>
                                            <div *ngIf="sourceContactInfo?.sourceContactLevel1?.affiliateCode as affiliateCode" class="additional-info">
                                                <span>{{ ls.l('AffiliateCode') }}: </span>
                                                <span class="bold">{{ affiliateCode }}</span>
                                            </div>
                                            <hr/>
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="(appService.isHostTenant || (appSession.tenant && appSession.tenant.tenancyName === 'BankCode' || appSession.tenant.tenancyName === 'performancepartners'))
                                            && sourceContactInfo.sourceContactLevel2 as sourceContactLevel2"
                                     class="field">
                                    <label>{{ ls.l('PersonalSettings.Contact2') }}:</label>
                                    <div>
                                        <div class="thumbnail">
                                            <img [src]="getThumbnailSrc(sourceContactLevel2.photoPublicId)"/>
                                        </div>
                                        <div class="field-info">
                                            <a *ngIf="sourceContactLevel2.name" (click)="openContactDetails(sourceContactLevel2.id)">{{ sourceContactLevel2.name }}
                                                <i class="save-to-clipboard"
                                                   (click)="saveToClipboard($event, sourceContactLevel2.name)">
                                                </i>
                                            </a>
                                            <hr/>
                                        </div>
                                    </div>
                                </div>
                            </ng-container>
                            <div *ngIf="contactInfo?.assignedUserName as assignedUserName" class="field">
                                <label>{{ ls.l('PersonalSettings.AssignedTo') }}:</label>
                                <div>
                                    <div class="thumbnail">
                                        <img [src]="getThumbnailSrc(contactInfo?.assignedUserPicturePublicId)"/>
                                    </div>
                                    <div class="field-info">
                                        <a (click)="openContactDetails(contactInfo?.assignedContactId)">{{assignedUserName}}
                                            <i class="save-to-clipboard"
                                               (click)="saveToClipboard($event, assignedUserName)">
                                            </i>
                                        </a>
                                        <hr/>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label>{{ ls.l('CreatedBy') }}:</label>
                                <div>
                                    <div class="thumbnail">
                                        <img [src]="getThumbnailSrc(contactInfo?.creatorUserPicturePublicId)"/>
                                    </div>
                                    <div class="field-info">
                                        <a *ngIf="contactInfo?.creatorUserName as creatorUserName" (click)="openContactDetails(contactInfo?.creatorContactId)">{{creatorUserName}}
                                            <i class="save-to-clipboard"
                                               (click)="saveToClipboard($event, creatorUserName)">
                                            </i>
                                        </a>
                                        <div class="additional-info">
                                            <ng-container *ngIf="leadInfo?.channelCode as channelCode">
                                                <span class="channel-code">{{leadInfo?.channelCode}}</span>, on
                                            </ng-container>
                                            <span>{{contactInfo?.contactDate | date: formatting.dateTime : userTimezone}}</span>
                                        </div>
                                        <hr/>
                                    </div>
                                </div>
                            </div>
                            <div class="field" *ngIf="lastModificationInfo?.date">
                                <label>{{ ls.l('LastUpdatedBy') }}:</label>
                                <div>
                                    <div class="thumbnail">
                                        <img [src]="getThumbnailSrc(lastModificationInfo.photoPublicId)" alt="Profile image"/>
                                    </div>
                                    <div class="field-info">
                                        <a *ngIf="lastModificationInfo.userName as updatedByUserName; else system" (click)="openContactDetails(lastModificationInfo?.contactId)">{{updatedByUserName}}
                                            <i class="save-to-clipboard"
                                               (click)="saveToClipboard($event, updatedByUserName)">
                                            </i>
                                        </a>
                                        <ng-template #system>
                                            {{ ls.l('System') }}
                                        </ng-template>
                                        <div *ngIf="lastModificationInfo.date as lastModificationTime" class="additional-info">
                                            <span>on {{lastModificationTime | date: formatting.dateTime : userTimezone}} </span>
                                            <span class="date-ago">({{ lastModificationTime | timeAgo}})</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </mat-expansion-panel>
                        <mat-expansion-panel [expanded]="true">
                            <mat-expansion-panel-header>
                                <mat-panel-title>{{ ls.l('ContactDetails') }}</mat-panel-title>
                            </mat-expansion-panel-header>
                            <div class="field" *ngIf="leadInfo?.stage as stage">
                                <label>{{ ls.l('LeadStage') }}</label>
                                <span><span *ngIf="stageColor" class="status-icon" [ngStyle]="{ backgroundColor: stageColor }"></span>{{ stage }}</span>
                            </div>
                            <hr/>
                            <div class="field">
                                <label>{{ ls.l('ContactID') }}:</label>
                                <span>{{contactInfo?.id}}<i class="save-to-clipboard" (click)="saveToClipboard($event, contactInfo?.id)"></i></span>
                            </div>
                            <hr/>
                            <div class="field">
                                <label>{{ ls.l('RecentLeadID') }}:</label>
                                <span>{{leadInfo?.id}}<i class="save-to-clipboard" (click)="saveToClipboard($event, leadInfo?.id)"></i></span>
                            </div>
                            <hr/>
                            <div class="field">
                                <label>{{ ls.l('Xref') }}:</label>
                                <inplace-edit [id]="contactInfo?.id"
                                              lEntityName="Name"
                                              [editPlaceholder]="ls.l('Xref')"
                                              [value]="contactXref$ | async"
                                              [isOptional]="true"
                                              [showInlineEditButton]="true"
                                              [isDeleteEnabled]="true"
                                              [lDeleteConfirmTitle]="ls.l('DeleteContactHeader', ls.l('Xref'))"
                                              [lDeleteConfirmMessage]="ls.l('DeleteContactMessage', ls.l('Xref').toLowerCase())"
                                              [validationRules]="xrefValidationRules"
                                              [isReadOnlyField]="!manageAllowed"
                                              (valueChanged)="updateXref($event)"
                                              (itemDeleted)="deleteItem(ls.l('Xref'))">
                                </inplace-edit>
                            </div>
                            <hr/>
                            <ng-container *ngFor="let n of [1,2,3,4,5]">
                                <div class="field">
                                    <label>{{ ls.l('Contact_CustomField' + n) }}:</label>
                                    <inplace-edit [id]="'Contact_CustomField' + n"
                                                  lEntityName="Name"
                                                  [editPlaceholder]="ls.l('Contact_CustomField' + n)"
                                                  [value]="contactInfo?.personContactInfo['customField' + n]"
                                                  [isOptional]="true"
                                                  [showInlineEditButton]="true"
                                                  [isDeleteEnabled]="true"
                                                  [lDeleteConfirmTitle]="ls.l('DeleteContactHeader', ls.l('Contact_CustomField' + n))"
                                                  [lDeleteConfirmMessage]="ls.l('DeleteContactMessage', ls.l('Contact_CustomField' + n))"
                                                  [isReadOnlyField]="!manageAllowed"
                                                  (valueChanged)="updateCustomField($event, 'customField' + n)"
                                                  (itemDeleted)="updateCustomField(null, 'customField' + n)">
                                    </inplace-edit>
                                </div>
                                <hr/>
                            </ng-container>
                        </mat-expansion-panel>
                    </mat-accordion>
                </div>
            </dx-scroll-view>
        </mat-tab>
        <mat-tab [label]="ls.l('Overview')" *ngIf="showOverviewTab">
            <span class="gear-icon" (click)="toggleConfigMode()"></span>
            <dx-scroll-view showScrollbar="onHover">
                <div class="overview-content" [ngClass]="{'config-mode': configMode}">
                    <div class="right-panel-block" [hidden]="!configMode && !overviewPanelSetting?.clientScores">
                        <input *ngIf="configMode" type="checkbox"
                               (click)="toggleSectionVisibility($event, 'clientScores')"
                               class="cb-visible-section" [checked]="overviewPanelSetting?.clientScores">
                        <client-scores></client-scores>
                    </div>
                    <div class="right-panel-block" [hidden]="!configMode && !overviewPanelSetting?.totalApproved">
                        <input *ngIf="configMode" type="checkbox"
                               (click)="toggleSectionVisibility($event, 'totalApproved')"
                               class="cb-visible-section" [checked]="overviewPanelSetting?.totalApproved">
                        <total-approved></total-approved>
                    </div>
                    <!-- credit-lines></credit-lines -->
                    <div class="right-panel-block" [hidden]="!configMode && !overviewPanelSetting?.verification">
                        <input *ngIf="configMode" type="checkbox"
                               (click)="toggleSectionVisibility($event, 'verification')"
                               class="cb-visible-section" [checked]="overviewPanelSetting?.verification">
                        <verification-checklist [data]="verificationChecklist"></verification-checklist>
                    </div>
                    <!-- required-documents></required-documents -->
                </div>
            </dx-scroll-view>
        </mat-tab>
        <mat-tab [label]="ls.l('Checklist')" [disabled]="!!checklistSources.length && !checklistLeadDataSource[0]?.total && !checklistOrderDataSource[0]?.total">
            <dx-scroll-view showScrollbar="onHover" #checklistScroll [height]="getTabContentHeight()">
                <div *ngFor="let source of checklistSources; let i = index" [hidden]="!source?.checklistId || !source?.checklistDataSource[0]?.total">
                    <dx-select-box *ngIf="source?.contactDataSource"
                        valueExpr="Id"
                        displayExpr="Name"
                        [width]="'370px'"
                        [placeholder]="''"
                        [value]="source?.checklistId"
                        [itemTemplate]="'cell'"
                        [fieldTemplate]="'cell'"
                        [deferRendering]="false"
                        [focusStateEnabled]="false"
                        [hoverStateEnabled]="false"
                        [activeStateEnabled]="false"
                        (onSelectionChanged)="source?.onChange($event)"
                        (onInitialized)="onSelectInitialized($event)"
                        [dataSource]="source?.contactDataSource">
                        <div *dxTemplate="let cell of 'cell'">
                            <dx-text-box
                                [readOnly]="true"
                                [elementAttr]="{'lead-checklist': true}"
                                [focusStateEnabled]="false"
                                [hoverStateEnabled]="false"
                                hint="{{cell?.Number || cell?.Id}}, {{cell?.Stage}} ({{(cell?.LeadDate || cell?.OrderDate) | date}})"
                                value="{{cell?.Number || cell?.Id}}, {{cell?.Stage}} ({{(cell?.LeadDate || cell?.OrderDate) | date}})">
                            </dx-text-box>
                        </div>
                    </dx-select-box>
                    <div class="progress-wrapper" *ngIf="source?.checklistDataSource && source?.checklistDataSource[0] as data">
                        <svg width="28" height="28" class="progress">
                            <circle stroke="#e5e9ec" stroke-width="3" fill="transparent" r="12" cx="14" cy="14"/>
                            <circle [ngStyle]="{'stroke-dashoffset': 76 - data?.progress / data?.total * 76}"
                                class="ring" stroke="#37d749" stroke-width="3" fill="transparent" r="12" cx="14" cy="14"/>
                        </svg>
                        <span>{{data.progress}} / {{data.total}}</span>
                    </div>
                    <dx-tree-view *ngIf="source?.checklistDataSource && source?.checklistDataSource[0]?.total"
                        [height]="'100%'"
                        itemTemplate="cell"
                        showCheckBoxesMode="normal"
                        [selectNodesRecursive]="false"
                        [dataSource]="source?.checklistDataSource"
                        (onItemSelectionChanged)="onChecklistChanged($event, i)">
                        <div *dxTemplate="let cell of 'cell'" class="data-item">
                            <span>{{cell.text}}</span><span class="time-ago" *ngIf="cell.date">{{cell.date | timeAgo}}</span>
                        </div>
                    </dx-tree-view>
                </div>
            </dx-scroll-view>
        </mat-tab>
        <mat-tab [label]="ls.l('Activity')" [disabled]="true">
        </mat-tab>
    </mat-tab-group>
</mat-dialog-content>