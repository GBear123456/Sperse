<source-contact-list
    [leadId]="leadInfo?.id"
    [selectedKey]="leadInfo?.sourceContactId">
</source-contact-list>
<h2 mat-dialog-title>{{ls.l('Personal Settings')}}<span class="close" (click)="close()"></span></h2>
<mat-dialog-content>
    <mat-tab-group>
        <mat-tab [label]="ls.l('General')">
            <dx-scroll-view showScrollbar="onHover" [height]="getTabContentHeight()">
                <div class="general-tab">
                    <mat-accordion displayMode="flat" [multi]="true">
                        <mat-expansion-panel [expanded]="true">
                            <mat-expansion-panel-header>
                                <mat-panel-title>{{ ls.l('AffiliateInfo') }}</mat-panel-title>
                            </mat-expansion-panel-header>
                            <div class="field">
                                <label>{{ ls.l('AffiliateCode') }}: </label>
                                <inplace-edit [id]="contactInfo.id"
                                              lEntityName="Name"
                                              [editPlaceholder]="ls.l('Affiliate')"
                                              [value]="affiliateCode$ | async"
                                              [showInlineEditButton]="true"
                                              [isDeleteEnabled]="true"
                                              [lDeleteConfirmTitle]="ls.l('DeleteContactHeader', ls.l('AffiliateCode'))"
                                              [lDeleteConfirmMessage]="ls.l('DeleteContactMessage', ls.l('AffiliateCode').toLowerCase())"
                                              [validationRules]="affiliateValidationRules"
                                              [isReadOnlyField]="!permissionChecker.checkCGPermission(contactInfo.groupId)"
                                              (valueChanged)="updateAffiliateCode($event)"
                                              (itemDeleted)="deleteItem(ls.l('Affiliate'))">
                                </inplace-edit>
                            </div>
                        </mat-expansion-panel>
                        <mat-expansion-panel class="source-info" [expanded]="true">
                            <mat-expansion-panel-header>
                                <mat-panel-title>{{ ls.l('SourceInfo') }}</mat-panel-title>
                            </mat-expansion-panel-header>
                            <div *ngIf="leadInfo?.sourceContactId" class="field">
                                <label>{{ ls.l('PersonalSettings.Contact') }}:</label>
                                <div>
                                    <div class="thumbnail">
                                        <img [src]="getThumbnailSrc(leadInfo.sourceContactPhotoPublicId)"/>
                                    </div>
                                    <div class="field-info">
                                        <span *ngIf="leadInfo.sourceContactName">{{ leadInfo.sourceContactName }}
                                            <i class="save-to-clipboard"
                                               (click)="saveToClipboard(leadInfo.sourceContactName)">
                                            </i>
                                        </span>
                                        <div *ngIf="leadInfo.sourceContactAffiliateCode as affiliateCode" class="additional-info">
                                            <span>{{ ls.l('AffiliateCode') }}: </span>
                                            <span class="bold">{{ affiliateCode }}</span>
                                        </div>
                                        <hr/>
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="contactInfo?.assignedUserName as assignedUserName" class="field">
                                <label>{{ ls.l('PersonalSettings.AssignedTo') }}:</label>
                                <div>
                                    <div class="thumbnail">
                                        <img [src]="getThumbnailSrc(contactInfo.assignedUserPicturePublicId)"/>
                                    </div>
                                    <div class="field-info">
                                        <span>{{assignedUserName}}
                                            <i
                                               class="save-to-clipboard"
                                               (click)="saveToClipboard(assignedUserName)">
                                            </i>
                                        </span>
                                        <hr/>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label>{{ ls.l('CreatedBy') }}:</label>
                                <div>
                                    <div class="thumbnail">
                                        <img [src]="getThumbnailSrc(contactInfo?.creatorUserPicturePublicId)"/>
                                    </div>
                                    <div class="field-info">
                                        <span *ngIf="contactInfo?.creatorUserName as creatorUserName">
                                            {{creatorUserName}}
                                            <i class="save-to-clipboard"
                                               (click)="saveToClipboard(creatorUserName)">
                                            </i>
                                        </span>
                                        <div class="additional-info">
                                            <ng-container *ngIf="leadInfo?.channelCode as channelCode">
                                                <span class="channel-code">{{leadInfo?.channelCode}}</span>, on
                                            </ng-container>
                                            <span>{{contactInfo?.contactDate | date: formatting.dateTime : userTimezone}}</span>
                                        </div>
                                        <hr/>
                                    </div>
                                </div>
                            </div>
                            <div class="field" *ngIf="lastModificationInfo?.userId">
                                <label>{{ ls.l('LastUpdatedBy') }}:</label>
                                <div>
                                    <div class="thumbnail">
                                        <img [src]="getThumbnailSrc(lastModificationInfo.photoPublicId)"/>
                                    </div>
                                    <div class="field-info">
                                        <span *ngIf="lastModificationInfo.userName">{{lastModificationInfo.userName}}
                                            <i class="save-to-clipboard"
                                               (click)="saveToClipboard(lastModificationInfo.userName)">
                                            </i>
                                        </span>
                                        <div *ngIf="lastModificationInfo.date as lastModificationTime" class="additional-info">
                                            <span>on {{lastModificationTime | date: formatting.dateTime : userTimezone}} </span>
                                            <span class="date-ago">({{lastModificationTime | timeAgo}})</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </mat-expansion-panel>
                        <mat-expansion-panel [expanded]="true">
                            <mat-expansion-panel-header>
                                <mat-panel-title>{{ ls.l('ContactDetails') }}</mat-panel-title>
                            </mat-expansion-panel-header>
                            <div class="field" *ngIf="leadInfo?.stage as stage">
                                <label>{{ ls.l('Status') }}</label>
                                <span><span *ngIf="stageColor" class="status-icon" [ngStyle]="{ backgroundColor: stageColor }"></span>{{ stage }}</span>
                            </div>
                            <hr/>
                            <div class="field">
                                <label>{{ ls.l('ContactID') }}:</label>
                                <span>{{contactInfo?.id}}<i class="save-to-clipboard" (click)="saveToClipboard(contactInfo?.id)"></i></span>
                            </div>
                            <hr/>
                            <div class="field">
                                <label>{{ ls.l('RecentLeadID') }}:</label>
                                <span>{{leadInfo?.id}}<i class="save-to-clipboard" (click)="saveToClipboard(leadInfo?.id)"></i></span>
                            </div>
                            <hr/>
                            <div class="field">
                                <label>{{ ls.l('Xref') }}:</label>
                                <inplace-edit [id]="contactInfo.id"
                                              lEntityName="Name"
                                              [editPlaceholder]="ls.l('Xref')"
                                              [value]="contactXref$ | async"
                                              [isOptional]="true"
                                              [showInlineEditButton]="true"
                                              [isDeleteEnabled]="true"
                                              [lDeleteConfirmTitle]="ls.l('DeleteContactHeader', ls.l('Xref'))"
                                              [lDeleteConfirmMessage]="ls.l('DeleteContactMessage', ls.l('Xref').toLowerCase())"
                                              [validationRules]="xrefValidationRules"
                                              [isReadOnlyField]="!permissionChecker.checkCGPermission(contactInfo.groupId)"
                                              (valueChanged)="updateXref($event)"
                                              (itemDeleted)="deleteItem(ls.l('Xref'))">
                                </inplace-edit>
                            </div>
                            <hr/>
                            <ng-container *ngFor="let n of [1,2,3,4,5]">
                                <div class="field">
                                    <label>{{ ls.l('Contact_CustomField' + n) }}:</label>
                                    <inplace-edit [id]="'Contact_CustomField' + n"
                                                  lEntityName="Name"
                                                  [editPlaceholder]="ls.l('Contact_CustomField' + n)"
                                                  [value]="contactInfo?.personContactInfo['customField' + n]"
                                                  [isOptional]="true"
                                                  [showInlineEditButton]="true"
                                                  [isDeleteEnabled]="true"
                                                  [lDeleteConfirmTitle]="ls.l('DeleteContactHeader', ls.l('Contact_CustomField' + n))"
                                                  [lDeleteConfirmMessage]="ls.l('DeleteContactMessage', ls.l('Contact_CustomField' + n))"
                                                  [isReadOnlyField]="!permissionChecker.checkCGPermission(contactInfo.groupId)"
                                                  (valueChanged)="updateCustomField($event, 'customField' + n)"
                                                  (itemDeleted)="updateCustomField(null, 'customField' + n)">
                                    </inplace-edit>
                                </div>
                                <hr/>
                            </ng-container>
                        </mat-expansion-panel>
                    </mat-accordion>
                </div>
            </dx-scroll-view>
        </mat-tab>
        <mat-tab [label]="ls.l('Overview')" *ngIf="showOverviewTab">
            <span class="gear-icon" (click)="toggleConfigMode()"></span>
            <dx-scroll-view showScrollbar="onHover">
                <div class="overview-content" [ngClass]="{'config-mode': configMode}">
                    <div class="right-panel-block" [hidden]="!configMode && !overviewPanelSetting?.clientScores">
                        <input *ngIf="configMode" type="checkbox"
                               (click)="toggleSectionVisibility($event, 'clientScores')"
                               class="cb-visible-section" [checked]="overviewPanelSetting?.clientScores">
                        <client-scores></client-scores>
                    </div>
                    <div class="right-panel-block" [hidden]="!configMode && !overviewPanelSetting?.totalApproved">
                        <input *ngIf="configMode" type="checkbox"
                               (click)="toggleSectionVisibility($event, 'totalApproved')"
                               class="cb-visible-section" [checked]="overviewPanelSetting?.totalApproved">
                        <total-approved></total-approved>
                    </div>
                    <!-- credit-lines></credit-lines -->
                    <div class="right-panel-block" [hidden]="!configMode && !overviewPanelSetting?.verification">
                        <input *ngIf="configMode" type="checkbox"
                               (click)="toggleSectionVisibility($event, 'verification')"
                               class="cb-visible-section" [checked]="overviewPanelSetting?.verification">
                        <verification-checklist [data]="verificationChecklist"></verification-checklist>
                    </div>
                    <!-- required-documents></required-documents -->
                </div>
            </dx-scroll-view>
        </mat-tab>
        <mat-tab [label]="ls.l('Checklist')" [hidden]="!checklistLeadDataSource[0]?.items?.length && !checklistOrderDataSource[0]?.items?.length">
            <dx-scroll-view showScrollbar="onHover" [height]="getTabContentHeight(50)">
                <dx-select-box 
                    valueExpr="Id"
                    displayExpr="Name"
                    [width]="'370px'"
                    [placeholder]="''"
                    [value]="leadInfo?.id"
                    [itemTemplate]="'cell'"
                    [fieldTemplate]="'cell'"
                    [deferRendering]="false"
                    [focusStateEnabled]="false"
                    [hoverStateEnabled]="false"
                    [activeStateEnabled]="false"
                    (onSelectionChanged)="onLeadChanged($event)"
                    [dataSource]="contactLeadsDataSource">
                    <div *dxTemplate="let cell of 'cell'">
                        <dx-text-box
                            [readOnly]="true"
                            [elementAttr]="{'lead-checklist': true}"
                            [focusStateEnabled]="false"
                            [hoverStateEnabled]="false"
                            value="{{cell?.Id}}, {{cell?.Stage}} ({{cell?.LeadDate | date}})">
                        </dx-text-box>
                    </div>
                </dx-select-box>
                <dx-tree-view *ngIf="checklistLeadDataSource[0]?.items?.length"
                    [height]="'100%'"
                    showCheckBoxesMode="normal"
                    [selectNodesRecursive]="false"
                    [dataSource]="checklistLeadDataSource"
                    (onItemSelectionChanged)="onChecklistChanged($event)">
                </dx-tree-view>
                <dx-tree-view *ngIf="checklistOrderDataSource[0]?.items?.length"
                    [height]="'100%'"
                    showCheckBoxesMode="normal"
                    [selectNodesRecursive]="false"
                    [dataSource]="checklistOrderDataSource"
                    (onItemSelectionChanged)="onChecklistChanged($event)">
                </dx-tree-view>
            </dx-scroll-view>
        </mat-tab>
        <mat-tab label="Activity" [disabled]="true">
            Activity
        </mat-tab>
    </mat-tab-group>
</mat-dialog-content>