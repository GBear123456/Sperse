<h2>
    {{ ls.l('Subscriptions') }}
    <span class="history-button clickable-item pull-right" (click)="toggleHistory()">
        {{ showAll ? 'Hide history' : 'Show history' }}
    </span>
    <span *ngIf="manageAllowed" class="add-subscription pull-right" (click)="openSubscriptionDialog($event)">
        {{ ls.l('AddSubscription') }}
    </span>
</h2>
<action-menu 
    target=""
    width="150px"
    [items]="actionMenuItems"
    (onItemClick)="onMenuItemClick($event)">
</action-menu>
<dx-data-grid #mainGrid
    class="main-component-view"
    keyExpr="id"
    [pager]="pagerConfig"
    [dataSource]="dataSource"
    [allowColumnReordering]="false"
    [columnAutoWidth]="true"
    [allowColumnResizing]="false"
    [masterDetail]="{ enabled: true, template: 'detail' }"
    (onRowCollapsed)="onRowExpandedCollapsed($event)"
    (onRowExpanded)="onRowExpandedCollapsed($event)"
    (onCellClick)="onCellClick($event)">
    <dxo-sorting mode="multiple"></dxo-sorting>

    <dxi-column caption="" visibleIndex="0">
        <dxi-column dataField="id" caption="" [allowResizing]="false" cellTemplate="actionsCellTemplate" width="50px"></dxi-column>
    </dxi-column>

    <dxi-column caption="" visibleIndex="1">
        <dxi-column dataField="photo" cellTemplate="photoCell" caption="" width="70px"></dxi-column>
    </dxi-column>

    <dxi-column caption="" visibleIndex="2">
        <dxi-column dataField="productName" cellTemplate="productCell" [caption]="ls.l('ProductName')"></dxi-column>
    </dxi-column>

    <dxi-column caption="Original Order" visibleIndex="3" cssClass="header-top">
        <dxi-column dataField="originalStartDate" caption="Order Date" [allowResizing]="false" cellTemplate="dateTimeTemplate" width="210px" cssClass="tabular"></dxi-column>
        <dxi-column dataField="trialEndDate" [allowResizing]="false" cellTemplate="dateTimeTemplate" width="210px" cssClass="tabular"></dxi-column>
    </dxi-column>

    <dxi-column caption="Latest Subscription" visibleIndex="4" cssClass="header-top second">
        <dxi-column dataField="startDate" [allowResizing]="false" cellTemplate="dateTimeTemplate" width="210px" cssClass="tabular"></dxi-column>
        <dxi-column dataField="endDate" [allowResizing]="false" cellTemplate="dateTimeTemplate" width="210px" cssClass="tabular"></dxi-column>
    </dxi-column>

    <dxi-column caption="" visibleIndex="5">
        <dxi-column dataField="fee" [allowResizing]="false" cellTemplate="amountTemplate" width="90px"></dxi-column>
    </dxi-column>

    <dxi-column caption="" visibleIndex="6" >
        <dxi-column dataField="status" [allowResizing]="false" [caption]="ls.l('Status')" cellTemplate="statusCell" width="130px"></dxi-column>
    </dxi-column>

    <dxi-column caption="" visibleIndex="7" [allowResizing]="false" width="20px"></dxi-column>


    <div *dxTemplate="let cellData of 'photoCell'">
        <img width="64px" height="64px" [src]="cellData.data.photoUrl || 'assets/common/images/product.png'" onerror="this.src='assets/common/images/product.png'">
    </div>    

    <div *dxTemplate="let cellData of 'productCell'">
        <div class="product-name clipboard-holder" [title]="cellData.data.productCode ? 'Product Code: ' + cellData.data.productCode : ''">
            {{cellData.data.productName}}<b *ngIf="!cellData.data.productCode && cellData.data.services[0].levelName">{{' - ' + cellData.data.services[0].levelName}}</b>
        </div>
        <div *ngIf="cellData.data.productCode" class="services" [title]="cellData.data.serviceCodeList">{{cellData.data.serviceList}}</div>
    </div>    

    <div *dxTemplate="let cellData of 'actionsCellTemplate'">
        <a *ngIf="cellData?.data?.statusCode === 'A' && permission.isGranted(permissions.CRMOrdersManage) || cellData?.data?.systemType == 'Tenant' && cellData?.data?.systemMemberId && permission.isGranted(permissions.TenantsImpersonation)" class="dx-link dx-link-edit"></a>
    </div>
    <div *dxTemplate="let cellData of 'dateTemplate'" class="clipboard-holder">
        <span class="date-time" [title]="cellData.value | datetime: formatting.dateMoment">
            {{cellData.value ? (cellData.value | datetime: formatting.dateMoment) : ''}}
        </span>
    </div>
    <div *dxTemplate="let cellData of 'dateTimeTemplate'" 
        class="clipboard-holder"
        (mouseenter)="onDateHover($event)"  
        (mouseleave)="onDateLeave($event)">
        <dx-date-box width="33px"
            applyValueMode="useButtons"
            [visible]="!appService.isHostTenant && manageAllowed && cellData.column.dataField != 'originalStartDate' && cellData.column.dataField != 'trialEndDate'"
            [min]="cellData.column.dataField == 'endDate' ? (cellData.data.startDate | datetime: formatting.dateMoment) : undefined"
            [max]="cellData.column.dataField == 'startDate' ? (cellData.data.endDate | datetime: formatting.dateMoment) : undefined"
            [value]="cellData.value ? (cellData.value | datetime: formatting.dateTimeMoment) : undefined"
            (onOpened)="onCallendarOpened($event)"
            (onValueChanged)="onDateChanged($event, cellData)"
        ></dx-date-box>
        <span *ngIf="cellData.value" class="date-time {{cellData.column.dataField}}" title="{{cellData.value | datetime: formatting.dateTimeMoment}}">{{cellData.value | datetime: formatting.dateMoment}}</span>
    </div>
    <div *dxTemplate="let cellData of 'statusCell'">
        <div class="status {{cellData.value.toLowerCase()}}" [ngClass]="{'show-tooltip': !!cellData?.data?.cancelationReason || !!cellData?.data?.gracePeriodEndDate}"
              [matTooltip]="cellData?.data?.cancelationReason ? 'Cancellation Reason: ' + cellData.data.cancelationReason : cellData?.data?.gracePeriodDayCount + ' day(s) grace period ends at ' + cellData?.data?.gracePeriodEndDate?.format(formatting.dateTimeMoment)"
              [matTooltipDisabled]="!cellData.data.cancelationReason && !cellData.data.gracePeriodEndDate"
              matTooltipClass="mat-primary-tooltip"
              matTooltipShowDelay="200"
              matTooltipHideDelay="0">
            {{ cellData.value }}
        </div>
    </div>
    <div *dxTemplate="let cell of 'amountTemplate'" class="clipboard-holder">
        <span> {{ cell.text | currency:currency:'symbol':'1.2-2' }} </span>
    </div>
    <div *dxTemplate="let detail of 'detail'">
        <dx-data-grid
            width="100%"
            class="alone"
            [dataSource]="detail.data.payments"
            [allowColumnReordering]="false"
            [columnAutoWidth]="true"
            [allowColumnResizing]="false"
            [showBorders]="true">

            <dxi-column dataField="prefix" caption="" visibleIndex="0" width="20px"></dxi-column>
            <dxi-column dataField="image" caption="" visibleIndex="1" width="120px"></dxi-column>
            <dxi-column dataField="id" caption="" visibleIndex="2" alignment="left" cellTemplate="captionTemplate"></dxi-column>
            <dxi-column dataField="invoiceDate" visibleIndex="3" dataType="date" width="210px" cssClass="tabular clipboard-holder"></dxi-column>
            <dxi-column dataField="paymentDate" visibleIndex="4" dataType="date" width="210px" cssClass="tabular clipboard-holder"></dxi-column>
            <dxi-column dataField="startDate" caption="" visibleIndex="5" dataType="date" width="210px" cssClass="tabular clipboard-holder"></dxi-column>
            <dxi-column dataField="endDate" caption="" visibleIndex="6" dataType="date" width="210px" cssClass="tabular clipboard-holder"></dxi-column>
            <dxi-column dataField="fee" caption="" visibleIndex="7" width="90px" cellTemplate="amountTemplate"></dxi-column>
            <dxi-column dataField="status" caption="" visibleIndex="8" width="130px" cellTemplate="statusCell"></dxi-column>
            <dxi-column caption="" visibleIndex="9" width="20px"></dxi-column>

            <div *dxTemplate="let cell of 'captionTemplate'" class="clipboard-holder">
                <span> {{ 'Installment ' }}<b>{{'#' + cell.value}}</b> </span>
            </div>
            <div *dxTemplate="let cell of 'amountTemplate'" class="clipboard-holder">
                <span> {{ cell.text | currency:currency:'symbol':'1.2-2' }} </span>
            </div>
            <div *dxTemplate="let cell of 'statusCell'">
                <div class="status {{cell.value.toLowerCase()}}">
                    {{ cell.value }}
                </div>
            </div>
        </dx-data-grid>
    </div>
</dx-data-grid>