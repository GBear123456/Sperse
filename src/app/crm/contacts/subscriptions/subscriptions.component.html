<h2>
    {{ ls.l('Subscriptions') }}
    <span class="history-button clickable-item pull-right" (click)="toggleHistory()">
        {{ showAll ? 'Hide history' : 'Show history' }}
    </span>
    <span *ngIf="manageAllowed" class="add-subscription pull-right" (click)="openSubscriptionDialog($event)">
        {{ ls.l('AddSubscription') }}
    </span>
</h2>

<dx-data-grid #mainGrid
              id="gridContainer"
              keyExpr="id"
              [pager]="pagerConfig"
              [dataSource]="dataSource"
              [allowColumnReordering]="true"
              [columnAutoWidth]="true"
              [allowColumnResizing]="true"
              [masterDetail]="{ enabled: true, template: 'detail' }">
    <dxo-sorting mode="multiple"></dxo-sorting>

    <dxi-column dataField="id" [visible]="false" cssClass="clipboard-holder"></dxi-column>
    <dxi-column dataField="serviceType" [caption]="ls.l('Subscriptions.ServiceType')" cssClass="clipboard-holder"></dxi-column>
    <dxi-column dataField="serviceName" [caption]="ls.l('Subscriptions.ServiceName')" cssClass="clipboard-holder"></dxi-column>
    <dxi-column dataField="startDate" cellTemplate="dateTimeTemplate" [width]="appService.isHostTenant ? 180 : 215" cssClass="tabular"></dxi-column>
    <dxi-column dataField="endDate" cellTemplate="dateTimeTemplate" [width]="appService.isHostTenant ? 180 : 215" cssClass="tabular"></dxi-column>
    <dxi-column dataField="trialEndDate" cellTemplate="dateTemplate" cssClass="tabular"></dxi-column>
    <dxi-column dataField="fee" cellTemplate="amountTemplate"></dxi-column>
    <dxi-column dataField="status" [caption]="ls.l('Status')" cellTemplate="statusCell"></dxi-column>
    <dxi-column caption="" [width]="220" cellTemplate="actionsTemplate"></dxi-column>
    <div *dxTemplate="let cell of 'actionsTemplate'" class="billing-actions">
        <a *ngIf="cell.data.tenantId && permission.isGranted(permissions.TenantsImpersonation)"
           (click)="cell.data.statusCode === 'A' && showUserImpersonateLookUpModal($event, cell.data)">{{ls.l('LoginAsThisTenant')}}</a>
        <!-- <br /> -->
        <button class="btn-link" *ngIf="cell.data.statusCode === 'A' && permission.isGranted(permissions.CRMOrdersManage)" (click)="cancelSubscription(cell.data.id, $event)">{{ls.l('cancel')}}</button>
    </div>
    <div *dxTemplate="let cellData of 'dateTemplate'" class="clipboard-holder">
        <span class="date-time" title="{{cellData.value | datetime: formatting.dateMoment }}">{{cellData.value | datetime: formatting.dateMoment}}</span>
    </div>

    <div *dxTemplate="let cellData of 'dateTimeTemplate'" 
        class="clipboard-holder"
        (mouseenter)="onDateHover($event)"  
        (mouseleave)="onDateLeave($event)">
        <dx-date-box width="33px"
            applyValueMode="useButtons"
            [visible]="!appService.isHostTenant"
            [min]="cellData.column.dataField == 'endDate' ? (cellData.data.startDate | datetime: formatting.dateMoment) : undefined"
            [max]="cellData.column.dataField == 'startDate' ? (cellData.data.endDate | datetime: formatting.dateMoment) : undefined"
            [value]="cellData.value | datetime: formatting.dateTimeMoment"
            (onOpened)="onCallendarOpened($event)"
            (onValueChanged)="onDateChanged($event, cellData)"
        ></dx-date-box>
        <span class="date-time" title="{{cellData.value | datetime: formatting.dateTimeMoment}}">{{cellData.value | datetime: formatting.dateMoment}}</span>
    </div>
    <div *dxTemplate="let cellData of 'statusCell'" class="clipboard-holder">
        <span [matTooltip]="'Cancellation Reason: ' + cellData.data.cancelationReason"
              [matTooltipDisabled]="!cellData.data.cancelationReason"
              matTooltipClass="mat-primary-tooltip"
              matTooltipShowDelay="200"
              matTooltipHideDelay="0">
            {{ cellData.value }}
        </span>
    </div>
    <div *dxTemplate="let cell of 'amountTemplate'" class="clipboard-holder">
        <span> {{ cell.text | currency:currency:'symbol':'1.2-2' }} </span>
    </div>
    <div *dxTemplate="let payment of 'detail'">
        <div class="master-detail-caption">{{'Payments info'}}</div>
        <dx-data-grid [dataSource]="payment.data.orderSubscriptionPayments"
                      [showBorders]="true"
                      [columnAutoWidth]="true">

            <dxi-column dataField="status" [width]="120" [caption]="ls.l('Status')" cssClass="clipboard-holder"></dxi-column>
            <dxi-column dataField="fee" [caption]="ls.l('Total Fee')" cellTemplate="amountTemplate"></dxi-column>
            <dxi-column dataField="startDate" dataType="date" cssClass="clipboard-holder"></dxi-column>
            <dxi-column dataField="endDate" dataType="date" cssClass="clipboard-holder"></dxi-column>
            <div *dxTemplate="let cell of 'amountTemplate'" class="clipboard-holder">
                <span> {{ cell.text | currency:currency:'symbol':'1.2-2' }} </span>
            </div>
        </dx-data-grid>
    </div>
</dx-data-grid>
