<div class="inbox-user-form" >
    <div class="inbox-list">
        <dx-list
            width="100%"
            height="100%"
            keyExpr="id"
            searchExpr="Name"
            searchMode="contains"
            selectionMode="single"
            pageLoadMode="scrollBottom"
            [grouped]="true"
            [searchTimeout]="500"
            [dataSource]="dataSource"
            [collapsibleGroups]="true"
            [focusStateEnabled]="false"
            [activeStateEnabled]="false"
            [selectedItemKeys]="[activeMessage?.id]"
            [searchEditorOptions]="{placeholder: ls.l('SearchMessage')}"
            [searchEnabled]="true"
            (onContentReady)="scrollToActiveMessage()"
            (onItemClick)="initActiveMessage($event.itemData)">
                <div *dxTemplate="let item of 'group'" class="group-item" [ngClass]="{selected: item.id == activeMessage?.id, 'has-children': item.hasChildren, expanded: item.expanded}" (click)="expandGroup(item)">
                    <div class="email" [title]="item.date | datetime: formatting.fieldDateTime">
                        <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(item?.fromUserContactPhotoPublicId) + ')'}" class="img-circle"></div>
                        <div class="details">
                            <span class="from">{{item.fromUserName}}</span>
                            <span class="subject">{{item.subject}}</span>
                        </div>
                        <div class="date">{{item.creationTime | datetime: formatting.monthDay.toUpperCase()}}</div>
                        <div class="status {{item.statusCalculated | lowercase}}">
                            <i *ngIf="item.hasAttachments" class="fa fa-paperclip"></i>
                            {{item.statusCalculated}}
                        </div>
                    </div>
                </div>
                <div *dxTemplate="let item of 'item'" class="sub-item" [ngClass]="{selected: item.id == activeMessage?.id}">
                    <div class="email" [title]="item.date | datetime: formatting.fieldDateTime">
                        <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(item?.fromUserContactPhotoPublicId) + ')'}" class="img-circle"></div>
                        <div class="details">
                            <span class="from">{{item.fromUserName}}</span>
                            <span class="subject">{{item.subject}}</span>
                        </div>
                        <div class="date">{{item.creationTime | datetime: formatting.monthDay.toUpperCase()}}</div>
                        <div class="status {{item.statusCalculated | lowercase}}">
                            <i *ngIf="item.hasAttachments" class="fa fa-paperclip"></i>
                            {{item.statusCalculated}}
                        </div>
                    </div>
                </div>
        </dx-list>
    </div>
    <div #contentView class="content-view">
        <div class="inbox-content" *ngIf="activeMessage">
            <dx-tooltip [width]="activeMessage?.deliveryType=='SMS'?'530px':'700px'"
                        [target]="'span.to'"
                        [showEvent]="activeMessage?.recepients?.length && !activeMessage?.isInbound ? 'mouseenter' : ''"
                        hideEvent="dxhoverend"
                        position="bottom">
                <div *dxTemplate="let data of 'content'">
                    <dx-data-grid [dataSource]="activeMessage?.recepients" id="inbox-delivery-statuses">
                        <dxi-column dataField="recipient" width="200px"></dxi-column>
                        <dxi-column dataField="deliveryStatus" [caption]="ls.l('Status')" width="100px" cellTemplate="statusCell"></dxi-column>
                        <dxi-column dataField="deliveryDate" width="180px" cellTemplate="dateCell"></dxi-column>
                        <dxi-column dataField="openDate" width="180px" cellTemplate="dateCell" [visible]="activeMessage?.deliveryType=='Email'"></dxi-column>
                        <div *dxTemplate="let cellData of 'dateCell'">
                            {{cellData.value | datetime: formatting.fieldDateTime }}
                        </div>
                        <div *dxTemplate="let cellData of 'statusCell'">
                            <span class="delivery-status {{cellData.value | lowercase}}">{{cellData.value}}</span>
                        </div>
                    </dx-data-grid>
                </div>
            </dx-tooltip>
            <app-toolbar [config]="contentToolbar"></app-toolbar>
            <ng-container [ngSwitch]="activeMessage.deliveryType">
                <ng-container *ngSwitchCase="'SMS'">
                    <div class="header sms">
                        <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(activeMessage?.fromUserContactPhotoPublicId) + ')'}" class="img-circle avatar"></div>  
                        <div class="details">
                            <span class="from">{{activeMessage?.fromUserName}}</span>
                            <span class="to" *ngIf="(activeMessage?.isInbound ? activeMessage?.from : activeMessage?.to) as contact">{{ls.l(activeMessage?.isInbound ? 'from' : 'to')}} {{contact}}</span>
                        </div>
                        <div class="date">{{activeMessage?.creationTime | datetime: formatting.fieldDateTime}}</div>
                        <div class="status {{activeMessage?.statusCalculated | lowercase}}">{{activeMessage?.statusCalculated}}</div>
                    </div>
                </ng-container>
                <ng-container *ngSwitchCase="'Email'">
                    <div class="header">
                        <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(activeMessage?.fromUserContactPhotoPublicId) + ')'}" class="img-circle avatar"></div>
                        <div class="details">
                            <span class="from">{{activeMessage?.fromUserName}}&nbsp;<small *ngIf="activeMessage?.from">&lt;{{activeMessage?.from}}&gt;</small></span>
                            <span class="subject">{{activeMessage?.subject}}</span>
                            <span class="to" (click)="activeMessage.showTooltip = true">{{ls.l('to')}}: {{activeMessage?.to}} <i class="info dx-icon-info"></i></span>
                            <span class="to" *ngIf="activeMessage?.cc">{{ls.l('cc')}}: {{activeMessage?.cc}}</span>
                            <span class="to" *ngIf="activeMessage?.bcc">{{ls.l('bcc')}}: {{activeMessage?.bcc}}</span>
                        </div>
                        <div class="date">{{activeMessage?.creationTime | datetime: formatting.fieldDateTime}}</div>
                        <div class="status {{activeMessage?.statusCalculated | lowercase}}">
                            <i *ngIf="activeMessage?.hasAttachments" class="fa fa-paperclip"></i>
                            {{activeMessage?.statusCalculated}}
                        </div>
                    </div>
                </ng-container>
            </ng-container>
            <div class="content {{activeMessage.deliveryType | lowercase}}">
                <iframe [hidden]="!isActiveEmilType" #emailContent frameborder="0" width="100%"></iframe>
                <dx-scroll-view *ngIf="!isActiveEmilType" showScrollbar="onHover">
                    <div class="message-wrapper">
                        <div [ngClass]="{to: activeMessage.isInbound}" [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(activeMessage?.fromUserContactPhotoPublicId) + ')'}" class="img-circle avatar small"></div>                        
                        <div [ngClass]="{from: !activeMessage.isInbound, to: activeMessage.isInbound}" class="body date" [innerHtml]="activeMessage?.body" [attr.date]="activeMessage?.creationTime | datetime: formatting.fieldDateTime"></div>
                    </div>
                    <div class="children-wrapper">
                        <div *ngFor="let child of activeMessage?.items; let i = index" class="message-wrapper">
                            <div *ngIf="!activeMessage?.items[i + 1] || activeMessage?.items[i + 1].isInbound != child.isInbound" [ngClass]="{to: child.isInbound}" [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(child?.fromUserContactPhotoPublicId) + ')'}" class="img-circle avatar small"></div>
                            <div class="body" [ngClass]="{from: !child.isInbound, to: child.isInbound, date: !activeMessage?.items[i + 1] || activeMessage?.items[i + 1].isInbound != child.isInbound}" [attr.date]="child.creationTime | datetime: formatting.fieldDateTime">
                                <div [innerHtml]="child.body || child.subject"></div>
                                <div class="body-attachments">
                                    <div *ngFor="let attachment of child?.attachments" class="attachment">
                                        <a [download]="attachment.name" href="javascript:void(0)" class="name" (click)="openAttachment(attachment)"><i class="dx-icon-{{getExtension(attachment)}}file"></i>{{attachment.name}}</a>&nbsp;<span class="size">({{attachment.size | filesize}})</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </dx-scroll-view>
                <div class="attachments" *ngIf="activeMessage?.attachments?.length">
                    <dx-scroll-view showScrollbar="onHover">
                        <div *ngFor="let attachment of activeMessage?.attachments" class="attachment">
                            <a [download]="attachment.name" href="javascript:void(0)" class="name" (click)="openAttachment(attachment)"><i class="dx-icon-{{getExtension(attachment)}}file"></i>{{attachment.name}}</a>&nbsp;<span class="size">({{attachment.size | filesize}})</span>
                        </div>
                    </dx-scroll-view>
                </div>
                <div class="input-form" *ngIf="!isActiveEmilType">
                    <div>
                        <img src="assets/common/icons/page.svg" class="page" (click)="extendMessage()">
                        <ngx-file-drop accept="*.*" (onFileDrop)="addAttachments($event)">
                            <ng-template ngx-file-drop-content-tmp let-openFileSelector="openFileSelector">
                                <img src="assets/common/icons/attach.svg" class="attach" [ngClass]="{disabled: activeMessage.deliveryType == 'SMS'}" (click)="openFileSelector()">
                            </ng-template>
                        </ngx-file-drop>
                        <div class="delimiter"></div>
                        <dx-text-box
                            width="calc(100% - 60px)"
                            height="44px"
                            [maxLength]="150"
                            valueChangeEvent="keyup"
                            [placeholder]="ls.l('Type your message here...')"
                            [stylingMode]="'outlined'"
                            [(value)]="instantMessageText"
                            [disabled]="!isSendSmsAndEmailAllowed"
                            (onEnterKey)="instantMessageSend()">
                        </dx-text-box>
                        <img src="assets/common/icons/send-blue.svg" class="send" [ngClass]="{disabled: !instantMessageText}" (click)="instantMessageSend()">
                    </div>
                    <div *ngIf="instantMessageAttachments.length" class="instant-attachments">
                        <div *ngFor="let attachment of instantMessageAttachments" class="attachment">
                            <a [download]="attachment.name" href="javascript:void(0)" class="name" (click)="openAttachment(attachment)">{{attachment.name}}</a>&nbsp;<span class="size">({{attachment.size | filesize}})</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <app-no-data
            [hidden]="activeMessage"
            [showLink]="false">
        </app-no-data>
    </div>
    <dx-tooltip 
        position="bottom" 
        target="#unsubscribedStatus" 
        showEvent="dxhoverstart" 
        hideEvent="dxhoverend">
        <div>{{ ls.l('ContactIsUnsubscribedFromEmails') }}</div>
    </dx-tooltip>
</div>