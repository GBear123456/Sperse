<div>
    <action-menu
            [items]="actionMenuGroups"
            [visible]="actionEvent"
            [grouped]="true"
            class="grouped-action-menu"
            width="300px"
            target=".dx-state-hover .dx-link.dx-link-edit"
            (onItemClick)="onMenuItemClick($event)">
    </action-menu>
    <app-headline icon="briefcase"
                  [buttons]="headlineButtons"
                  [showCompactView]="showCompactView$ | async"
                  [showToggleToolbarButton]="true"
                  [showToggleCompactViewButton]="true"
                  [showReloadButton]="ui.showReload"
                  [showToggleColumnSelectorButton]="showToggleColumnSelectorButton"
                  [showToggleFullScreenButton]="true"
                  [showStateResetButton]="!showOrdersPipeline"
                  (onToggleCompactView)="toggleCompactView()"
                  (onToggleToolbar)="toggleToolbar()"
                  (onReload)="invalidate()"
                  (onStateReset)="dataGrid.instance.state(null)"
                  (onToggleColumnSelector)="toggleColumnChooser()">
        <orders-header-dropdown
                        [totalCount]="totalCount"
                        [totalErrorMsg]="totalErrorMsg"
                        [contactGroup]="selectedContactGroup$ | async"
                        [orderType]="selectedOrderType$ | async"
                        (onOrderTypeChanged)="onOrderTypeChanged($event)"
                        (onContactGroupChanged)="onContactGroupChanged($event)">
        </orders-header-dropdown>
        <import-progress-bar></import-progress-bar>
    </app-headline>
    <div [hidden]="selectedOrderType.value !== orderTypesEnum.Order">
        <app-toolbar [config]="ordersToolbarConfig"
                     [hidden]="appService.toolbarIsHidden$ | async">
        </app-toolbar>
        <div class="main-wrapper">
            <app-static-list
                    [width]="'210px'"
                    [title]="l('Stages')"
                    [relatedItemsKeys]="selectedOrderKeys"
                    [filterModel]="filterModelStages"
                    [bulkUpdatePermissionKey]="permissions.CRMBulkUpdates"
                    [updateConfirmationTitle]="l('LeadStatusUpdateConfirmationTitle')"
                    [updateConfirmationMessage]="l('LeadsUpdateStatusWarningMessage')"
                    targetSelector="[aria-label='{{l('Toolbar_Stage')}}']"
                    [funnelStyling]="true"
                    [list]="stages"
                    (onItemSelected)="updateOrdersStage($event)">
            </app-static-list>
            <div [hidden]="isDataLoaded && !totalRowCount || showOrdersPipeline" class="portlet light no-padding margin-bottom-0">
                <div class="portlet-body">
                    <div>
                        <div>
                            <ghost-list *ngIf="!isDataLoaded"></ghost-list>
                            <dx-data-grid #ordersGrid
                                          class="main-component-view limitedPagerTotal"
                                          accesskey="narrowHeaderPanel"
                                          [hint]="l('Orders')"
                                          [renderAsync]="true"
                                          [allowColumnReordering]="true"
                                          [columnAutoWidth]="true"
                                          [allowColumnResizing]="true"
                                          [hoverStateEnabled]="true"
                                          [loadPanel]="{ enabled: false }"
                                          [columnChooser]="{
                                            height: rowsViewHeight
                                          }"
                                          [remoteOperations]="{
                                            filtering: false,
                                            grouping: false,
                                            groupPaging: true,
                                            paging: true,
                                            sorting: true,
                                            summary: true
                                          }"
                                          (onEditingStart)="toggleActionsMenu($event)"
                                          (onCellClick)="onCellClick($event)"
                                          (onOptionChanged)="onGridOptionChanged($event)"
                                          (onContentReady)="onContentReady($event)"
                                          (onSelectionChanged)="onSelectionChanged($event)"
                                          (onDataErrorOccurred)="httpInterceptor.handleError($event.error)">
                                <dxo-pager [visible]="true"></dxo-pager>
                                <dxo-selection selectAllMode="page"
                                               showCheckBoxesMode="always"
                                               mode="multiple">
                                </dxo-selection>
                                <dxo-editing mode="popup"
                                            [texts]="{editRow: ''}"
                                            [popup]="{ onShowing: onShowingPopup, height: '0px', width: '0px' }"
                                            [allowUpdating]="true">
                                </dxo-editing>
                                <dxo-scrolling mode="infinite"></dxo-scrolling>

                                <dxi-column [dataField]="orderFields.Id" [caption]="l('Id')" [visible]="false"></dxi-column>
                                <dxi-column [dataField]="orderFields.PhotoPublicId" caption=" " cellTemplate="photoTemplate"
                                            [width]="50" [showInColumnChooser]="false" [allowExporting]="false"
                                            [allowGrouping]="false" [allowSorting]="false">
                                </dxi-column>
                                <div *dxTemplate="let data of 'photoTemplate'">
                                    <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(data.data.PhotoPublicId) + ')'}" class="img-circle"></div>
                                </div>
                                <dxi-column [dataField]="orderFields.Name" [caption]="l('Customer.Name')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Email" [caption]="l('Contact.Email')"></dxi-column>
                                <dxi-column [dataField]="orderFields.State" [caption]="l('State')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Phone"
                                            [renderAsync]="true"
                                            [caption]="l('Contact.Phone')"
                                            [visible]="false" cellTemplate="phoneCell"
                                            [editorOptions]="{
                                                mask: masks.phone,
                                                maskInvalidMessage: l('PhoneValidationError')
                                            }">
                                </dxi-column>
                                <dxi-column [dataField]="orderFields.Number" [caption]="l('Number')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Stage" [caption]="l('Stage')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Amount" [caption]="l('Amount')" cellTemplate="amountCell" [width]="185" cssClass="padding-right" ></dxi-column>
                                <dxi-column [dataField]="orderFields.OrderType" [caption]="l('Type')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.AffiliateContactAffiliateCode" [caption]="l('AffiliateContactAffiliateCode')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.AffiliateContactId" [caption]="l('AffiliateContactId')" [visible]="false" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.AffiliateContactName" [caption]="l('AffiliateContactName')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.OrderDate" [caption]="l('Created')" sortOrder="desc" cellTemplate="dateCell" cssClass="tabular"></dxi-column>
                                <dxi-column [dataField]="orderFields.PersonalAffiliateCode" [caption]="l('ContactAffiliateCode')" [visible]="false"></dxi-column>
                                <dxi-column [dataField]="orderFields.SourceAffiliateCode" [caption]="l('SourceAffiliateCode')" [visible]="false"></dxi-column>
                                <dxi-column [dataField]="orderFields.SourceEntryUrl" [width]="300" [caption]="l('EntryUrl')" [visible]="false" ></dxi-column>
                                <dxi-column [dataField]="orderFields.ContactGroupId" [caption]="l('ContactGroup')" [visible]="false" >
                                    <dxo-lookup [dataSource]="contactGroupDataSource" valueExpr="id" displayExpr="name"></dxo-lookup>
                                </dxi-column>
                                <dxo-sorting mode="multiple"></dxo-sorting>
                                <dxo-group-panel [visible]="true"></dxo-group-panel>
                                <dxo-paging [pageSize]="20" [enabled]="true" [pageIndex]="0"></dxo-paging>
                                <div *dxTemplate="let cellData of 'phoneCell'" class="clipboard-holder">
                                    {{cellData.value | phone}}
                                </div>
                                <div *dxTemplate="let cellData of 'amountCell'" class="clipboard-holder">
                                    {{cellData.value | currency: currency}}
                                </div>
                                <div *dxTemplate="let cellData of 'dateCell'" class="clipboard-holder">
                                    {{cellData.value | datetime: formatting.dateTimeMoment}}
                                </div>
                                <dxo-summary>
                                    <dxi-group-item [column]="orderFields.Id"
                                                    summaryType="count"
                                                    [displayFormat]="'{0} ' + l('Orders').toLowerCase()">
                                    </dxi-group-item>
                                    <dxi-group-item [column]="orderFields.Amount"
                                                    summaryType="sum"
                                                    [customizeText]="customizeAmountCell"
                                                    [alignByColumn]="true"
                                                    [displayFormat]="l('Total') + ': {0}'">
                                    </dxi-group-item>
                                    <dxi-total-item [column]="orderFields.Name"
                                                    summaryType="count"
                                                    [customizeText]="customizeTotal">
                                    </dxi-total-item>
                                    <dxi-total-item [customizeText]="customizeOrdersSum"
                                                    [column]="orderFields.Amount"
                                                    summaryType="sum">
                                    </dxi-total-item>
                                </dxo-summary>
                            </dx-data-grid>
                        </div>
                    </div>
                </div>
            </div>
            <div [hidden]="!showOrdersPipeline" class="portlet light no-padding margin-bottom-0">
                <div class="portlet-body">
                    <div class="funnel-wrapper main-component-view">
                        <app-pipeline
                                totalsURI="OrderCount"
                                dragulaName="orderStages"
                                [dataSource]="pipelineDataSource"
                                [selectFields]="['Id', 'ContactId', 'Name', 'CompanyName', 'OrderDate', 'PhotoPublicId', 'LeadId', 'ContactGroupId', 'Phone', 'Amount']"
                                dateField="OrderDate"
                                [contactGroupId]="null"
                                [actionMenuGroups]="actionMenuGroups"
                                [pipelinePurposeId]="pipelinePurposeId"
                                [filterModelStages]="filterModelStages"
                                [moveDisabled]="manageDisabled"
                                [(selectedEntities)]="selectedOrders"
                                (onEntityStageChanged)="onOrderStageChanged($event)"
                                (onStagesLoaded)="onStagesLoaded($event)"
                                (onCardClick)="onCardClick($event)"
                                (onTotalChange)="updateTotalCount($event)">
                            Loading...
                        </app-pipeline>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div [hidden]="selectedOrderType.value !== orderTypesEnum.Subscription">
        <app-toolbar [config]="subscriptionsToolbarConfig"
                     [hidden]="appService.toolbarIsHidden$ | async">
        </app-toolbar>
        <div class="main-wrapper">
            <div [hidden]="subscriptionsDataLayoutType !== layoutTypes.DataGrid">
                <ghost-list *ngIf="!isDataLoaded"></ghost-list>
                <dx-data-grid #subscriptionsGrid
                              class="main-component-view limitedPagerTotal"
                              accesskey="narrowHeaderPanel"
                              keyExpr="id"
                              [hint]="l('Subscriptions')"
                              [loadPanel]="{ enabled: false }"
                              [allowColumnReordering]="true"
                              [columnAutoWidth]="true"
                              [columnChooser]="{
                                height: rowsViewHeight
                              }"
                              [hoverStateEnabled]="true"
                              [remoteOperations]="{
                                  filtering: false,
                                  grouping: false,
                                  groupPaging: true,
                                  paging: true,
                                  sorting: true,
                                  summary: true
                              }"
                              [allowColumnResizing]="true"
                              (onEditingStart)="toggleActionsMenu($event)"
                              (onCellClick)="onCellClick($event, 'subscriptions')"
                              (onOptionChanged)="onGridOptionChanged($event)"
                              (onContentReady)="onContentReady($event)">
                    <dxo-pager [visible]="true"></dxo-pager>
                    <dxo-sorting mode="multiple"></dxo-sorting>
                    <dxo-group-panel [visible]="true"></dxo-group-panel>
                    <dxo-selection selectAllMode="page"
                                   showCheckBoxesMode="always"
                                   mode="multiple">
                    </dxo-selection>
                    <dxo-scrolling mode="infinite"></dxo-scrolling>

                    <dxo-editing mode="popup"
                                [texts]="{editRow: ''}"
                                [popup]="{ onShowing: onShowingPopup, height: '0px', width: '0px' }"
                                [allowUpdating]="true">
                    </dxo-editing>

                    <dxi-column [dataField]="subscriptionFields.Id" [visible]="false" sortOrder="desc" [sortIndex]="0"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.PhotoPublicId" caption=" " cellTemplate="photoTemplate"
                                [width]="50" [showInColumnChooser]="false" [allowExporting]="false"
                                [allowGrouping]="false" [allowSorting]="false">
                    </dxi-column>
                    <dxi-column [dataField]="subscriptionFields.ContactId" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.FirstName" [caption]="l('FirstName')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.LastName" [caption]="l('LastName')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.EmailAddress" [caption]="l('Contact.Email')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.PhoneNumber" [caption]="l('Contact.Phone')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.City" [caption]="l('Contact.City')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.StateName" [caption]="l('Contact.State')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.Zip" [caption]="l('ZipCode')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.CountryCode" [caption]="l('CountryCode')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.PersonalAffiliateCode" [caption]="l('ContactAffiliateCode')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.ContactDate" [caption]="l('Contact.Date')" cellTemplate="dateCell" cssClass="tabular"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.ProductName" [caption]="l('Subscriptions.ProductName')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.StartDate" [caption]="l('StartDate')" cellTemplate="dateCell" cssClass="tabular"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.EndDate" [caption]="l('EndDate')" cellTemplate="dateCell" cssClass="tabular"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.Fee" [width]="170" cssClass="padding-right" [caption]="l('Fee')" cellTemplate="amountTemplate"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.StatusName" [caption]="l('Status')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.OrderAmount" [width]="190" cssClass="padding-right" [caption]="l('OrderAmount')" cellTemplate="amountTemplate"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.SourceAffiliateCode" [caption]="l('SourceAffiliateCode')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.SourceEntryUrl" [width]="300" [caption]="l('EntryUrl')" [visible]="false" ></dxi-column>  
                    <dxi-column [dataField]="subscriptionFields.ContactGroupId" [caption]="l('ContactGroup')" [visible]="false" >
                        <dxo-lookup [dataSource]="contactGroupDataSource" valueExpr="id" displayExpr="name"></dxo-lookup>
                    </dxi-column>
  
                    <div *dxTemplate="let data of 'photoTemplate'">
                        <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(data.data.PhotoPublicId) + ')'}" class="img-circle"></div>
                    </div>
                    <div *dxTemplate="let cellData of 'dateCell'" class="clipboard-holder">
                        {{cellData.value | datetime: formatting.dateMoment}}
                    </div>
                    <div *dxTemplate="let cell of 'amountTemplate'" class="clipboard-holder">
                        <span *ngIf="cell.text >= 0"> {{ cell.text | currency:currency:'symbol':'1.2-2' }} </span>
                    </div>
                    <dxo-summary>
                        <dxo-texts sum="{0}"></dxo-texts>
                        <dxi-group-item [column]="subscriptionFields.Id"
                                        summaryType="count"
                                        [displayFormat]="'{0} ' + l('Subscriptions')">
                        </dxi-group-item>
                        <dxi-group-item [column]="subscriptionFields.Fee"
                                        summaryType="sum"
                                        [alignByColumn]="true"
                                        [customizeText]="customizeAmountCell"
                                        displayFormat="Total: {0}">
                        </dxi-group-item>
                        <dxi-group-item [column]="subscriptionFields.OrderAmount"
                                        summaryType="sum"
                                        [customizeText]="customizeAmountCell"
                                        [alignByColumn]="true"
                                        displayFormat="Total: {0}">
                        </dxi-group-item>
                        <dxi-total-item [column]="subscriptionFields.FirstName"
                                        summaryType="count"
                                        [customizeText]="customizeTotal">
                        </dxi-total-item>
                        <dxi-total-item [customizeText]="customizeSubscriptionsTotalFee"
                                        [column]="subscriptionFields.Fee"
                                        summaryType="sum">
                        </dxi-total-item>
                        <dxi-total-item [customizeText]="customizeSubscriptionsTotalAmount"
                                        [column]="subscriptionFields.OrderAmount"
                                        summaryType="sum">
                        </dxi-total-item>
                    </dxo-summary>
                </dx-data-grid>
            </div>
            <slice-pivot-grid [hidden]="subscriptionsDataLayoutType !== layoutTypes.PivotGrid"
                              [storageKey]="sliceStorageKey"
                              [isLoading]="pivotGridDataIsLoading"
                              [height]="contentHeight$ | async">
            </slice-pivot-grid>
        </div>
    </div>
</div>

<app-no-data
    [hidden]="!isDataLoaded || totalRowCount"
    [showLink]="false">
</app-no-data>
