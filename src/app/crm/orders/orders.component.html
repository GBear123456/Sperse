<div>
    <app-headline icon="briefcase"
                  [buttons]="headlineButtons"
                  [showToggleToolbarButton]="true"
                  [showToggleCompactViewButton]="true"
                  [showReloadButton]="ui.showReload"
                  [showToggleColumnSelectorButton]="showToggleColumnSelectorButton"
                  [showToggleFullScreenButton]="true"
                  (onToggleCompactView)="toggleContactView()"
                  (onToggleToolbar)="toggleToolbar()"
                  (onReload)="invalidate()"
                  (onToggleColumnSelector)="toggleColumnChooser()">
        <types-dropdown [items]="orderTypes"
                        [totalCount]="totalCount"
                        [(value)]="selectedOrderType"
                        (onValueChanged)="onOrderTypeChanged($event)">
        </types-dropdown>
        <import-progress-bar></import-progress-bar>
    </app-headline>
    <div [hidden]="selectedOrderType !== orderTypesEnum.Order">
        <app-toolbar [config]="ordersToolbarConfig" [hidden]="appService.toolbarIsHidden$ | async"></app-toolbar>
        <div class="main-wrapper">
            <app-static-list
                    [width]="'210px'"
                    [title]="l('Stages')"
                    [selectedKeys]="selectedOrderKeys"
                    [filterModel]="filterModelStages"
                    [bulkUpdatePermissionKey]="permissions.CRMBulkUpdates"
                    [updateConfirmationTitle]="l('LeadStatusUpdateConfirmationTitle')"
                    [updateConfirmationMessage]="l('LeadsUpdateStatusWarningMessage')"
                    targetSelector="[aria-label='{{l('Toolbar_Stage')}}']"
                    [funnelStyling]="true"
                    [list]="stages"
                    (onItemSelected)="updateOrdersStage($event)">
            </app-static-list>
            <div [hidden]="isDataLoaded && !totalRowCount || showOrdersPipeline" class="portlet light no-padding margin-bottom-0">
                <div class="portlet-body">
                    <div>
                        <div>
                            <ghost-list *ngIf="!isDataLoaded"></ghost-list>
                            <dx-data-grid #ordersGrid
                                          class="main-component-view"
                                          accesskey="narrowHeaderPanel"
                                          [renderAsync]="true"
                                          [allowColumnReordering]="true"
                                          [columnAutoWidth]="true"
                                          [allowColumnResizing]="true"
                                          [hoverStateEnabled]="true"
                                          [loadPanel]="{ enabled: false }"
                                          [columnChooser]="{
                                            height: rowsViewHeight
                                          }"
                                          [remoteOperations]="{ filtering: false, grouping: false, groupPaging: true, paging: true, sorting: true, summary: true }"
                                          (onEditingStart)="onCellClick($event)"
                                          (onCellClick)="onCellClick($event)"
                                          [pager]="defaultGridPagerConfig"
                                          (onOptionChanged)="onGridOptionChanged($event)"
                                          (onContentReady)="onContentReady($event)"
                                          (onSelectionChanged)="onSelectionChanged($event)"
                                          (onDataErrorOccurred)="httpInterceptor.handleError($event.error)">
                                <dxo-selection selectAllMode="page"
                                               showCheckBoxesMode="always"
                                               mode="multiple">
                                </dxo-selection>
                                <dxo-editing mode="popup"
                                            [texts]="{editRow: ''}"
                                            [popup]="{ onShowing: onShowingPopup, height: '0px', width: '0px' }"
                                            [allowUpdating]="true">
                                </dxo-editing>
                                <dxo-scrolling rowRenderingMode="virtual"></dxo-scrolling>
                                <dxi-column cssClass="stars"
                                            [width]="40"
                                            [showInColumnChooser]="false"
                                            [allowExporting]="false">
                                </dxi-column>
                                <dxi-column [dataField]="orderFields.Id" [caption]="l('Id')" [visible]="false"></dxi-column>
                                <dxi-column [dataField]="orderFields.PhotoPublicId" caption=" " cellTemplate="photoTemplate"
                                            [width]="50" [showInColumnChooser]="false" [allowExporting]="false"
                                            [allowGrouping]="false" [allowSorting]="false"></dxi-column>
                                <div *dxTemplate="let data of 'photoTemplate'">
                                    <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(data.data.PhotoPublicId) + ')'}" class="img-circle"></div>
                                </div>
                                <dxi-column [dataField]="orderFields.Name" [caption]="l('Customer.Name')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Email" [caption]="l('Contact.Email')"></dxi-column>
                                <dxi-column [dataField]="orderFields.State" [caption]="l('State')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Phone"
                                            [renderAsync]="true"
                                            [caption]="l('Contact.Phone')"
                                            [visible]="false" cellTemplate="phoneCell"
                                            [editorOptions]="{
                                                mask: masks.phone,
                                                maskInvalidMessage: l('PhoneValidationError')
                                            }">
                                </dxi-column>
                                <dxi-column [dataField]="orderFields.Number" [caption]="l('Number')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Stage" [caption]="l('Stage')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.Amount" [caption]="l('Amount')" cellTemplate="amountCell" [width]="185" cssClass="padding-right" ></dxi-column>
                                <dxi-column [dataField]="orderFields.OrderType" [caption]="l('Type')" cssClass="clipboard-holder"></dxi-column>
                                <dxi-column [dataField]="orderFields.OrderDate" [caption]="l('Created')" sortOrder="desc" cellTemplate="dateCell"></dxi-column>
                                <dxi-column [dataField]="orderFields.PersonalAffiliateCode" [caption]="l('ContactAffiliateCode')" [visible]="false"></dxi-column>
                                <dxi-column [dataField]="orderFields.SourceAffiliateCode" [caption]="l('SourceAffiliateCode')" [visible]="false"></dxi-column>
                                <dxi-column [dataField]="orderFields.EntryUrl" [width]="300" [caption]="l('EntryUrl')" [visible]="false" ></dxi-column>
                                <dxo-sorting mode="multiple"></dxo-sorting>
                                <dxo-group-panel [visible]="true"></dxo-group-panel>
                                <dxo-paging [pageSize]="20"></dxo-paging>
                                <div *dxTemplate="let cellData of 'phoneCell'" class="clipboard-holder">
                                    {{cellData.value | phone}}
                                </div>
                                <div *dxTemplate="let cellData of 'amountCell'" class="clipboard-holder">
                                    {{cellData.value | currency: currency}}
                                </div>
                                <div *dxTemplate="let cellData of 'dateCell'" class="clipboard-holder">
                                    {{cellData.value | date: formatting.dateTime : userTimezone}}
                                </div>
                                <dxo-summary>
                                    <dxi-group-item [column]="orderFields.Id"
                                                    summaryType="count"
                                                    [displayFormat]="'{0} ' + l('Orders').toLowerCase()">
                                    </dxi-group-item>
                                    <dxi-group-item [column]="orderFields.Amount"
                                                    summaryType="sum"
                                                    [customizeText]="customizeAmountCell"
                                                    [alignByColumn]="true"
                                                    [displayFormat]="l('Total') + ': {0}'">
                                    </dxi-group-item>
                                    <dxi-total-item [column]="orderFields.Name"
                                                    summaryType="count"
                                                    [customizeText]="customizeTotal">
                                    </dxi-total-item>
                                    <dxi-total-item [customizeText]="customizeOrdersSum"
                                                    [column]="orderFields.Amount"
                                                    summaryType="sum">
                                    </dxi-total-item>
                                </dxo-summary>
                            </dx-data-grid>
                        </div>
                    </div>
                </div>
            </div>
            <div [hidden]="!showOrdersPipeline" class="portlet light no-padding margin-bottom-0">
                <div class="portlet-body">
                    <div class="funnel-wrapper main-component-view">
                        <app-pipeline
                                totalsURI="OrderCount"
                                dragulaName="orderStages"
                                [dataSource]="pipelineDataSource"
                                [selectFields]="['Id', 'ContactId', 'Name', 'CompanyName', 'OrderDate', 'PhotoPublicId', 'LeadId']"
                                dateField="OrderDate"
                                [pipelinePurposeId]="pipelinePurposeId"
                                [filterModelStages]="filterModelStages"
                                [moveDisabled]="manageDisabled"
                                [(selectedEntities)]="selectedOrders"
                                (onEntityStageChanged)="onOrderStageChanged($event)"
                                (onStagesLoaded)="onStagesLoaded($event)"
                                (onCardClick)="onCardClick($event)"
                                (onTotalChange)="updateTotalCount($event)">
                            Loading...
                        </app-pipeline>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div [hidden]="selectedOrderType !== orderTypesEnum.Subscription">
        <app-toolbar [config]="subscriptionsToolbarConfig" [hidden]="appService.toolbarIsHidden$ | async"></app-toolbar>
        <div class="main-wrapper">
            <div [hidden]="subscriptionsDataLayoutType !== layoutTypes.DataGrid">
                <ghost-list *ngIf="!isDataLoaded"></ghost-list>
                <dx-data-grid #subscriptionsGrid
                              id="gridContainer"
                              class="main-component-view"
                              accesskey="narrowHeaderPanel"
                              keyExpr="id"
                              [loadPanel]="{ enabled: false }"
                              [allowColumnReordering]="true"
                              [columnAutoWidth]="true"
                              [columnChooser]="{
                                height: rowsViewHeight
                              }"
                              [pager]="defaultGridPagerConfig"
                              [hoverStateEnabled]="true"
                              [remoteOperations]="{
                                  filtering: false,
                                  grouping: false,
                                  groupPaging: true,
                                  paging: true,
                                  sorting: true,
                                  summary: true
                              }"
                              [allowColumnResizing]="true"
                              (onCellClick)="onCellClick($event, 'subscriptions')"
                              (onContentReady)="onContentReady($event)">
                    <dxo-sorting mode="multiple"></dxo-sorting>
                    <dxo-group-panel [visible]="true"></dxo-group-panel>
                    <dxo-selection selectAllMode="page"
                                   showCheckBoxesMode="always"
                                   mode="multiple">
                    </dxo-selection>
                    <dxi-column [dataField]="subscriptionFields.Id" [visible]="false" sortOrder="desc" [sortIndex]="0"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.PhotoPublicId" caption=" " cellTemplate="photoTemplate"
                                [width]="50" [showInColumnChooser]="false" [allowExporting]="false"
                                [allowGrouping]="false" [allowSorting]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.ContactId" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.FirstName" [caption]="l('FirstName')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.LastName" [caption]="l('LastName')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.EmailAddress" [caption]="l('Contact.Email')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.PhoneNumber" [caption]="l('Contact.Phone')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.City" [caption]="l('Contact.City')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.StateName" [caption]="l('Contact.State')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.Zip" [caption]="l('Contact.Zip')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.CountryCode" [caption]="l('CountryCode')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.PersonalAffiliateCode" [caption]="l('ContactAffiliateCode')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.ContactDate" [caption]="l('Contact.Date')" cellTemplate="dateCell"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.ServiceType" [caption]="l('Subscriptions.ServiceType')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.ServiceName" [caption]="l('Subscriptions.ServiceName')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.StartDate" [caption]="l('StartDate')" cellTemplate="dateCell"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.EndDate" [caption]="l('EndDate')" cellTemplate="dateCell"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.Fee" [width]="170" cssClass="padding-right" [caption]="l('Fee')" cellTemplate="amountTemplate"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.StatusName" [caption]="l('Status')" cssClass="clipboard-holder"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.OrderAmount" [width]="190" cssClass="padding-right" [caption]="l('OrderAmount')" cellTemplate="amountTemplate"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.SourceAffiliateCode" [caption]="l('SourceAffiliateCode')" cssClass="clipboard-holder" [visible]="false"></dxi-column>
                    <dxi-column [dataField]="subscriptionFields.EntryUrl" [width]="300" [caption]="l('EntryUrl')" [visible]="false" ></dxi-column>
                    <div *dxTemplate="let data of 'photoTemplate'">
                        <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(data.data.PhotoPublicId) + ')'}" class="img-circle"></div>
                    </div>
                    <div *dxTemplate="let cellData of 'dateCell'" class="clipboard-holder">
                        {{cellData.value | date: formatting.date : userTimezone }}
                    </div>
                    <div *dxTemplate="let cell of 'amountTemplate'" class="clipboard-holder">
                        <span> {{ cell.text | currency:currency:'symbol':'1.2-2' }} </span>
                    </div>
                    <dxo-summary>
                        <dxo-texts sum="{0}"></dxo-texts>
                        <dxi-group-item [column]="subscriptionFields.Id"
                                        summaryType="count"
                                        [displayFormat]="'{0} ' + l('Subscriptions')">
                        </dxi-group-item>
                        <dxi-group-item [column]="subscriptionFields.Fee"
                                        summaryType="sum"
                                        [alignByColumn]="true"
                                        [customizeText]="customizeAmountCell"
                                        displayFormat="Total: {0}">
                        </dxi-group-item>
                        <dxi-group-item [column]="subscriptionFields.OrderAmount"
                                        summaryType="sum"
                                        [customizeText]="customizeAmountCell"
                                        [alignByColumn]="true"
                                        displayFormat="Total: {0}">
                        </dxi-group-item>
                        <dxi-total-item [column]="subscriptionFields.FirstName"
                                        summaryType="count"
                                        [customizeText]="customizeSubscriptionsTotal">
                        </dxi-total-item>
                        <dxi-total-item [customizeText]="customizeSubscriptionsTotalFee"
                                        [column]="subscriptionFields.Fee"
                                        summaryType="sum">
                        </dxi-total-item>
                        <dxi-total-item [customizeText]="customizeSubscriptionsTotalAmount"
                                        [column]="subscriptionFields.OrderAmount"
                                        summaryType="sum">
                        </dxi-total-item>
                    </dxo-summary>
                </dx-data-grid>
            </div>
            <slice-pivot-grid [hidden]="subscriptionsDataLayoutType !== layoutTypes.PivotGrid"
                              [storageKey]="sliceStorageKey"
                              [isLoading]="pivotGridDataIsLoading"
                              [height]="contentHeight$ | async">
            </slice-pivot-grid>
        </div>
    </div>
</div>

<app-no-data
    [hidden]="!isDataLoaded || totalRowCount"
    [showLink]="false">
</app-no-data>
