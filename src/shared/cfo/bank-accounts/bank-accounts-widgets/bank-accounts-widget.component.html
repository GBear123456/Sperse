<div class="header" #header [hidden]="!showHeader">
    <div class="row first-sub-header">
        <search-input [width]="searchInputWidth" (onInput)="searchChanged($event)" [value]="bankAccountsService.searchValue.value"></search-input>
        <sort-button [items]="sortItems" (onChange)="changeSorting($event)"></sort-button>
        <expand-button [items]="expandItems" (onExpand)="expand($event)"></expand-button>
        <add-account-button *ngIf="showAddAccountButton" 
            (onComplete)="refresh()"
            (onClosed)="refresh(true)">
        </add-account-button>
    </div>
    <div class="row second-sub-header">
        <div class="left-header col-sm-12">
            <div class="row">
                <div class="col-4 col-sm-5 entities">
                    <dx-check-box [value]="bankAccountsService.allSyncAccountAreSelected$ | async"
                                  (onValueChanged)="selectAll($event)">
                    </dx-check-box>
                    <business-entities-chooser
                        [applyFilter]="false"
                        [staticItemsText]="l('Entities')"
                        (selectionChanged)="entitiesItemsChanged($event)">
                    </business-entities-chooser>
                </div>
                <div class="col-3 types">
                    <selection-filter
                        [allItemsText]="l('All_Types')"
                        title=""
                        popupWidth="250px"
                        [showSelectedCount]="false"
                        [allSelectedTitle]="true"
                        [itemsText]="l('Type')"
                        [selectionList]="bankAccountsService.existingBankAccountsTypesWithFilteredCounts$ | async"
                        [selectedItems]="bankAccountsService.selectedBankAccountTypes$ | async"
                        (selectionChanged)="bankAccountTypesChanged($event)">
                    </selection-filter>
                </div>
                <div class="col-5 col-sm-4 is-active-filter">
                    <selection-filter
                        [allItemsText]="l('All_Statuses')"
                        title=""
                        popupWidth="150px"
                        [showSelectedCount]="false"
                        [itemsText]="l('Statuses')"
                        [allSelectedTitle]="true"
                        [selectionList]="bankAccountsService.allStatuses"
                        [selectedItems]="bankAccountsService.selectedStatuses$ | async"
                        (selectionChanged)="statusesChanged($event)">
                    </selection-filter>
                    <a *ngIf="clearButtonIsVisible$ | async" class="clear-button" (click)="clearFilters()">{{ l('Clear') }}</a>
                </div>
            </div>
        </div>
        <div class="right-header col-sm-12">
            <div class="row">
                <div [ngClass]="accessAllDepartments ? 'col-sm-3 connections' : 'col-sm-6'"><info-component imgSrc="assets/common/icons/total-icon.svg" [value]="bankAccountsService.syncAccountsAmount$ | async" [description]="l('Connections')"></info-component></div>
                <div [ngClass]="accessAllDepartments ? 'col-sm-3 accounts' : 'col-sm-6'"><info-component imgSrc="assets/common/icons/total-icon.svg" [value]="bankAccountsService.accountsAmount$ | async" [description]="l('Accounts')"></info-component></div>
                <div class="col-sm-6 current-balance" *ngIf="accessAllDepartments">
                    <info-component imgSrc="assets/common/icons/coins-icon.svg"
                                    [value]="bankAccountsService.accountsDataTotalNetWorth$ | async | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2'"
                                    [description]="l('Current_Balance')">
                    </info-component>
                </div>
            </div>
        </div>
    </div>
</div>
<div [ngClass]="{ 'grid-container': true, 'highlight-used-rows' : highlightUsedRows }">
    <ghost-list [hidden]="isDataLoaded"></ghost-list>
    <dx-data-grid id="gridContainer"
                  class="alone"
                  width="99.9%"
                  [renderAsync]="true"
                  [height]="calculateHeight()"
                  [dataSource]="dataSource"
                  noDataText=""
                  [masterDetail]="{ enabled: false, template: 'detail' }"
                  keyExpr="syncAccountId"
                  [showColumnHeaders]="showColumnHeaders"
                  [columnAutoWidth]="false"
                  [showBorders]="false"
                  [showColumnLines]="false"
                  [showRowLines]="false"
                  [scrolling]="{ showScrollbar: 'onHover' }"
                  [loadPanel]="{ enabled: false }"
                  [elementAttr]="{ class: 'with-custom-loader' }"
                  (onRowPrepared)="rowPrepared($event)"
                  (onContentReady)="contentReady($event)"
                  (onRowClick)="dataRowClick($event)"
                  (onCellClick)="dataCellClick($event)">
        <dxo-editing mode="cell" [allowUpdating]="false"></dxo-editing>
        <dxo-paging [enabled]="false"></dxo-paging>
        <dxo-filter-row [visible]="false"></dxo-filter-row>
        <dxi-column dataField="id"
                    [visible]="false"
                    sortOrder="desc"
                    cssClass="clipboard-holder">
        </dxi-column>
        <dxi-column dataField="selected"
                    caption=""
                    [width]="44"
                    [visibleIndex]="1"
                    [visible]="showCheckboxes"
                    cssClass="checkbox clipboard-holder"
                    alignment="center"
                    dataType="boolean">
        </dxi-column>
        <dxi-column dataField="name"
                    [visibleIndex]="2"
                    [caption]="l('Account')"
                    [sortIndex]="0"
                    sortOrder="asc"
                    [width]="nameColumnWidth || (wide ? 600 : (widgetWidth > 1100 ? 350 : 200))"
                    alignment="left"
                    [allowEditing]="false"
                    cssClass="accountNumber bold clipboard-holder">
        </dxi-column>
        <dxi-column dataField="bankAccounts.length"
                    [visibleIndex]="3"
                    [visible]="showAdvancedColumns && showAccountsCount"
                    [width]="70"
                    [sortIndex]="1"
                    sortOrder="asc"
                    [calculateSortValue]="calculateSyncAccountSortValue"
                    alignment="right"
                    [calculateDisplayValue]="calculateSyncAccountDisplayValue"
                    [allowEditing]="false">
        </dxi-column>
        <dxi-column [width]="wide ? 30 : 50"
                    alignment="right"
                    [allowEditing]="false"
                    [visibleIndex]="4"
                    [visible]="showAdvancedColumns && showAccountsCount"
                    cellTemplate="expandTemplate">
        </dxi-column>
        <dxi-column dataField="lastSyncDate"
                    alignment="left"
                    [caption]="l('BankAccountsWidget_Last_sync')"
                    [width]="180"
                    [allowEditing]="false"
                    cellTemplate="syncDateTemplate"
                    [visibleIndex]="5"
                    [visible]="showSyncDate">
        </dxi-column>
        <dxi-column dataField="syncAccountStatus"
                    [visibleIndex]="6"
                    [visible]="showStatus"
                    [caption]="l('BankAccountsWidget_Sync_status')"
                    [width]="showStatusText ? 170 : 20"
                    alignment="center"
                    sortOrder="asc"
                    [sortIndex]="2"
                    cellTemplate="statusTemplate"
                    [allowEditing]="false">
        </dxi-column>
        <dxi-column alignment="right"
                    [visibleIndex]="7"
                    [visible]="!accessAllDepartments">
        </dxi-column>
        <dxi-column dataField="balance"
                    cssClass="balance"
                    [minWidth]="70"
                    [width]="balanceColumnWidth"
                    [caption]="l('BankAccountsWidget_Value')"
                    cellTemplate="amountTemplate"
                    alignment="right"
                    [allowEditing]="false"
                    [calculateDisplayValue]="calculateBalanceDisplayValue"
                    [visibleIndex]="8"
                    [visible]="accessAllDepartments">
        </dxi-column>
        <dxi-column dataField="syncRef"
                    [width]="40"
                    alignment="right"
                    [allowEditing]="false"
                    [visibleIndex]="10"
                    cellTemplate="actionsTemplate">
        </dxi-column>
        <div *dxTemplate="let syncAccount of 'detail'">
            <div class="bank-accounts-grid-container">
                <dx-data-grid accessKey="detailGrid"
                              [dataSource]="syncAccount?.data?.bankAccounts"
                              [showBorders]="false"
                              width="100%"
                              keyExpr='id'
                              [renderAsync]="true"
                              [showColumnLines]="false"
                              [showRowLines]="false"
                              [columnAutoWidth]="false"
                              [selectionFilter]="['selected', '=', true]"
                              [showColumnHeaders]="false"
                              (onRowPrepared)="rowPrepared($event)"
                              (onCellClick)="detailCellClick($event)"
                              (onEditingStart)="editingStart($event)"
                              (onEditorPrepared)="editorPrepared($event)"
                              (onContentReady)="detailContentReady()"
                              (onRowUpdating)="detailsRowUpdating($event)">
                    <dxo-scrolling showScrollbar="never"></dxo-scrolling>
                    <dxo-editing [mode]="allowEditing ? 'popup': 'row'"
                                 [allowUpdating]="false">
                        <dxo-popup accessKey="accountsEditingPopup"
                                   [height]="340"
                                   [width]="700"
                                   [deferRendering]="true">
                        </dxo-popup>
                    </dxo-editing>
                    <dxo-filter-row [visible]="false"></dxo-filter-row>
                    <dxi-column dataField="id"
                                [allowEditing]="false"
                                [visible]="false"
                                sortOrder="desc"
                                [sortIndex]="0"
                                cssClass="clipboard-holder">
                    </dxi-column>
                    <dxi-column dataField="selected"
                                [visible]="showCheckboxes"
                                cssClass="checkbox clipboard-holder"
                                [visibleIndex]="0"
                                [allowEditing]="false"
                                [width]="44"
                                alignment="left"
                                dataType="boolean"
                                caption="">
                    </dxi-column>
                    <dxi-column dataField="accountName"
                                [visibleIndex]="1"
                                [width]="nameColumnWidth || (wide ? 300 : 250)"
                                alignment="left"
                                [allowEditing]="allowEditing"
                                cellTemplate="withClipboardLink">
                    </dxi-column>
                    <dxi-column dataField="accountNumber"
                                [visible]="showAccountNumber"
                                [visibleIndex]="2"
                                cssClass="accountNumber tabular"
                                cellTemplate="withClipboardLink"
                                [width]="wide || widgetWidth > 1100 ? 150 : 100"
                                alignment="left"
                                [allowEditing]="allowEditing"
                                [editorOptions]="{ disabled: true }">
                    </dxi-column>
                    <dxi-column dataField="typeName"
                                cssClass="type-container"
                                [width]="wide || widgetWidth > 1100 ? 150 : 100"
                                alignment="left"
                                [allowEditing]="false"
                                cellTemplate="typeTemplate"
                                [visible]="showAdvancedColumns && showAccountType">
                    </dxi-column>
                    <dxi-column [width]="100" [visible]="wide"></dxi-column>
                    <dxi-column dataField="lastSyncDate"
                                [width]="wide ? 200 : 120"
                                alignment="right"
                                [allowEditing]="false"
                                cellTemplate="syncDateTemplate"
                                [visible]="showSyncDate">
                    </dxi-column>
                    <dxi-column dataField="syncStatus"
                                [visible]="showBankAccountsStatus"
                                [caption]="l('BankAccountsWidget_Sync_status')"
                                [width]="showStatusText ? 170 : 20"
                                alignment="center"
                                sortOrder="asc"
                                cellTemplate="statusTemplate"
                                [allowEditing]="false">
                    </dxi-column>
                    <dxi-column alignment="right"
                                [visible]="!accessAllDepartments"
                                [allowEditing]="false">
                    </dxi-column>
                    <dxi-column dataField="businessEntityId"
                                [allowEditing]="allowEditing"
                                [visible]="false"
                                editCellTemplate="businessEntityEditSelect">
                    </dxi-column>
                    <dxi-column dataField="isActive"
                                [allowEditing]="allowEditing"
                                [visible]="false">
                    </dxi-column>
                    <dxi-column dataField="balance"
                                cssClass="tabular balance"
                                width="auto"
                                alignment="right"
                                cellTemplate="amountTemplate"
                                [visible]="accessAllDepartments && showAdvancedColumns"
                                [allowEditing]="false">
                    </dxi-column>
                    <dxi-column dataField="availableBalance"
                                [width]="200"
                                cssClass="available-balance"
                                cellTemplate="colorBalanceTemplate"
                                alignment="right"
                                [allowEditing]="false"
                                [visible]="showCreditInfo">
                    </dxi-column>
                    <dxi-column dataField="totalCreditLine"
                                [width]="200"
                                cssClass="totalCreditLine-balance"
                                cellTemplate="colorBalanceTemplate"
                                alignment="right"
                                [allowEditing]="false"
                                [visible]="showCreditInfo">
                    </dxi-column>
                    <dxi-column dataField="utilized"
                                [width]="100"
                                cellTemplate="utilizedTemplate"
                                alignment="right"
                                [allowEditing]="false"
                                [visible]="showCreditInfo">
                    </dxi-column>
                    <div *dxTemplate="let cell of 'withClipboardLink'">
                        <div class="clipboard-holder">
                            {{cell.text}}
                        </div>
                    </div>
                    <div *dxTemplate="let cell of 'amountTemplate'">
                        <div *ngIf="accessAllDepartments && cell.text" class="number-value bold clipboard-holder">
                            {{cell.text | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }}
                        </div>
                    </div>
                    <div *dxTemplate="let cell of 'colorBalanceTemplate'" class="color-div">
                        <div *ngIf="cell.text" class="balance-container clipboard-holder">
                            {{cell.text | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }}
                        </div>
                    </div>
                    <div *dxTemplate="let cell of 'utilizedTemplate'">
                        <div *ngIf="(cell.text)" class="ratioField">
                            <span class="text clipboard-holder">{{ cell.text | number:'1.2-2'}}%</span>
                            <div class="ratioProgressBar">
                                <span class="progress" [style.width]="cell.text + '%'" [style.background-color]="getRatioColor(cell.text)"></span>
                            </div>
                        </div>
                    </div>
                    <div *dxTemplate="let cell of 'typeTemplate'">
                        <span [attr.data-text]="cell.text | lowercase" class="clipboard-holder">{{cell.text}}</span>
                    </div>
                    <div *dxTemplate="let cell of 'businessEntityEditSelect'">
                        <dx-select-box [items]="businessEntities"
                                       displayExpr="name"
                                       displayValue="id"
                                       valueExpr="id"
                                       [(value)]="cell.value"
                                       (onValueChanged)="cell.setValue($event.value)">
                        </dx-select-box>
                    </div>
                    <div *dxTemplate="let cell of 'syncDateTemplate'">
                        <div *ngIf="cell.text; else never"
                             class="sync-date clipboard-holder"
                             [title]="getLastSyncTitle(cell)">
                            {{cell.text | datetime: 'MMM D, YYYY'}}
                        </div>
                        <ng-template #never>
                            {{l('Never')}}
                        </ng-template>
                    </div>
                    <div *dxTemplate="let cell of 'statusTemplate'">
                        <div *ngIf="showStatusText && cell.text"
                             [class]="'account-status ' + cell.text | lowercase"
                             [ngClass]="{'short': !showStatusText}">
                            {{l('SyncStatus_' + cell.text) | uppercase}}
                        </div>
                    </div>
                </dx-data-grid>
            </div>
        </div>
        <div *dxTemplate="let cell of 'amountTemplate'">
            <ng-container *ngIf="(cell.text)">
                <div class="number-value bold clipboard-holder">
                    {{cell.text | currency:cfoPreferencesService.selectedCurrencyId:cfoPreferencesService.selectedCurrencySymbol:'1.2-2' }}
                </div>
            </ng-container>
        </div>
        <div *dxTemplate="let cell of 'statusTemplate'">
            <ng-container *ngIf="cell.text">
                <div [class]="'account-status ' + cell.text | lowercase" [ngClass]="{'short': !showStatusText}" id="account{{cell.key}}">
                    <ng-container *ngIf="showStatusText">
                        <a *ngIf="(cell.text | lowercase) == 'actionrequired' && additionalActionsAllowed; else textBlock"
                           (click)="updateAccountInfo(cell.data, connectionMode.Reconnect)"
                           (mouseenter)="mouseEnter(cell)"
                           (mouseleave)="actionsRequiredTooltipVisible = false">
                            {{l('SyncStatus_' + cell.text) | uppercase}}
                        </a>
                        <ng-template #textBlock>
                            {{l('SyncStatus_' + cell.text) | uppercase}}
                        </ng-template>
                    </ng-container>
                </div>
            </ng-container>
        </div>
        <div *dxTemplate="let cell of 'expandTemplate'">
            <div class="expand-div"></div>
        </div>
        <div *dxTemplate="let cell of 'actionsTemplate'" style="height: 30px;">
            <a *ngIf="allowUpdateAccount && isInstanceAdmin && isMemberAccessManage"
               class="dx-link dx-link-edit options-button" (click)="openActionsMenu(cell)">&nbsp;</a>
        </div>
        <div *dxTemplate="let cell of 'syncDateTemplate'">
            <ng-container *ngIf="cell.text; else never">
                <div class="sync-date clipboard-holder" 
                    [title]="getLastSyncTitle(cell)">
                    Last sync: {{cell.text | datetime: 'MMM D, YYYY'}}
                    <a [hidden]="!cell.data.autoSyncTime" class="time-icon" title="Auto-sync at {{cell.data.autoSyncTime}}"></a>
                    <i class="save-to-clipboard" aria-hidden="true" (click)="copyToClipbord($event, cell.text)"></i>
                </div>
            </ng-container>
            <ng-template #never>
                {{l('Never')}}
            </ng-template>
        </div>
    </dx-data-grid>
</div>
<dx-context-menu [items]="contextMenuItems"
                 target=".options-button"
                 showEvent="dxclick"
                 (onItemClick)="actionsItemClick($event)"
                 [visible]="isContextMenuVisible">
    <div *dxTemplate="let e of 'item'">
        <div *ngIf="!e.hide" class="action-menu-item" [ngClass]="e.text | lowercase">
            {{e.text}}
        </div>
    </div>
</dx-context-menu>
<dx-popup class="popup"
          [width]="350"
          [height]="250"
          [showTitle]="true"
          [title]="l('Edit_Bank_Account_Name')"
          [dragEnabled]="false"
          [closeOnOutsideClick]="true"
          [(visible)]="popupVisible">
    <div *dxTemplate="let data of 'content'">
        <div class="form-group">
            <label for="bankAccountName">Bank Account Name</label>
            <input type="email" class="form-control" id="bankAccountName" #bankName [(value)]="bankAccountInfo.newName">
        </div>
        <button (click)="submitNewBankAccountName(bankName.value)" class="btn btn-layout">{{l("Save")}}</button>
    </div>
</dx-popup>
<dx-tooltip #actionRequiredTooltip
            [position]="{
                  my: 'left top',
                  at: 'left bottom',
                  of: actionsRequiredTooltipTarget
            }"
            [(visible)]="actionsRequiredTooltipVisible">
    <div *dxTemplate="let data = data of 'content'" class="tooltip-data">
        {{ actionsRequiredTooltipText }}
    </div>
</dx-tooltip>
