<ng-container *ngIf="!hideToolbar">
    <app-static-list #stagesList
                     width="210px"
                     [selectedKeys]="[stageId]"
                     [showConfirmation]="false"
                     [selectedItems]=""
                     [hideButtons]="true"
                     [highlightSelected]="true"
                     targetSelector="#CreateLeadStage"
                     (onItemSelected)="onStagesChanged($event)"
                     [showTitle]="false"
                     [list]="stages"
                     [funnelStyling]="true"
                     [disableHindmost]="true">
    </app-static-list>
    <app-static-list #statusesList
            [width]="'180px'"
            [title]="ls.l('Toolbar_Groups')"
            [selectedKeys]="[data.customerType]"
            [showConfirmation]="false"
            [highlightSelected]="true"
            [hideButtons]="true"
            targetSelector="#ClientStatus"
            [list]="statuses"
            [disabled]="true"
            (onItemSelected)="onStatusChanged($event)">
    </app-static-list>
    <source-contact-list
        [selectedKey]="sourceContactId"
        (onItemSelected)="onPartnerSourceSelected($event)">
    </source-contact-list>
    <rating targetSelector="#ClientRating"
            [hideButtons]="true"
            (onValueChanged)="onRatingChanged($event)">
    </rating>
    <types-list targetSelector="#PartnerTypesList"
                [hideButtons]="true"
                (onSelectedChanged)="onPartnerTypeChanged($event)">
    </types-list>
    <tags-list targetSelector="#ClientTags"
               [hideButtons]="true"
               [showSelection]="true"
               (onSelectedChanged)="onTagsSelected($event)">
    </tags-list>
    <lists-list targetSelector="#ClientLists"
                [hideButtons]="true"
                [showSelection]="true"
                (onSelectionChanged)="onListsSelected($event)">
    </lists-list>
    <user-assignment-list
        targetSelector="#ClientAssign"
        [permissionKey]="getAssignmentsPermissionKey()"
        [assignedUsersSelector]="assignedUsersSelector"
        [selectedItemKey]="currentUserId"
        [proxyService]="contactProxy"
        [hideButtons]="true"
        (onSelectionChanged)="onUserAssignmentChanged($event)">
    </user-assignment-list>
</ng-container>

<modal-dialog [title]="title"
              [buttons]="buttons"
              [editTitle]="true"
              [isTitleValid]="isTitleValid"
              [titleClearButton]="true"
              [placeholder]="ls.l('Contact.FullName')"
              (onTitleKeyUp)="onFullNameKeyUp($event)"
              (onContextItemChanged)="onSaveOptionSelectionChanged()">
    <ng-container headerContent>
        <div *ngIf="showPropertyFields" class="property-address" [ngClass]="{'invalid': !isTitleValid}">
            <input *ngIf="!googleAutoComplete"
                   type="text"
                   name="PropertyAddress"
                   [(ngModel)]="property.name"
                   placeholder=""
                   class="dx-texteditor-input"
                   (focus)="isTitleValid = true"
                   (focusout)="checkPropertyNameValid($event)"
                   required/>
            <input *ngIf="googleAutoComplete"
                   type="text"
                   name="Address"
                   [(ngModel)]="property.name"
                   class="dx-texteditor-input"
                   placeholder=""
                   (focus)="isTitleValid = true"
                   (focusout)="checkPropertyNameValid($event)"
                   (onAddressChange)="updatePropertyAddress($event, true)"
                   ngx-google-places-autocomplete
                   required/>
            <span class="placeholder">{{ ls.l('PropertyName') }}</span>
        </div>
    </ng-container>

    <div *ngIf="!hidePhotoArea"
         class="photo-area"
         [ngStyle]="{'background-image': photoOriginalData ? 'url(' + photoOriginalData + ')': ''}"
         (click)="showUploadPhoto($event)">
    </div>

    <dx-toolbar *ngIf="!hideToolbar"
                [ngStyle]="{ paddingLeft: hidePhotoArea ? '12px' : '115px' }"
                (onItemRendered)="toolbarService.onItemRendered($event)">
        <dxi-item location="before" template="clientAssign" [disabled]="isAssignDisabled"></dxi-item>
        <div *dxTemplate="let data of 'clientAssign'">
            <dx-button [icon]="'./assets/common/icons/assign-icon.svg'"
                       [text]="ls.l('Toolbar_Assign')"
                       id="ClientAssign"
                       [ngClass]="{ 'filter-selected': isUserSelected }"
                       (onClick)="toggleUserAssignment()">
            </dx-button>
        </div>

        <dxi-item location="before" template="partnerSource"></dxi-item>
        <div *dxTemplate="let data of 'partnerSource'">
            <dx-button [icon]="'./assets/common/icons/folder.svg'"
                       [text]="ls.l('Toolbar_ReferredBy')"
                       id="PartnersSource"
                       [ngClass]="{ 'filter-selected': isSourceSelected }"
                       (onClick)="togglePartnerSource()">
            </dx-button>
        </div>

        <dxi-item *ngIf="data.isInLeadMode; else notLead" template="stages" location="before"></dxi-item>
        <div *dxTemplate="let data of 'stages'">
            <dx-button
                [icon]="'./assets/common/icons/status-icon.svg'"
                [text]="ls.l('Stage')"
                id="CreateLeadStage"
                [ngClass]="{ 'filter-selected': isStageSelected }"
                (onClick)="toggleStages()">
            </dx-button>
        </div>

        <ng-template #notLead>
            <dxi-item *ngIf="data.customerType === contactGroups.Client" [visible]="false" location="before" template="status"></dxi-item>
            <div *dxTemplate="let data of 'status'">
                <dx-button id="ClientStatus"
                           [text]="ls.l('Group')"
                           [icon]="'./assets/common/icons/status-icon.svg'"
                           [ngClass]="{ 'filter-selected': isStatusSelected }"
                           (onClick)="toggleStatus()">
                </dx-button>
            </div>
        </ng-template>

        <dxi-item *ngIf="data.customerType === contactGroups.Partner" location="before" template="type"></dxi-item>
        <div *dxTemplate="let data of 'type'">
            <dx-button [icon]="'./assets/common/icons/status-icon.svg'"
                       [text]="ls.l('Type')"
                       id="PartnerTypesList"
                       [ngClass]="{ 'filter-selected': isPartnerTypeSelected }"
                       (onClick)="togglePartnerTypes()">
            </dx-button>
        </div>

        <dxi-item location="before" template="lists" [disabled]="isListAndTagsDisabled"></dxi-item>
        <div *dxTemplate="let data of 'lists'">
            <dx-button [icon]="'./assets/common/icons/folder.svg'"
                       [text]="ls.l('Toolbar_Lists')"
                       id="ClientLists"
                       [ngClass]="{ 'filter-selected': isListsSelected }"
                       (onClick)="toggleLists()">
            </dx-button>
        </div>

        <dxi-item location="before" template="tags" [disabled]="isListAndTagsDisabled"></dxi-item>
        <div *dxTemplate="let data of 'tags'">
            <dx-button [icon]="'./assets/common/icons/pen.svg'"
                       [text]="ls.l('Toolbar_Tags')"
                       id="ClientTags"
                       [ngClass]="{ 'filter-selected': isTagsSelected }"
                       (onClick)="toggleTags()">
            </dx-button>
        </div>

        <dxi-item location="before" template="rating" [disabled]="isRatingAndStarsDisabled"></dxi-item>
        <div *dxTemplate="let data of 'rating'">
            <dx-button [icon]="'./assets/common/icons/flag-icon.svg'"
                       [text]="ls.l('Rating')"
                       id="ClientRating"
                       [ngClass]="{ 'filter-selected': isRatingSelected }"
                       (onClick)="toggleRating()">
            </dx-button>
        </div>

        <dxi-item location="after" template="discardTemplate"></dxi-item>
        <div *dxTemplate="let data of 'discardTemplate'">
            <dx-button [icon]="'./assets/common/icons/delete-icon.svg'"
                       [hint]="ls.l('DiscardChanges')"
                       [text]=""
                       class="discard-button"
                       (onClick)="resetFullDialog(true)">
            </dx-button>
        </div>
    </dx-toolbar>
    <div *ngIf="similarCustomersAvailable()"
         class="similar-clients-message" (click)="showSimilarEntities($event)">
        {{ls.l('SimilarRecordsFound')}}
    </div>
    <div class="form-content">
        <dx-scroll-view showScrollbar="onHover" #dialogScroll>
            <dx-validation-group *ngIf="showPropertyFields" class="property-info" #propertyValidationGroup>
                <h3>{{ ls.l('PropertyInfo') }}:</h3>
                <div class="field">
                    <label class="address-label">{{ls.l('Address')}}</label>
                    <address-fields #propertyAddressComponent
                                    [address]="property.address"
                                    [googleAutoComplete]="googleAutoComplete"
                                    [showClearButton]="false"
                                    [showNeighborhood]="true"
                                    (onAddressChanged)="updateAddressFields($event, this.property.address)">
                    </address-fields>
                </div>
                <div class="field">
                    <label class="notes-label">{{ls.l('Notes')}}</label>
                    <dx-text-area name="comment"
                                  width="570px"
                                  height="34px"
                                  [(value)]="property.note">
                    </dx-text-area>
                </div>
                <div class="field">
                    <label class="currency-label">{{ls.l('PurchasePrice')}}</label>
                    <dx-number-box width="270px"
                                   height="34px"
                                   step="0"
                                   [placeholder]="ls.l('Amount')"
                                   [format]="currencyFormat"
                                   [(value)]="dealAmount">
                    </dx-number-box>
                </div>
            </dx-validation-group>
            <dx-validation-group *ngIf="showPropertiesDropdown">
                <div class="field">
                    <label class="property-label">{{ ls.l('Property') }}</label>
                    <dx-select-box class="property-dropdown"
                                   width="570px"
                                   [dataSource]="properties$ | async"
                                   [displayExpr]="leadFields.PropertyName"
                                   [valueExpr]="leadFields.PropertyId"
                                   [placeholder]="ls.l('PropertyDropdownPlaceholder')"
                                   [(value)]="propertyId">
                    </dx-select-box>
                </div>
                <div class="field">
                    <label class="currency-label">{{ls.l('PurchasePrice')}}</label>
                    <dx-number-box width="270px"
                                   height="34px"
                                   step="0"
                                   [placeholder]="ls.l('Amount')"
                                   [format]="currencyFormat"
                                   [(value)]="dealAmount">
                    </dx-number-box>
                </div>
                <div class="field">
                    <label class="currency-label">{{ls.l('MonthlyRent')}}</label>
                    <dx-number-box width="270px"
                                   height="34px"
                                   step="0"
                                   [placeholder]="ls.l('Amount')"
                                   [format]="currencyFormat"
                                   [(value)]="installmentAmount">
                    </dx-number-box>
                </div>                
            </dx-validation-group>
            <dx-validation-group *ngIf="!hideCompanyField"
                                 (onInitialized)="initValidationGroup($event, 'companyValidators')">
                <ng-container *ngIf="showPropertyFields">
                    <h3>{{ ls.l('SellerInformation') }}:</h3>
                    <div class="field">
                        <label class="name-label">{{ls.l('Contact')}}</label>
                        <dx-text-box name="fullName"
                                     [value]="contactName"
                                     [placeholder]="ls.l('Contact.FullName')"
                                     (onValueChanged)="onFullNameChanged($event)"
                                     (onKeyUp)="onFullNameKeyUp($event.element.getElementsByTagName('input')[0].value)">
                            <dx-validator>
                                <dxi-validation-rule type="pattern"
                                                     [pattern]="nameRegex"
                                                     [message]="ls.l('FullNameIsNotValid')">
                                </dxi-validation-rule>
                            </dx-validator>
                        </dx-text-box>
                    </div>
                </ng-container>
                <div class="field">
                    <label class="company-label">{{ls.l('Company')}}</label>
                    <dx-select-box #companyComponent
                                   name="company"
                                   width="270px"
                                   displayExpr="name"
                                   valueExpr="name"
                                   [acceptCustomValue]="true"
                                   [placeholder]="ls.l('CompanyName')"
                                   [(value)]="company"
                                   [dataSource]="companies"
                                   [searchEnabled]="true"
                                   [searchTimeout]="0"
                                   (onInput)="companyLookupItems($event)"
                                   (onOptionChanged)="companyOptionChanged($event)"
                                   (onCustomItemCreating)="onCustomCompanyCreate($event)">
                        <dx-validator>
                            <dxi-validation-rule type="custom"
                                                 [message]="ls.l('CompanyInfoWillNotBeSaved')"
                                                 [validationCallback]="companyValidation">
                            </dxi-validation-rule>
                        </dx-validator>
                    </dx-select-box>
                    <dx-text-box #jobTitleComponent
                                 name="jobTitle"
                                 [placeholder]="ls.l('Job title')"
                                 valueChangeEvent="keyup"
                                 width="270px"
                                 [(value)]="jobTitle"
                                 (onValueChanged)="validateCompanyName()">
                    </dx-text-box>
                    <span [class]="(company || jobTitle) && 'clear-contact' || 'hidden'"
                          (click)="company = jobTitle = ''">
                    <i class="minus-icon"></i>
                </span>
                </div>
            </dx-validation-group>
            <dx-validation-group *ngIf="contact?.emails?.length" (onInitialized)="initValidationGroup($event, 'emailValidators')">
                <div class="field email">
                    <label class="email-label">{{ls.l('Email')}}</label>
                    <div>
                        <div *ngFor="let email of contact.emails; index as i" class="editable-item" [ngClass]="{'first-item': !i}">
                            <div class="drop-down-box-wrapper">
                                <dx-select-box
                                    width="340px"
                                    name="emailType"
                                    [placeholder]="ls.l('Type')"
                                    [dataSource]="emailTypes$ | async"
                                    displayExpr="name"
                                    valueExpr="id"
                                    [(value)]="email.type"
                                    [itemTemplate]="'emailTypeItemTemplate'"
                                    (onValueChanged)="validateCompanyName()">
                                    <div *dxTemplate="let data of 'emailTypeItemTemplate'">
                                        <div class="usage-type-item"><span>{{data.name}}</span><span>{{ls.l('ContactInformation_EmailTypeTooltip_' + data.id)}}</span></div>
                                    </div>
                                </dx-select-box>
                            </div>
                            <dx-text-box #emailComponent
                                         name="email"
                                         width="410px"
                                         [(value)]="email.email"
                                         (onKeyUp)="onEmailKeyUp($event)"
                                         (onValueChanged)="onFieldChanged($event, 'emails', i)"
                                         (onInitialized)="onComponentInitialized($event, 'emails')">
                                <dx-validator>
                                    <dxi-validation-rule type="pattern"
                                                         [pattern]="emailRegEx"
                                                         message="{{ls.l('EmailIsNotValid')}}.">
                                    </dxi-validation-rule>
                                </dx-validator>
                            </dx-text-box>
                            <span [class]="(i || email.email) && 'clear-contact' || 'hidden'"
                                  (click)="emptyOrRemoveInput('emails', i)">
                                <i class="minus-icon"></i>
                            </span>
                        </div>
                        <div *ngIf="!disallowMultipleItems"
                             class="add-new-button"
                             [ngClass]="{ disabled: !addButtonVisible['emails'] }">
                            <span (click)="addNewContact('emails')">{{ls.l('+ Add email')}}</span>
                        </div>
                    </div>
                </div>
            </dx-validation-group>
            <dx-validation-group *ngIf="contact?.phones?.length" (onInitialized)="initValidationGroup($event, 'phoneValidators')">
                <div class="field phone H">
                    <label class="phone-label">{{ls.l('Phone')}}</label>
                    <div>
                        <div *ngFor="let phone of contact.phones; index as i" class="editable-item" [ngClass]="{'first-item': !i}">
                            <div class="drop-down-box-wrapper">
                                <dx-select-box
                                    width="390px"
                                    name="phoneType"
                                    [placeholder]="ls.l('Type')"
                                    [dataSource]="phoneTypes$ | async"
                                    displayExpr="name"
                                    valueExpr="id"
                                    [(value)]="phone.type"
                                    itemTemplate="phoneTypeItemTemplate"
                                    (onValueChanged)="validateCompanyName()">
                                    <div *dxTemplate="let data of 'phoneTypeItemTemplate'">
                                        <div class="usage-type-item"><span style="width: 130px;">{{data.name}}</span><span>{{ls.l('ContactInformation_PhoneTypeTooltip_' + data.id)}}</span></div>
                                    </div>
                                </dx-select-box>
                            </div>
                            <country-phone-number #countryPhoneNumber
                                                  [(phoneNumber)]="phone.number"
                                                  [required]="false"
                                                  (onKeyUp)="onPhoneKeyUp($event)"
                                                  (phoneNumberChange)="onPhoneChanged(countryPhoneNumber, i)"
                                                  (onInitialized)="onPhoneComponentInitialized($event)"
                                                  (onDropDownHover)="dropDownHover($event)">
                            </country-phone-number>
                            <dx-number-box
                                class="tabular"
                                name="phoneExtension"
                                width="50px"
                                [inputAttr]="{ maxlength: 5 }"
                                [placeholder]="ls.l('Ext')"
                                [(value)]="phone.ext">
                                <dx-validator>
                                    <dxi-validation-rule type="stringLength"
                                                         [max]="5"
                                                         message="{{ls.l('PhoneExtensionExceedsMaxSize')}}.">
                                    </dxi-validation-rule>
                                </dx-validator>
                            </dx-number-box>
                            <span [class]="(i || phone.number || phone.ext) && 'clear-contact' || 'hidden'"
                                  (click)="emptyOrRemoveInput('phones', i)">
                                <i class="minus-icon"></i>
                            </span>
                        </div>
                        <div *ngIf="!disallowMultipleItems"
                             class="add-new-button"
                             [ngClass]="{ disabled: !addButtonVisible['phones'] }">
                            <span (click)="addNewContact('phones')">{{ls.l('+ Add phone')}}</span>
                        </div>
                    </div>
                </div>
            </dx-validation-group>
            <dx-validation-group *ngIf="!hideLinksField && contact?.links?.length" (onInitialized)="initValidationGroup($event, 'linkValidators')">
                <div class="field">
                    <label class="link-label">{{ls.l('Links')}}</label>
                    <div>
                        <div *ngFor="let link of contact.links; index as i" class="editable-item" [ngClass]="{'first-item': !i}">
                            <div class="drop-down-box-wrapper">
                                <dx-drop-down-box
                                    width="330px"
                                    name="linkType"
                                    [placeholder]="ls.l('Type')"
                                    displayExpr="name"
                                    valueExpr="id"
                                    accessKey="link-type-dialog"
                                    [value]="link.type"
                                    [dataSource]="linkTypes$ | async"
                                    (onValueChanged)="onLinkTypeChanged($event, i)">
                                    <div *dxTemplate="let contentData of 'content'" style="display:flex;">
                                        <div>
                                            <mat-sidenav mode="side" opened="true" position="start" style="height:50px;width:100%;">
                                                <mat-tab-group (selectedTabChange)="link.isCompany = !!$event.index">
                                                    <mat-tab [label]="ls.l('Person')"></mat-tab>
                                                    <mat-tab [label]="ls.l('Company')"></mat-tab>
                                                </mat-tab-group>
                                            </mat-sidenav>
                                            <dx-list
                                                displayExpr="name"
                                                keyExpr="id"
                                                [dataSource]="linkTypes$ | async"
                                                selectionMode="single"
                                                [pageLoadMode]="'scrollBottom'"
                                                (onSelectionChanged)="link.type = $event.addedItems[0].id"
                                                [itemTemplate]="'linkItemTemplate'">
                                                <div *dxTemplate="let data of 'linkItemTemplate'">
                                                <span><img src="./assets/common/icons/social/{{data.uri || 'OtherLink'}}.svg"
                                                           onError="this.src='./assets/common/icons/social/OtherLink.svg';"
                                                           width="25px" height="25px">&nbsp;&nbsp;&nbsp;{{data.name}}</span>
                                                </div>
                                            </dx-list>
                                        </div>
                                    </div>
                                </dx-drop-down-box>
                            </div>
                            <dx-text-box #linksComponent
                                         name="link"
                                         width="410px"
                                         [(value)]="link.url"
                                         (onValueChanged)="onFieldChanged($event, 'links', i)"
                                         (onInitialized)="onComponentInitialized($event, 'links')">
                                <dx-validator>
                                    <dxi-validation-rule type="pattern"
                                                         [pattern]="urlRegEx"
                                                         message="{{ls.l('LinkIsNotValid')}}.">
                                    </dxi-validation-rule>
                                </dx-validator>
                            </dx-text-box>
                            <span [class]="(i || link.url) && 'clear-contact' || 'hidden'" (click)="emptyOrRemoveInput('links', i)"><i class="minus-icon"></i></span>
                        </div>
                        <div *ngIf="!disallowMultipleItems" class="add-new-button" [ngClass]="{disabled: !addButtonVisible['links']}">
                            <span (click)="addNewContact('links')">{{ls.l('+ Add link')}}</span>
                        </div>
                    </div>
                </div>
            </dx-validation-group>
            <dx-validation-group *ngIf="contact?.addresses?.length">
                <div class="field">
                    <label class="address-label">{{ls.l('Address')}}</label>
                    <div>
                        <div *ngFor="let address of contact.addresses; index as i" class="editable-item">
                            <address-fields [addressTypes]="addressTypes$ | async"
                                            [address]="address"
                                            [googleAutoComplete]="googleAutoComplete"
                                            [showClearButton]="!!((i || address.address ||
                                               address.city || address.state || address.zip ||
                                               address.countryCode) && 'clear-contact' || 'hidden')"
                                            (onCountryUpdate)="updateCountryInfo($event, i)"
                                            (onAddressChanged)="updateContactAddressFields($event, address, i)"
                                            (onAddressTypeChanged)="validateCompanyName()"
                                            (onCustomStateCreated)="onCustomStateCreate($event, i)"
                                            (onAddressRemove)="emptyOrRemoveInput('addresses', i)"
                                            (onCountryChanged)="onCountryChange($event, i)"
                                            (onCityChanged)="checkAddressControls(i)"
                                            (onZipChanged)="checkAddressControls(i)"
                                            (onStateChanged)="checkAddressControls(i)">
                            </address-fields>
                        </div>
                        <div *ngIf="!disallowMultipleItems"
                             class="add-new-button"
                             [ngClass]="{ disabled: !addButtonVisible.addresses }">
                            <span (click)="addNewContact('addresses')">{{ls.l('+ Add address')}}</span>
                        </div>
                    </div>
                </div>
                <div *ngIf="!showPropertyFields && !showPropertiesDropdown" class="field">
                    <label class="currency-label">{{ls.l('Deal')}}</label>
                    <dx-number-box width="270px"
                                   height="34px"
                                   step="0"
                                   [placeholder]="ls.l('Amount')"
                                   [format]="currencyFormat"
                                   [(value)]="dealAmount">
                    </dx-number-box>
                </div>
            </dx-validation-group>
            <div *ngIf="showBankCodeField" class="field bank-code">
                <label>{{ ls.l('BANKCODE') }}</label>
                <bank-code-letters [(bankCode)]="bankCode"
                                   [allowAdd]="true"
                                   [allowEdit]="true"
                                   [updateOnServerAfterEdit]="false"
                                   [editDialogPosition]="{ x: 400 }">
                </bank-code-letters>
            </div>
            <div *ngIf="!hideNotesField" class="field notes">
                <label class="notes-label">{{ls.l('Notes')}}</label>
                <dx-text-area
                    name="comment"
                    width="570px"
                    height="100px"
                    (onKeyUp)="onCommentKeyUp($event)"
                    [(value)]="notes">
                </dx-text-area>
                <span [ngClass]="notes && 'clear-contact' || 'hidden'" (click)="notes = ''"><i class="minus-icon"></i></span>
            </div>
        </dx-scroll-view>
    </div>
</modal-dialog>