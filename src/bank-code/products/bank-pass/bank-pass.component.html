<div class="bank-pass">
    <section *ngIf="hasSubscription$ | async; else noSubscription">
        <div class="header" [ngClass]="{ 'show-ai': showAi$ | async }">
            <div class="search">
                <dx-text-box [placeholder]="ls.l('Search')"
                             [value]="searchValue"
                             [showClearButton]="false"
                             mode="search"
                             (onValueChanged)="searchValueChange($event)">
                </dx-text-box>
            </div>
            <div class="my-access-code">
                <span>{{ ls.l('MyAccessCode') }}: </span>
                <inplace-edit [value]="accessCode$ | async"
                              [editPlaceholder]="ls.l('YourAccessCode')"
                              [isCopyEnabled]="true"
                              [isEditDialogEnabled]="true"
                              [validationRules]="accessCodeValidationRules"
                              [showEditModeOnEditButtonClick]="true"
                              (valueChanged)="accessCodeChanged($event)">
                </inplace-edit>
            </div>
        </div>
        <mat-tab-group (selectedTabChange)="tabChanged($event)">
            <mat-tab [label]="ls.l('MyBankPass').toUpperCase()">
                <access-code-instructions></access-code-instructions>
                <div class="bank-pass-achievements">
                    <h2>{{ ls.l('BankPassAchievements') }}</h2>
                    <div class="achievements-content">
                        <div class="collect-bankcodes">
                            <h6>{{ ls.l('CollectAllBankCodes') }}</h6>
                            <div class="bank-code-groups">
                                <ng-container *ngIf="availableBankCodes$ | async; else loading">
                                    <div *ngFor="let bankCodeGroup of bankCodeGroups; let i = index" class="bank-code-group">
                                        <figure>
                                            <img src="./assets/common/images/bank-code/{{bankCodeGroups[i][0][0]}}1.png"
                                            [alt]="bankCodeGroups[i][0][0]"
                                            srcset="./assets/common/images/bank-code/{{bankCodeGroups[i][0][0]}}1@2x.png 2x, ./assets/common/images/bank-code/{{bankCodeGroups[i][0][0]}}1@3x.png 3x">
                                        </figure>
                                        <div class="title" [ngStyle]="{ background: bankCodeService.getBackgroundColorByLetter(bankCodeGroup[i][0]) }">
                                            {{ bankCodeService.bankCodeConfig[bankCodeGroup[i][0]].definition }}
                                        </div>
                                        <div>
                                            <bank-code-letters *ngFor="let bankCode of bankCodeGroups[i]"
                                                               [bankCode]="bankCode"
                                                               [active]="isBankCodeActive(bankCode) | async">
                                            </bank-code-letters>
                                        </div>
                                    </div>
                                </ng-container>
                                <ng-template #loading>
                                    <loading-spinner></loading-spinner>
                                </ng-template>
                            </div>
                        </div>
                        <div class="collect-badges">
                            <h6>{{ ls.l('CollectAllBadges') }}</h6>
                            <div class="badges">
                                <ng-container  *ngFor="let bankCodeBadge of bankCodeBadges; let i = index">
                                    <img *ngIf="getBadgeImageName(i) | async as badgeImageName"
                                         src="./assets/common/images/bank-code/badges/L{{ badgeImageName }}.png"
                                         [alt]="badgeImageName"
                                         srcset="./assets/common/images/bank-code/badges/L{{ badgeImageName }}@2x.png 2x, ./assets/common/images/bank-code/badges/L{{ badgeImageName }}@3x.png 3x">
                                </ng-container>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="road-tracker">
                    <h2>{{ ls.l('BankPassGoalTracker') }}</h2>
                    <div class="settings">
                        <div>
                            <label>{{ ls.l('WorkDaysPerWeek') }}</label>
                            <dx-select-box [items]="workDaysPerWeekValues"></dx-select-box>
                        </div>
                        <div>
                            <label>{{ ls.l('Goal') }}</label>
                            <dx-select-box [items]="goalValues"></dx-select-box>
                        </div>
                        <div>
                            <label>{{ ls.l('GoalType') }}</label>
                            <dx-select-box [items]="goalTypes"
                                           displayExpr="text">
                            </dx-select-box>
                        </div>
                        <button class="update">{{ ls.l('Update') }}</button>
                    </div>
                    <div class="goals">
                        <div *ngFor="let goal of goalTypes" class="goal">
                            <div class="text">{{ goal.text + ' ' + ls.l('Goal') }}</div>
                            <div class="number">{{ goal.number | number }}</div>
                            <circle-progress [percent]="bankCodeService.getPercent(goal.currentNumber$, goal.number) | async"
                                             [outerStrokeColor]="goal.outerColor"
                                             [innerStrokeColor]="goal.innerColor"
                                             [title]="bankCodeService.getPercentString(goal.currentNumber$, goal.number) | async"
                                             [radius]="42"
                                             [titleFontWeight]="900"
                                             [titleColor]="goal.innerColor"
                                             titleFontSize="23px"
                                             subtitleFontSize="12px"
                                             [subtitleFontWeight]="700"
                                             [subtitleColor]="goal.innerColor"
                                             [subtitle]="goal.currentNumber$ | async | number">
                            </circle-progress>
                        </div>
                    </div>
                </div>
            </mat-tab>
            <mat-tab [label]="ls.l('My Leads').toUpperCase()">
                <div *ngIf="currentTabIndex == 1 || gridInitialized">
                    <div class="grid" [hidden]="totalCount <= 0">
                        <dx-data-grid id="gridContainer"
                                      class="limitedPagerTotal"
                                      accessKey="narrowHeaderPanel"
                                      noDataText=""
                                      [dataSource]="dataSource"
                                      [allowColumnReordering]="true"
                                      [loadPanel]="{ enabled: false }"
                                      [cacheEnabled]="false"
                                      [columnAutoWidth]="true"
                                      [allowColumnResizing]="true"
                                      [hoverStateEnabled]="true"
                                      (onDataErrorOccurred)="httpInterceptor.handleError($event.error)"
                                      (onContentReady)="onContentReady()">
                            <dxo-paging [pageSize]="10"></dxo-paging>
                            <dxo-pager
                                [showPageSizeSelector]="true"
                                [allowedPageSizes]="[10, 20, 50]"
                                [visible]="true"
                                [infoText]="getInfoText()"
                                [showInfo]="true">
                            </dxo-pager>
                            <dxi-column dataField="PhotoPublicId" caption=" " cellTemplate="photoTemplate"
                                        [width]="50" [allowExporting]="false"
                                        [allowGrouping]="false" [allowSorting]="false"></dxi-column>
                            <div *dxTemplate="let data of 'photoTemplate'">
                                <div [ngStyle]="{'background-image': 'url(' + profileService.getContactPhotoUrl(data.data.PhotoPublicId) + ')'}"
                                     class="img-circle">
                                </div>
                            </div>
                            <dxi-column dataField="Id" [visible]="false"></dxi-column>
                            <dxi-column dataField="Name" [caption]="ls.l('Name')" [width]="230"></dxi-column>
                            <dxi-column dataField="BankCode" cellTemplate="bankCodeCell" [caption]="ls.l('BankCode')"
                                        [width]="130"></dxi-column>
                            <dxi-column dataField="BankCodeDate" [caption]="ls.l('Updated')" cellTemplate="dateCell" sortOrder="desc" cssClass="tabular" [width]="110"></dxi-column>
                            <dxi-column dataField="Email" [caption]="ls.l('Email')"></dxi-column>
                            <dxi-column dataField="Phone" [caption]="ls.l('Phone')"
                                        cellTemplate="phoneCell" cssClass="tabular" [width]="160"></dxi-column>
                            <dxi-column dataField="CountryId" [caption]="ls.l('State')"
                                        cellTemplate="location" [width]="150"></dxi-column>
                            <dxi-column dataField="LeadDate" [caption]="ls.l('Created')" [width]="95" cellTemplate="dateCell" cssClass="tabular"></dxi-column>
                            <div *dxTemplate="let cellData of 'phoneCell'">
                                {{cellData.value | phone}}
                            </div>
                            <div *dxTemplate="let cellData of 'dateCell'">
                                {{cellData.value | date: formatting.date : userTimezone}}
                            </div>
                            <div *dxTemplate="let cellData of 'bankCodeCell'">
                                <bank-code-letters [bankCode]="cellData.value"
                                                   [showDescriptionsOnClick]="true"
                                                   [showReportLink]="true">
                                </bank-code-letters>
                            </div>
                            <div *dxTemplate="let data of 'location'">
                                {{data.data.CountryId}} {{data.data.State}}
                            </div>
                            <dxo-sorting mode="multiple"></dxo-sorting>
                        </dx-data-grid>
                    </div>
                    <app-no-data [hidden]="dataIsLoading || totalCount > 0"
                                 title="No contacts added yet"
                                 [showLink]="false">
                    </app-no-data>
                </div>
            </mat-tab>
            <mat-tab *ngIf="showAi$ | async" [label]="ls.l('BankCode_CodebreakerAI')">
                <iframe id="theFrame" src="https://v5.bankcode.pro"
                        frameborder="0" (load)="onIframeLoad($event)">
                </iframe>
            </mat-tab>
        </mat-tab-group>
    </section>
    <ng-template #noSubscription>
        <div *ngIf="environmentLink$ | async as environmentLink" class="iframe">
            <iframe [src]="environmentLink" frameborder="0" (load)="onIframeLoad($event)"></iframe>
        </div>
    </ng-template>
    <loading-spinner *ngIf="dataIsLoading"></loading-spinner>
</div>
